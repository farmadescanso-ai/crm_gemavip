<%- include('partials/header', { title: title || 'Variables del sistema' }) %>

<section class="card">
  <div class="card-hd">
    <h1 class="card-title">Variables del sistema</h1>
    <p class="card-subtitle">
      Configuración centralizada para que no haya que tocar código ni variables de entorno.
    </p>
  </div>
  <div class="card-bd">
    <% if (error) { %>
      <div class="gv-alert error" style="margin: 0 0 12px 0;">
        <strong>No se pudo cargar la configuración</strong>
        <div style="margin-top:6px; white-space:pre-wrap;"><%= error %></div>
      </div>
    <% } %>
    <% if (success) { %>
      <div class="gv-alert success" style="margin: 0 0 12px 0;">
        <strong>Guardado</strong>
        <div style="margin-top:6px; white-space:pre-wrap;"><%= success %></div>
      </div>
    <% } %>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Clave</th>
            <th>Descripción</th>
            <th>Valor</th>
            <th>Valor efectivo</th>
            <th>Actualizado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% (items || []).forEach((v) => { %>
            <tr>
              <td style="font-weight:800;"><%= v.clave %></td>
              <td style="color: var(--gv-muted); font-weight:700;"><%= v.descripcion || '—' %></td>
              <td style="max-width: 460px; word-break: break-word;"><%= (v.valor ?? '').toString() || '—' %></td>
              <td style="max-width: 460px; word-break: break-word; font-weight:800;"><%= (v.effectiveValue ?? '').toString() || '—' %></td>
              <td style="color: var(--gv-muted); font-weight:700;">
                <%= v.updated_at ? String(v.updated_at).replace('T', ' ').slice(0, 19) : '—' %>
                <%= v.updated_by ? ` · ${v.updated_by}` : '' %>
              </td>
              <td>
                <form method="post" action="/admin/variables-sistema/update" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <input type="hidden" name="clave" value="<%= v.clave %>" />
                  <input
                    class="gv-client-picker__q"
                    type="text"
                    name="valor"
                    value="<%= (v.valor ?? '').toString() %>"
                    placeholder="(vacío para borrar)"
                    style="min-width: 320px;"
                    autocomplete="off"
                  />
                  <button class="btn secondary" type="submit">Guardar</button>
                </form>
              </td>
            </tr>
          <% }) %>
          <% if (!items || items.length === 0) { %>
            <tr>
              <td colspan="6" style="color: var(--gv-muted); font-weight:700;">No hay variables.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <div style="margin-top: 12px; color: var(--gv-muted); font-weight:700; line-height:1.45;">
      <div><strong>Notas</strong></div>
      <div>- Si una variable está vacía en BD, el sistema usará el valor de <code>.env</code> si existe.</div>
      <div>- En el webhook de N8N se envía <code>payload</code> (JSON) y <code>excel</code> (archivo .xlsx) en <code>multipart/form-data</code>.</div>
    </div>
  </div>
</section>

<%- include('partials/footer') %>

