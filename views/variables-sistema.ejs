<%- include('partials/header', { title: title || 'Variables del sistema' }) %>

<section class="card">
  <div class="card-hd">
    <h1 class="card-title"><%= title || 'Variables del sistema' %></h1>
    <% if (subtitle) { %>
      <p class="card-subtitle"><%= subtitle %></p>
    <% } else { %>
      <p class="card-subtitle">
        Configuración centralizada para que no haya que tocar código ni variables de entorno.
      </p>
    <% } %>
  </div>
  <div class="card-bd">
    <% if (error) { %>
      <div id="gv-sysvar-notice" class="gv-alert error" style="margin: 0 0 12px 0;" role="alert" aria-live="assertive">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div>
            <strong>No se pudo cargar la configuración</strong>
            <div style="margin-top:6px; white-space:pre-wrap;"><%= error %></div>
          </div>
          <button type="button" class="btn secondary icon warn" id="gv-sysvar-notice-close" title="Cerrar" aria-label="Cerrar mensaje">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M18 6L6 18"></path>
              <path d="M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    <% } %>
    <% if (success) { %>
      <div id="gv-sysvar-notice" class="gv-alert success" style="margin: 0 0 12px 0;" role="status" aria-live="polite">
        <strong>Guardado</strong>
        <div style="margin-top:6px; white-space:pre-wrap;"><%= success %></div>
      </div>
    <% } %>
    <% if (error || success) { %>
      <script>
        (() => {
          const box = document.getElementById('gv-sysvar-notice');
          if (!box) return;
          const isSuccess = <%= success ? 'true' : 'false' %>;
          if (isSuccess) {
            window.setTimeout(() => {
              if (box && box.parentNode) box.parentNode.removeChild(box);
            }, 5000);
            return;
          }
          const btn = document.getElementById('gv-sysvar-notice-close');
          if (btn) {
            btn.addEventListener('click', () => {
              if (box && box.parentNode) box.parentNode.removeChild(box);
            });
          }
        })();
      </script>
    <% } %>

    <% const actionUrl = (typeof updateAction !== 'undefined' && updateAction) ? updateAction : '/admin/variables-sistema/update'; %>
    <% const returnToUrl = (typeof returnTo !== 'undefined' && returnTo) ? returnTo : '/admin/variables-sistema'; %>
    <% const sectionsToRender = (typeof sections !== 'undefined' && Array.isArray(sections)) ? sections : [{ title: null, description: null, items: items || [] }]; %>
    <% const totalItems = sectionsToRender.reduce((acc, s) => acc + (Array.isArray(s?.items) ? s.items.length : 0), 0); %>

    <div style="display:flex; flex-direction:column; gap:12px;">
      <% sectionsToRender.forEach((sec) => { %>
        <% const secTitle = sec && sec.title ? String(sec.title) : ''; %>
        <% const secDesc = sec && sec.description ? String(sec.description) : ''; %>
        <% const secItems = sec && Array.isArray(sec.items) ? sec.items : []; %>

        <% if (secTitle) { %>
          <div style="margin-top: 6px;">
            <div style="font-weight: 900; color: var(--gv-ink); font-size: 13px; letter-spacing:.2px;"><%= secTitle %></div>
            <% if (secDesc) { %><div style="margin-top:4px; color: var(--gv-muted); font-weight:700;"><%= secDesc %></div><% } %>
          </div>
        <% } %>

        <% secItems.forEach((v) => { %>
        <% const key = String(v.clave || '').trim(); %>
        <% const idBase = `sysvar_${key.replace(/[^a-zA-Z0-9_-]/g, '_')}`; %>
        <% const dbVal = String(v.valor ?? '').trim(); %>
        <% const effectiveVal = String(v.effectiveValue ?? '').trim(); %>
        <% const source = dbVal ? 'BD' : (effectiveVal ? '.env' : '—'); %>

        <section class="card" style="margin:0;">
          <div class="card-hd" style="padding-bottom: 10px;">
            <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
              <div style="min-width: 260px;">
                <div style="font-weight:900; color: var(--gv-ink); font-size: 14px; letter-spacing: .2px;">
                  <%= key %>
                </div>
                <div style="margin-top:6px; color: var(--gv-muted); font-weight:700; line-height:1.35;">
                  <%= v.descripcion || '—' %>
                </div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <span class="badge info" title="Origen del valor efectivo" aria-label="Origen del valor efectivo: <%= source %>">
                  Origen: <%= source %>
                </span>
                <% if (v.updated_at || v.updated_by) { %>
                  <span class="badge info" title="Última actualización" aria-label="Última actualización">
                    <%= v.updated_at ? String(v.updated_at).replace('T', ' ').slice(0, 19) : '—' %><%= v.updated_by ? ` · ${v.updated_by}` : '' %>
                  </span>
                <% } %>
              </div>
            </div>
          </div>
          <div class="card-bd">
            <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
              <div>
                <label for="<%= idBase %>_valor" style="display:block; font-weight:900; color: var(--gv-ink); margin-bottom:6px;">
                  Valor (editable)
                </label>
                <div id="<%= idBase %>_help" style="color: var(--gv-muted); font-weight:700; margin-bottom:8px; line-height:1.35;">
                  Deja el campo vacío para “borrar” el valor en BD y usar el fallback de <code>.env</code> si existe.
                </div>
                <form method="post" action="<%= actionUrl %>" style="display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap;">
                  <input type="hidden" name="clave" value="<%= key %>" />
                  <input type="hidden" name="returnTo" value="<%= returnToUrl %>" />
                  <% const isSecret = Boolean(v.secret); %>
                  <% const wantsTextarea = Boolean(v.multiline); %>
                  <% if (isSecret) { %>
                    <input type="hidden" name="keepIfEmpty" value="1" />
                    <div style="display:flex; flex-direction:column; gap:8px; width: 100%;">
                      <input
                        id="<%= idBase %>_valor"
                        name="valor"
                        type="password"
                        class="gv-client-picker__q"
                        style="min-width: min(720px, 100%); width: 100%; max-width: 100%; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"
                        placeholder="•••••• (dejar vacío = sin cambios)"
                        aria-describedby="<%= idBase %>_help"
                        autocomplete="new-password"
                      />
                      <label style="display:flex; align-items:center; gap:8px; color: var(--gv-muted); font-weight:800;">
                        <input type="checkbox" name="clear" value="1" />
                        Borrar valor guardado en BD (volver a usar .env)
                      </label>
                    </div>
                  <% } else if (wantsTextarea) { %>
                    <textarea
                      id="<%= idBase %>_valor"
                      name="valor"
                      class="gv-client-picker__q"
                      rows="2"
                      style="min-width: min(720px, 100%); width: 100%; max-width: 100%; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"
                      placeholder="<%= v.placeholder ? String(v.placeholder) : '(vacío para borrar)' %>"
                      aria-describedby="<%= idBase %>_help"
                      autocomplete="off"
                      spellcheck="false"
                    ><%= String(v.valor ?? '') %></textarea>
                  <% } else { %>
                    <input
                      id="<%= idBase %>_valor"
                      name="valor"
                      type="<%= v.inputType ? String(v.inputType) : 'text' %>"
                      class="gv-client-picker__q"
                      value="<%= String(v.valor ?? '') %>"
                      placeholder="<%= v.placeholder ? String(v.placeholder) : '(vacío para borrar)' %>"
                      aria-describedby="<%= idBase %>_help"
                      autocomplete="off"
                    />
                  <% } %>
                  <button class="btn secondary" type="submit">Guardar</button>
                </form>
              </div>

              <div>
                <div style="font-weight:900; color: var(--gv-ink); margin-bottom:6px;">Valor efectivo (lo que usa la app)</div>
                <div style="padding:10px 12px; border: 1px solid rgba(148,163,184,.35); border-radius: 10px; background: rgba(248,250,252,.6);">
                  <% if (effectiveVal) { %>
                    <div style="word-break: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">
                      <%= effectiveVal %>
                    </div>
                  <% } else { %>
                    <div style="color: var(--gv-muted); font-weight:800;">—</div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </section>
        <% }) %>

        <% if (!secItems || secItems.length === 0) { %>
          <div class="gv-alert info">
            <strong>No hay variables</strong>
            <div style="margin-top:6px;">No hay variables definidas en esta sección.</div>
          </div>
        <% } %>
      <% }) %>
    </div>
    <% if (!totalItems) { %>
      <div class="gv-alert info" style="margin-top: 12px;">
        <strong>No hay variables</strong>
        <div style="margin-top:6px;">Aún no se han definido variables para este apartado.</div>
      </div>
    <% } %>

    <div style="margin-top: 12px; color: var(--gv-muted); font-weight:700; line-height:1.45;">
      <div><strong>Notas</strong></div>
      <div>- Si una variable está vacía en BD, el sistema usará el valor de <code>.env</code> si existe.</div>
      <% if (typeof notes !== 'undefined' && Array.isArray(notes) && notes.length) { %>
        <% notes.forEach((n) => { %>
          <div>- <%= n %></div>
        <% }) %>
      <% } else { %>
        <div>- Los cambios se aplican al instante al guardar.</div>
      <% } %>
    </div>
  </div>
</section>

<%- include('partials/footer') %>

