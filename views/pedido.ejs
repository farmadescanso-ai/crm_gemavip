<%- include('partials/header', { title: 'Pedido' }) %>

<%
  const toNum = (v, dflt = 0) => {
    if (v === null || v === undefined) return dflt;
    const s = String(v).trim();
    if (!s) return dflt;
    const n = Number(String(s).replace(',', '.'));
    return Number.isFinite(n) ? n : dflt;
  };
  const round2 = (n) => Math.round((Number(n) + Number.EPSILON) * 100) / 100;
  const fmtNum = (n) => {
    const x = Number(n);
    if (!Number.isFinite(x)) return '';
    return x.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };
  const fmtEur = (n) => {
    const x = Number(n);
    if (!Number.isFinite(x)) return '';
    return x.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });
  };
  const pedidoId = item?.id ?? item?.Id ?? '';
  const numPedido = item?.NumPedido ?? '';
  const fecha = fmtDateES(item.FechaPedido ?? item.Fecha ?? '');
  const entrega = item?.FechaEntrega ? fmtDateES(item.FechaEntrega) : '';
  const clienteNombre = (cliente && (cliente.Nombre_Razon_Social || cliente.Nombre)) ? (cliente.Nombre_Razon_Social || cliente.Nombre) : '';
  const clienteCif = (cliente && (cliente.DNI_CIF || cliente.DniCif)) ? (cliente.DNI_CIF || cliente.DniCif) : '';
  const clienteDir = cliente?.Direccion || '';
  const clientePob = cliente?.Poblacion || '';
  const clienteCp = cliente?.CodigoPostal || '';
  const clienteEmail = cliente?.Email || '';
  const clienteTel = cliente?.Telefono || cliente?.Movil || '';
%>

<div class="gv-doc-page">
  <div class="gv-doc-top gv-no-print">
    <a class="btn secondary" href="/pedidos">Volver</a>
    <% if (admin) { %>
      <a class="btn secondary" href="/pedidos/<%= pedidoId %>/edit">Editar</a>
      <form method="post" action="/pedidos/<%= pedidoId %>/delete" style="display:inline;" onsubmit="return confirm('¿Eliminar este pedido?');">
        <button class="btn secondary" style="border-color: rgba(255,186,0,.6);" type="submit">Borrar</button>
      </form>
    <% } %>
    <button class="btn secondary" type="button" onclick="window.print()">Imprimir</button>
  </div>

  <div class="gv-doc-head">
    <div class="gv-doc-company">
      GEMAVIP ESPAÑA SL.
      <small>B19427004</small>
      <small>CALLE DE LA SEÑA 2</small>
      <small>CARTAGENA (30201), Murcia, España</small>
      <small>pedidosespana@gemavip.com · +34 686 48 36 84</small>
    </div>
    <div class="gv-doc-meta">
      <div class="gv-doc-title">PEDIDO #<%= numPedido || pedidoId %></div>
      <div class="gv-doc-kv">
        <div><span>Fecha</span><b><%= fecha %></b></div>
        <% if (entrega) { %>
          <div><span>Entrega</span><b><%= entrega %></b></div>
        <% } %>
        <% if (item.NumPedidoCliente || item.Num_Pedido_Cliente) { %>
          <div><span>Nº Pedido Cliente</span><b><%= item.NumPedidoCliente ?? item.Num_Pedido_Cliente %></b></div>
        <% } %>
        <div><span>Tarifa</span><b><%= item.Id_Tarifa ?? 0 %></b></div>
      </div>
    </div>
  </div>

  <div class="gv-doc-parties">
    <div class="gv-doc-box">
      <h3>Cliente</h3>
      <div class="gv-doc-lines">
        <div><%= clienteNombre || (item.Id_Cliente ?? '') %></div>
        <% if (clienteCif) { %><small><%= clienteCif %></small><% } %>
        <% if (clienteDir) { %><small><%= clienteDir %></small><% } %>
        <% if (clienteCp || clientePob) { %><small><%= [clienteCp, clientePob].filter(Boolean).join(' ') %></small><% } %>
        <% if (clienteEmail || clienteTel) { %><small><%= [clienteEmail, clienteTel].filter(Boolean).join(' · ') %></small><% } %>
      </div>
    </div>

    <div class="gv-doc-box">
      <h3>Dirección de envío</h3>
      <div class="gv-doc-lines">
        <div><%= clienteNombre || '—' %></div>
        <small>(si necesitas direcciones múltiples, lo conectamos a `Id_DireccionEnvio`)</small>
      </div>
    </div>
  </div>

  <div class="gv-doc-table-wrap">
    <table class="gv-doc-table">
      <thead>
        <tr>
          <th>CÓDIGO</th>
          <th>CONCEPTO</th>
          <th class="is-right">PVL</th>
          <th class="is-right">UNIDADES</th>
          <th class="is-right">SUBTOTAL</th>
          <th class="is-right">IVA</th>
          <th class="is-right">TOTAL</th>
        </tr>
      </thead>
      <tbody>
        <% let sumBase = 0, sumIva = 0, sumTotal = 0; %>
        <% (lineas || []).forEach((l) => { %>
          <%
            const codigo = (l.SKU ?? l.Codigo ?? l.Id_Articulo ?? l.id_articulo ?? '').toString();
            const concepto = (l.Nombre ?? l.Descripcion ?? l.Articulo ?? l.nombre ?? '').toString();
            const qty = Math.max(0, toNum(l.Cantidad ?? l.Unidades ?? 0, 0));
            const pvl = Math.max(0, toNum(l.PrecioUnitario ?? l.PVL ?? l.Precio ?? l.pvl ?? 0, 0));
            const dto = Math.max(0, Math.min(100, toNum(l.Dto ?? 0, 0)));

            const baseStored = toNum(l.Base ?? l.BaseImponible ?? l.Subtotal ?? l.Importe ?? NaN, NaN);
            const baseCalc = round2(qty * pvl * (1 - dto / 100));
            const base = Number.isFinite(baseStored) ? round2(baseStored) : baseCalc;

            const ivaImpStored = toNum(l.ImporteIVA ?? l.TotalIVA ?? l.importe_iva ?? NaN, NaN);
            let ivaPct = toNum(l.PorcIVA ?? l.PorcentajeIVA ?? l.TipoIVA ?? l.IVA ?? 0, 0);
            if (ivaPct > 100) ivaPct = 0;
            const ivaImpCalc = round2(base * ivaPct / 100);
            const ivaImp = Number.isFinite(ivaImpStored) ? round2(ivaImpStored) : ivaImpCalc;

            const totalStored = toNum(l.Total ?? l.TotalLinea ?? l.ImporteTotal ?? l.total_linea ?? NaN, NaN);
            const totalCalc = round2(base + ivaImp);
            const total = Number.isFinite(totalStored) ? round2(totalStored) : totalCalc;

            sumBase += base;
            sumIva += ivaImp;
            sumTotal += total;
          %>
          <tr>
            <td><%= codigo %></td>
            <td class="is-wrap"><%= concepto || (codigo ? `Artículo ${codigo}` : '—') %></td>
            <td class="is-right"><%= fmtEur(pvl) %></td>
            <td class="is-right"><%= qty ? fmtNum(qty) : '' %></td>
            <td class="is-right"><%= fmtEur(base) %></td>
            <td class="is-right"><%= ivaPct ? `${fmtNum(ivaPct)}%` : '—' %></td>
            <td class="is-right"><%= fmtEur(total) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <div class="gv-doc-summary">
    <table>
      <tr>
        <td>BASE IMPONIBLE</td>
        <td><%= fmtEur(round2(sumBase)) %></td>
      </tr>
      <tr>
        <td>IMPUESTO</td>
        <td><%= fmtEur(round2(sumIva)) %></td>
      </tr>
      <tr>
        <td class="gv-doc-grand">TOTAL</td>
        <td class="gv-doc-grand"><%= fmtEur(round2(sumTotal)) %></td>
      </tr>
    </table>
  </div>
</div>

<%- include('partials/footer') %>

