<%- include('partials/header', { title: 'Pedido' }) %>

<%
  const toNum = (v, dflt = 0) => {
    if (v === null || v === undefined) return dflt;
    const s = String(v).trim();
    if (!s) return dflt;
    const n = Number(String(s).replace(',', '.'));
    return Number.isFinite(n) ? n : dflt;
  };
  const round2 = (n) => Math.round((Number(n) + Number.EPSILON) * 100) / 100;
  // Formato fijo ES: miles con "." y decimales con ","
  const fmtNumES = (value, decimals = 2) => {
    const x = Number(value);
    if (!Number.isFinite(x)) return '';
    const d = Math.max(0, Math.min(6, Number(decimals) || 0));
    const sign = x < 0 ? '-' : '';
    const abs = Math.abs(x);
    const factor = Math.pow(10, d);
    const rounded = Math.round((abs + Number.EPSILON) * factor) / factor;
    const parts = rounded.toFixed(d).split('.');
    const intPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    const decPart = d ? (',' + (parts[1] || '').padEnd(d, '0')) : '';
    return sign + intPart + decPart;
  };
  const fmtEur = (n) => {
    const x = Number(n);
    if (!Number.isFinite(x)) return '';
    return `${fmtNumES(x, 2)}€`;
  };
  const fmtQty = (n) => fmtNumES(n, 0);
  const pedidoId = item?.id ?? item?.Id ?? '';
  const numPedido = item?.NumPedido ?? '';
  const fecha = fmtDateES(item.FechaPedido ?? item.Fecha ?? '');
  const entrega = item?.FechaEntrega ? fmtDateES(item.FechaEntrega) : '';
  const clienteNombre = (cliente && (cliente.Nombre_Razon_Social || cliente.Nombre)) ? (cliente.Nombre_Razon_Social || cliente.Nombre) : '';
  const clienteCif = (cliente && (cliente.DNI_CIF || cliente.DniCif)) ? (cliente.DNI_CIF || cliente.DniCif) : '';
  const clienteDir = cliente?.Direccion || '';
  const clientePob = cliente?.Poblacion || '';
  const clienteCp = cliente?.CodigoPostal || '';
  const clienteEmail = cliente?.Email || '';
  const clienteTel = cliente?.Telefono || cliente?.Movil || '';
  const dir = direccionEnvio || null;
  const dtoPedidoPct = Math.max(0, Math.min(100, toNum(item.Dto ?? item.Descuento ?? 0, 0)));
%>

<div class="gv-doc-page">
  <div class="gv-doc-top gv-no-print">
    <a class="btn secondary" href="/pedidos">Volver</a>
    <% if (admin) { %>
      <a class="btn secondary" href="/pedidos/<%= pedidoId %>/edit">Editar</a>
      <form method="post" action="/pedidos/<%= pedidoId %>/delete" style="display:inline;" onsubmit="return confirm('¿Eliminar este pedido?');">
        <button class="btn secondary" style="border-color: rgba(255,186,0,.6);" type="submit">Borrar</button>
      </form>
    <% } %>
    <a class="btn secondary" href="/pedidos/<%= pedidoId %>.xlsx">Excel</a>
    <% if (canShowHefame) { %>
    <span class="gv-hefame-wrap">
      <a class="btn secondary" href="/pedidos/<%= pedidoId %>/hefame.xlsx">HEFAME</a>
      <button type="button" class="gv-hefame-info-btn" onclick="document.getElementById('modal-hefame').showModal()" title="Información Hefame" aria-label="Información Hefame">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
      </button>
    </span>
    <% } %>
    <button class="btn secondary" type="button" onclick="window.print()">Imprimir</button>
  </div>

  <% if (canShowHefame) { %>
  <dialog id="modal-hefame" class="gv-modal-hefame" aria-labelledby="modal-hefame-title" onclick="if (event.target === this) this.close()">
    <div class="gv-modal-hefame-inner">
      <h2 id="modal-hefame-title" class="gv-modal-hefame-title">Export Hefame</h2>
      <p class="gv-modal-hefame-text">El envío por email está temporalmente deshabilitado.</p>
      <p class="gv-modal-hefame-text">Puede descargar la plantilla Excel con los datos del pedido para Hefame usando el enlace siguiente.</p>
      <p class="gv-modal-hefame-actions">
        <a class="btn" href="/pedidos/<%= pedidoId %>/hefame.xlsx">Descargar plantilla Excel Hefame</a>
      </p>
      <button type="button" class="gv-modal-hefame-close" onclick="document.getElementById('modal-hefame').close()" aria-label="Cerrar">Cerrar</button>
    </div>
  </dialog>
  <% } %>
  <style>
    .gv-hefame-wrap { display: inline-flex; align-items: center; gap: 4px; }
    .gv-hefame-info-btn { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; padding: 0; border: 1px solid rgba(0,0,0,.15); border-radius: 6px; background: var(--gv-bg, #f8f9fa); color: var(--gv-muted, #6c757d); cursor: pointer; }
    .gv-hefame-info-btn:hover { background: var(--gv-bg-hover, #e9ecef); color: var(--gv-fg, #212529); }
    .gv-modal-hefame { border: none; border-radius: 8px; padding: 0; max-width: 90vw; width: 420px; box-shadow: 0 4px 20px rgba(0,0,0,.2); }
    .gv-modal-hefame::backdrop { background: rgba(0,0,0,.4); }
    .gv-modal-hefame-inner { padding: 20px 24px; }
    .gv-modal-hefame-title { margin: 0 0 12px; font-size: 1.15rem; color: var(--gv-fg, #212529); }
    .gv-modal-hefame-text { margin: 0 0 8px; font-size: 0.95rem; line-height: 1.45; color: var(--gv-muted, #495057); }
    .gv-modal-hefame-actions { margin: 16px 0 12px; }
    .gv-modal-hefame-close { display: block; margin-top: 8px; padding: 6px 12px; font-size: 0.9rem; background: transparent; border: 1px solid rgba(0,0,0,.2); border-radius: 6px; cursor: pointer; color: var(--gv-fg, #212529); }
    .gv-modal-hefame-close:hover { background: rgba(0,0,0,.06); }
  </style>

  <div class="gv-doc-head gv-print-header">
    <div class="gv-doc-company">
      GEMAVIP ESPAÑA SL.
      <small>B19427004</small>
      <small>CALLE DE LA SEÑA 2</small>
      <small>CARTAGENA (30201), Murcia, España</small>
      <small>pedidosespana@gemavip.com · +34 686 48 36 84</small>
    </div>
    <div class="gv-doc-meta">
      <div class="gv-doc-title">PEDIDO #<%= numPedido || pedidoId %></div>
      <div class="gv-doc-kv">
        <div><span>Fecha</span><b><%= fecha %></b></div>
        <% if (entrega) { %>
          <div><span>Entrega</span><b><%= entrega %></b></div>
        <% } %>
        <% if (item.NumPedidoCliente || item.Num_Pedido_Cliente) { %>
          <div><span>Nº Pedido Cliente</span><b><%= item.NumPedidoCliente ?? item.Num_Pedido_Cliente %></b></div>
        <% } %>
        <% if (item.NumAsociadoHefame || item.num_asociado_hefame) { %>
          <div><span>Nº asociado (Hefame)</span><b><%= item.NumAsociadoHefame ?? item.num_asociado_hefame %></b></div>
        <% } %>
      </div>
    </div>
  </div>

  <div class="gv-print-body">
  <div class="gv-doc-parties">
    <div class="gv-doc-box">
      <h3>Cliente</h3>
      <div class="gv-doc-lines">
        <div><%= clienteNombre || (item.Id_Cliente ?? '') %></div>
        <% if (clienteCif) { %><small><%= clienteCif %></small><% } %>
        <% if (clienteDir) { %><small><%= clienteDir %></small><% } %>
        <% if (clienteCp || clientePob) { %><small><%= [clienteCp, clientePob].filter(Boolean).join(' ') %></small><% } %>
        <% if (clienteEmail || clienteTel) { %><small><%= [clienteEmail, clienteTel].filter(Boolean).join(' · ') %></small><% } %>
      </div>
    </div>

    <div class="gv-doc-box">
      <h3>Dirección de envío</h3>
      <div class="gv-doc-lines">
        <% if (dir) { %>
          <div><%= dir.Alias || dir.Nombre_Destinatario || clienteNombre || '—' %></div>
          <% if (dir.Nombre_Destinatario && dir.Alias) { %><small><%= dir.Nombre_Destinatario %></small><% } %>
          <% if (dir.Direccion) { %><small><%= dir.Direccion %></small><% } %>
          <% if (dir.Direccion2) { %><small><%= dir.Direccion2 %></small><% } %>
          <% if (dir.CodigoPostal || dir.Poblacion) { %><small><%= [dir.CodigoPostal, dir.Poblacion].filter(Boolean).join(' ') %></small><% } %>
          <% if (dir.Pais) { %><small><%= dir.Pais %></small><% } %>
          <% if (dir.Email || dir.Telefono || dir.Movil) { %><small><%= [dir.Email, dir.Telefono, dir.Movil].filter(Boolean).join(' · ') %></small><% } %>
          <% if (dir.Observaciones) { %><small><%= dir.Observaciones %></small><% } %>
        <% } else { %>
          <div><%= clienteNombre || '—' %></div>
          <small>(Sin dirección de envío: asigna `Id_DireccionEnvio` en el pedido)</small>
        <% } %>
      </div>
    </div>
  </div>

  <div class="gv-doc-table-wrap">
    <table class="gv-doc-table">
      <colgroup>
        <col style="width:12%">
        <col style="width:38%">
        <col style="width:10%">
        <col style="width:8%">
        <col style="width:7%">
        <col style="width:10%">
        <col style="width:5%">
        <col style="width:10%">
      </colgroup>
      <thead>
        <tr>
          <th>CÓDIGO</th>
          <th>CONCEPTO</th>
          <th class="is-right">PVL</th>
          <th class="is-right">UNDS</th>
          <th class="is-right">DTO</th>
          <th class="is-right">SUBTOTAL</th>
          <th class="is-right">IVA</th>
          <th class="is-right">TOTAL</th>
        </tr>
      </thead>
      <tbody>
        <% let sumBase = 0, sumIva = 0, sumTotal = 0; const ivaByPct = {}; %>
        <% (lineas || []).forEach((l) => { %>
          <%
            const codigo = (l.SKU ?? l.Codigo ?? l.Id_Articulo ?? l.id_articulo ?? '').toString();
            const concepto = (l.Nombre ?? l.Descripcion ?? l.Articulo ?? l.nombre ?? '').toString();
            const qty = Math.max(0, toNum(l.Cantidad ?? l.Unidades ?? 0, 0));
            const pvl = Math.max(
              0,
              toNum(l.Linea_PVP ?? l.PVP ?? l.pvp ?? l.PrecioUnitario ?? l.PVL ?? l.Precio ?? l.pvl ?? 0, 0)
            );
            const dto = Math.max(
              0,
              Math.min(
                100,
                toNum(l.Linea_Dto ?? l.DtoLinea ?? l.dto_linea ?? l.Dto ?? l.dto ?? l.Descuento ?? l.descuento ?? 0, 0)
              )
            );

            const baseStored = toNum(l.Base ?? l.BaseImponible ?? l.Subtotal ?? l.Importe ?? NaN, NaN);
            const baseCalc = round2(qty * pvl * (1 - dto / 100) * (1 - dtoPedidoPct / 100));
            const base = Number.isFinite(baseStored) ? round2(baseStored) : baseCalc;

            const ivaImpStored = toNum(l.ImporteIVA ?? l.TotalIVA ?? l.importe_iva ?? NaN, NaN);
            let ivaPct = toNum(l.Linea_IVA ?? l.IVA ?? l.PorcIVA ?? l.PorcentajeIVA ?? l.TipoIVA ?? 0, 0);
            if (ivaPct > 100) ivaPct = 0;
            const ivaImpCalc = round2(base * ivaPct / 100);
            const ivaImp = Number.isFinite(ivaImpStored) ? round2(ivaImpStored) : ivaImpCalc;

            const totalStored = toNum(l.Total ?? l.TotalLinea ?? l.ImporteTotal ?? l.total_linea ?? NaN, NaN);
            const totalCalc = round2(base + ivaImp);
            const total = Number.isFinite(totalStored) ? round2(totalStored) : totalCalc;

            sumBase += base;
            sumIva += ivaImp;
            sumTotal += total;
            if (ivaPct > 0) {
              const pctKey = String(round2(ivaPct));
              if (!ivaByPct[pctKey]) ivaByPct[pctKey] = { pct: ivaPct, sum: 0 };
              ivaByPct[pctKey].sum += ivaImp;
            }
          %>
          <tr>
            <td><%= codigo %></td>
            <td class="is-wrap">
              <div class="gv-doc-concept"><%= concepto || (codigo ? `Artículo ${codigo}` : '—') %></div>
            </td>
            <td class="is-right"><%= fmtEur(pvl) %></td>
            <td class="is-right"><%= qty ? fmtQty(qty) : '' %></td>
            <td class="is-right"><%= dto ? `${fmtNumES(dto, 2)}%` : '—' %></td>
            <td class="is-right"><%= fmtEur(base) %></td>
            <td class="is-right"><%= ivaPct ? `${fmtNumES(ivaPct, 2)}%` : '—' %></td>
            <td class="is-right"><%= fmtEur(total) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <div class="gv-doc-summary">
    <table>
      <% if (dtoPedidoPct) { %>
        <tr>
          <td>DTO PEDIDO</td>
          <td class="is-right"><%= `${fmtNumES(dtoPedidoPct, 2)}%` %></td>
        </tr>
      <% } %>
      <tr>
        <td>BASE IMPONIBLE</td>
        <td class="is-right"><%= fmtEur(round2(sumBase)) %></td>
      </tr>
      <% Object.keys(ivaByPct || {}).sort((a, b) => Number(a) - Number(b)).forEach((key) => { %>
        <% const iva = ivaByPct[key]; if (iva && iva.sum) { %>
          <tr>
            <td>IMPUESTO (<%= fmtNumES(iva.pct, 2) %>%)</td>
            <td class="is-right"><%= fmtEur(round2(iva.sum)) %></td>
          </tr>
        <% } %>
      <% }) %>
      <%
        const retencionPct = cliente && (Number(cliente.IRPF ?? cliente.Retencion ?? cliente.retencion ?? '') || 0);
        const importeRetencion = toNum(item.ImporteRetencion ?? item.importe_retencion ?? NaN, NaN);
        const retenciones = [];
        if (retencionPct > 0) {
          const imp = Number.isFinite(importeRetencion) ? round2(importeRetencion) : round2(sumBase * retencionPct / 100);
          retenciones.push({ pct: retencionPct, importe: imp });
        }
        if (cliente && Array.isArray(cliente.Retenciones) && cliente.Retenciones.length) {
          cliente.Retenciones.forEach((r) => {
            const p = toNum(r.porcentaje ?? r.Porcentaje ?? r.pct ?? 0, 0);
            if (p > 0) retenciones.push({ pct: p, importe: round2((r.importe != null ? toNum(r.importe, NaN) : sumBase * p / 100)) });
          });
        }
      %>
      <% retenciones.forEach((r) => { %>
        <tr>
          <td>RETENCIÓN (<%= fmtNumES(r.pct, 2) %>%)</td>
          <td class="is-right">−<%= fmtEur(r.importe) %></td>
        </tr>
      <% }) %>
      <tr>
        <td class="gv-doc-grand">TOTAL</td>
        <td class="gv-doc-grand is-right"><%= fmtEur(round2(round2(sumTotal) - retenciones.reduce((s, r) => s + r.importe, 0))) %></td>
      </tr>
    </table>
  </div>
  </div>
</div>

<%- include('partials/footer') %>

