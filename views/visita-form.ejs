<%- include('partials/header', { title: mode === 'edit' ? 'Editar visita' : 'Nueva visita' }) %>

<section class="card" style="max-width: 860px; margin: 0 auto;">
  <div class="card-hd">
    <h1 class="card-title"><%= mode === 'edit' ? 'Editar visita' : 'Nueva visita' %></h1>
    <p class="card-subtitle">Completa la información de la visita.</p>
  </div>
  <div class="card-bd">
    <% if (error) { %>
      <div class="badge warn" style="display:block; border-radius: 14px;"><%= error %></div>
      <div style="height: 10px;"></div>
    <% } %>

    <form method="post" action="<%= mode === 'edit' ? ('/visitas/' + (item.Id || item.id) + '/edit') : '/visitas/new' %>" style="display:grid; gap: 12px;">
      <div class="grid cols-2" style="gap: 12px;">
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Fecha</span>
          <input name="Fecha" type="date" required value="<%= (item.Fecha || item[meta.colFecha] || '').toString().slice(0,10) %>" />
        </label>
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Hora</span>
          <input name="Hora" type="time" value="<%= (item.Hora || item[meta.colHora] || '').toString().slice(0,5) %>" />
        </label>
      </div>

      <div class="grid cols-2" style="gap: 12px;">
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Tipo de visita</span>
          <% if ((tiposVisita || []).length > 0) { %>
            <select name="TipoVisita" required>
              <option value="">(selecciona)</option>
              <% (tiposVisita || []).forEach((t) => { %>
                <% const val = (tipoIsId ? t.id : t.nombre); %>
                <% const cur = (item.TipoVisita || item[meta.colTipo] || ''); %>
                <option value="<%= val %>" <%= String(cur) === String(val) ? 'selected' : '' %>><%= t.nombre %></option>
              <% }) %>
            </select>
          <% } else { %>
            <input name="TipoVisita" required placeholder="Ej. Presencial / Teléfono / Online" value="<%= (item.TipoVisita || item[meta.colTipo] || '') %>" />
          <% } %>
        </label>
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Estado</span>
          <% const curEstado = (item.Estado || item[meta.colEstado] || ''); %>
          <% if ((estadosVisita || []).length > 0) { %>
            <select name="Estado" required>
              <option value="">(selecciona)</option>
              <% (estadosVisita || []).forEach((e) => { %>
                <% const val = (e && (e.nombre || e.Nombre || e.estado || e.Estado)) ? (e.nombre || e.Nombre || e.estado || e.Estado) : ''; %>
                <% if (!val) return; %>
                <option value="<%= val %>" <%= String(curEstado) === String(val) ? 'selected' : '' %>><%= val %></option>
              <% }) %>
              <% if (curEstado && !(estadosVisita || []).some((x) => String((x?.nombre || x?.Nombre || x?.estado || x?.Estado) || '') === String(curEstado))) { %>
                <option value="<%= curEstado %>" selected>(actual) <%= curEstado %></option>
              <% } %>
            </select>
          <% } else { %>
            <input name="Estado" required placeholder="Ej. Planificada / Realizada / Cancelada" value="<%= curEstado %>" />
          <% } %>
        </label>
      </div>

      <label style="display:grid; gap: 6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Cliente</span>
        <div class="gv-client-picker" data-client-picker>
          <input
            type="search"
            class="gv-client-picker__q"
            placeholder="Buscar cliente (nombre, CIF, email, teléfono, CP o ID...)"
            autocomplete="off"
          />
          <div class="gv-client-picker__results" hidden></div>
          <input name="ClienteId" type="hidden" class="gv-client-picker__id" value="<%= item.ClienteId || item[meta.colCliente] || '' %>" />
          <div style="font-size: 12px; color: var(--gv-muted);">
            Consejo: escribe al menos 3 letras (o un ID numérico) y selecciona un resultado.
          </div>
          <div class="gv-client-picker__recent" style="display:none;">
            <div style="font-size: 12px; color: var(--gv-muted); font-weight: 700; margin-top: 6px;">
              Recientes:
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top: 6px;">
              <% (clientes || []).slice(0, 10).forEach((c) => { %>
                <button class="btn secondary" type="button" data-client-pick="<%= c.Id %>" data-client-label="<%= c.Nombre_Razon_Social %>" style="padding: 6px 10px; border-radius: 999px;">
                  <%= c.Id %> · <%= c.Nombre_Razon_Social %>
                </button>
              <% }) %>
            </div>
          </div>
        </div>
      </label>

      <% if (admin) { %>
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Comercial</span>
          <select name="ComercialId">
            <option value="">(sin asignar)</option>
            <% (comerciales || []).forEach((c) => { %>
              <% const cid = (c.id ?? c.Id); %>
              <option value="<%= cid %>" <%= (item.ComercialId || item[meta.colComercial]) == cid ? 'selected' : '' %>>
                <%= c.Nombre %> (<%= c.Email || c.email || '' %>)
              </option>
            <% }) %>
          </select>
        </label>
      <% } else { %>
        <div style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Comercial</span>
          <div class="badge info" style="border-radius: 14px;">
            <%= (user && (user.nombre || user.email)) ? (user.nombre || user.email) : '—' %>
          </div>
        </div>
      <% } %>

      <label style="display:grid; gap: 6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Notas</span>
        <textarea name="Notas" rows="4" placeholder="Resumen de la visita..."><%= (item.Notas || item[meta.colNotas] || '') %></textarea>
      </label>

      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <a class="btn secondary" href="/visitas">Cancelar</a>
        <button class="btn" type="submit"><%= mode === 'edit' ? 'Guardar cambios' : 'Crear visita' %></button>
      </div>
    </form>
  </div>
</section>

<%- include('partials/footer') %>

