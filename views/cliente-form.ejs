<%- include('partials/header', { title: mode === 'edit' ? 'Editar contacto' : 'Nuevo contacto' }) %>

<% const missingFieldsList = (typeof missingFields !== 'undefined' && Array.isArray(missingFields)) ? missingFields : []; %>
<% const formAction = mode === 'edit' ? ('/clientes/' + (item.Id || item.id) + '/edit') : '/clientes/new'; %>
<% const cancelHref = mode === 'edit' ? ('/clientes/' + (item.Id || item.id)) : '/clientes'; %>

<section class="card gv-cliente-form" style="max-width: 1080px; margin: 0 auto;">
  <div class="card-hd">
    <h1 class="card-title"><%= mode === 'edit' ? 'Editar contacto' : 'Nuevo contacto' %></h1>
    <p class="card-subtitle">Revisa y completa la ficha del cliente. Puedes moverte por pestañas sin perder cambios.</p>
  </div>
  <div class="card-bd">
    <% if (error) { %>
      <div class="gv-alert gv-alert--warn" style="margin-bottom:12px;"><%= error %></div>
    <% } %>

    <form id="gvClienteForm" method="post" action="<%= formAction %>" class="gv-form" style="display:grid; gap: 12px;">
      <% if (mode === 'create') { %>
        <input type="hidden" name="dup_confirmed" id="gvDupConfirmed" value="0" />
      <% } %>
      <div class="gv-form-actions-sticky">
        <div class="gv-form-actions-sticky__inner">
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <a class="btn secondary" href="<%= cancelHref %>" id="gvCancelBtn">Cancelar</a>
            <button class="btn" type="submit" id="gvSaveBtn"><%= mode === 'edit' ? 'Guardar' : 'Crear' %></button>
          </div>
          <div id="gvDirtyHint" class="gv-dirty-hint" style="display:none;">Tienes cambios sin guardar.</div>
        </div>
      </div>

      <div class="gv-tabs" role="tablist" aria-label="Secciones del contacto">
        <% (tabs || []).forEach((t, idx) => { %>
          <button
            type="button"
            class="gv-tab <%= idx === 0 ? 'is-active' : '' %>"
            role="tab"
            aria-selected="<%= idx === 0 ? 'true' : 'false' %>"
            aria-controls="tab_<%= t.id %>"
            data-tab="<%= t.id %>"
          ><%= t.label %></button>
        <% }) %>
      </div>

      <% const pickVal = (name) => { const v = (item && item[name] !== undefined) ? item[name] : ''; return (v === null || v === undefined) ? '' : String(v); }; %>
      <% const numVal = (name) => { const v = pickVal(name); return v === '' ? '' : v; }; %>

      <% (tabs || []).forEach((t, idx) => { %>
        <section id="tab_<%= t.id %>" class="gv-tabpanel <%= idx === 0 ? 'is-active' : '' %>" role="tabpanel" data-tabpanel="<%= t.id %>">
          <% if (t.id === 'agenda') { %>
            <% const cid = (typeof contactoId !== 'undefined' && contactoId) ? contactoId : (item.Id || item.id); %>
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <h2 style="margin: 0; font-size: 1.05rem;">Agenda</h2>
                <a class="btn secondary" href="/clientes/<%= cid %>" title="Gestionar en ficha del cliente">Gestionar</a>
                <a class="btn secondary" href="/agenda" title="Abrir Agenda">Abrir Agenda</a>
              </div>
              <div style="color: var(--gv-muted); font-weight:800;">
                <% const hist = (typeof agendaIncludeHistorico !== 'undefined' && agendaIncludeHistorico) ? true : false; %>
                <a href="/clientes/<%= cid %>/edit?agendaHistorico=<%= hist ? '0' : '1' %>" style="text-decoration:none;">
                  <%= hist ? 'Ocultar histórico' : 'Ver histórico' %>
                </a>
              </div>
            </div>

            <div class="table-wrap" style="margin-top: 12px;">
              <table>
                <thead>
                  <tr>
                    <th>Persona</th>
                    <th>Empresa</th>
                    <th>Rol</th>
                    <th>Principal</th>
                    <th>Vigente</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (!agendaContactos || agendaContactos.length === 0) { %>
                    <tr><td colspan="5" style="color: var(--gv-muted); font-weight:800;">Sin contactos de agenda asociados.</td></tr>
                  <% } else { %>
                    <% agendaContactos.forEach((a) => { %>
                      <%
                        const aid = a?.Id_Contacto ?? a?.id_contacto ?? a?.Id ?? a?.id ?? '';
                        const anombre = [a?.Nombre, a?.Apellidos].filter(Boolean).join(' ').trim() || ('Contacto ' + aid);
                        const vigente = !a?.VigenteHasta;
                        const principal = String(a?.Es_Principal ?? 0) === '1';
                      %>
                      <tr>
                        <td><a href="/agenda/<%= aid %>"><%= anombre %></a></td>
                        <td><%= a?.Empresa ?? '' %></td>
                        <td><%= a?.Rol ?? '' %></td>
                        <td><%= principal ? 'Sí' : '—' %></td>
                        <td><%= vigente ? 'Sí' : 'No' %></td>
                      </tr>
                    <% }) %>
                  <% } %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="grid cols-2" style="gap: 12px;">
              <% (t.fields || []).forEach((f) => { %>
                <% const name = f.name; %>
                <% const label = f.label; %>
                <% const required = !!f.required; %>
                <% const spec = f.spec || {}; %>
                <% const isMissing = missingFieldsList.indexOf(name) !== -1; %>
                <% const inputId = `gv_${String(name).replace(/[^a-zA-Z0-9_-]/g, '_')}`; %>

                <label style="display:grid; gap: 6px;" class="<%= isMissing ? 'gv-field-error' : '' %>">
                  <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;"><%= label %><%= required ? ' *' : '' %></span>

                  <% if (spec.kind === 'readonly') { %>
                    <div class="gv-readonly"><%= pickVal(name) || '—' %></div>
                  <% } else if (spec.kind === 'textarea') { %>
                    <textarea id="<%= inputId %>" name="<%= name %>" rows="4" <%= required ? 'required' : '' %> aria-invalid="<%= isMissing ? 'true' : 'false' %>"><%= pickVal(name) %></textarea>
                  <% } else if (spec.kind === 'checkbox') { %>
                    <input type="hidden" name="<%= name %>" value="0" />
                    <div style="display:flex; align-items:center; gap:10px;">
                      <input id="<%= inputId %>" type="checkbox" name="<%= name %>" value="1" <%= (pickVal(name) === '1' || pickVal(name).toLowerCase() === 'true') ? 'checked' : '' %> />
                      <span style="color: var(--gv-muted); font-weight:700;">Sí</span>
                    </div>
                  <% } else if (spec.kind === 'select' && spec.options === 'ok_ko') { %>
                    <select id="gv-ok-ko" name="<%= name %>">
                      <option value="1" <%= pickVal(name) === '1' ? 'selected' : '' %>>Activo</option>
                      <option value="0" <%= pickVal(name) === '0' ? 'selected' : '' %>>Inactivo</option>
                    </select>
                    <small style="color: var(--gv-muted);">Solo se puede estar activo con DNI/CIF informado.</small>
                  <% } else if (spec.kind === 'select' && spec.options === 'estados_cliente') { %>
                    <% const curId = Number(pickVal(name) || 0) || 0; %>
                    <select id="<%= inputId %>" name="<%= name %>">
                      <option value="">—</option>
                      <% (estadosCliente || []).forEach((r) => { %>
                        <% const rid = Number(r.id ?? r.Id ?? r.ID ?? 0) || 0; %>
                        <% const rlabel = r.Nombre ?? r.nombre ?? ('Estado ' + rid); %>
                        <option value="<%= rid %>" <%= rid === curId ? 'selected' : '' %>><%= rlabel %></option>
                      <% }) %>
                    </select>
                    <small style="color: var(--gv-muted);">Si seleccionas Activo sin DNI/CIF válido, se guardará como Potencial.</small>
                  <% } else if (spec.kind === 'select' && spec.options === 'tipo_contacto') { %>
                    <select id="<%= inputId %>" name="<%= name %>">
                      <option value="">— Seleccionar —</option>
                      <option value="Empresa" <%= pickVal(name) === 'Empresa' ? 'selected' : '' %>>Empresa</option>
                      <option value="Persona" <%= pickVal(name) === 'Persona' ? 'selected' : '' %>>Persona</option>
                      <option value="Otros" <%= pickVal(name) === 'Otros' ? 'selected' : '' %>>Otros</option>
                    </select>
                  <% } else if (spec.kind === 'select' && spec.options === 'comerciales') { %>
                    <% const cur = Number(pickVal(name) || 0) || 0; %>
                    <% if (canChangeComercial) { %>
                      <select id="<%= inputId %>" name="<%= name %>">
                        <option value="">(sin asignar)</option>
                        <% (comerciales || []).forEach((c) => { %>
                          <% const cid = Number(c.id ?? c.Id ?? 0) || 0; %>
                          <option value="<%= cid %>" <%= cid === cur ? 'selected' : '' %>><%= c.Nombre ?? '' %> (<%= c.Email || c.email || '' %>)</option>
                        <% }) %>
                      </select>
                    <% } else { %>
                      <% const comercialAsignado = (comerciales || []).find(function(c){ return Number(c.id ?? c.Id ?? 0) === cur; }); %>
                      <div class="gv-readonly"><%= comercialAsignado ? (comercialAsignado.Nombre ?? '') : 'Sin asignar' %></div>
                      <input type="hidden" name="<%= name %>" value="<%= pickVal(name) %>" />
                    <% } %>
                  <% } else if (spec.kind === 'select' && spec.options === 'tarifas') { %>
                    <% const curTar = Number(pickVal(name) || 0) || 0; %>
                    <select id="<%= inputId %>" name="<%= name %>">
                      <% (tarifas || []).forEach((t) => { %>
                        <% const tid = Number(t.Id ?? t.id ?? 0) || 0; %>
                        <% const tlabel = t.NombreTarifa ?? t.Nombre ?? t.nombre ?? ('Tarifa ' + tid); %>
                        <option value="<%= tid %>" <%= tid === curTar ? 'selected' : '' %>><%= tid %> · <%= tlabel %></option>
                      <% }) %>
                    </select>
                  <% } else if (spec.kind === 'select' && spec.options === 'paises') { %>
                    <% const curId = Number(pickVal(name) || 0) || 0; %>
                    <select id="<%= inputId %>" name="<%= name %>">
                      <option value="">—</option>
                      <% (paises || []).forEach((p) => { %>
                        <% const pid = Number(p.id ?? p.Id ?? p.ID ?? 0) || 0; %>
                        <% const plabel = p.Nombre_pais ?? p.Nombre ?? p.nombre ?? p.Pais ?? ('País ' + pid); %>
                        <option value="<%= pid %>" <%= pid === curId ? 'selected' : '' %>><%= plabel %></option>
                      <% }) %>
                    </select>
                  <% } else if (spec.kind === 'select' && spec.options === 'provincias') { %>
                    <% const curId = Number(pickVal(name) || 0) || 0; %>
                    <select id="<%= inputId %>" name="<%= name %>">
                      <option value="">—</option>
                      <% (provincias || []).forEach((p) => { %>
                        <% const pid = Number(p.id ?? p.Id ?? p.ID ?? 0) || 0; %>
                        <% const plabel = p.Nombre_provincia ?? p.Nombre ?? p.nombre ?? p.Provincia ?? ('Provincia ' + pid); %>
                        <option value="<%= pid %>" <%= pid === curId ? 'selected' : '' %>><%= plabel %></option>
                      <% }) %>
                    </select>
                  <% } else if (spec.kind === 'select' && spec.options === 'formas_pago') { %>
                    <% const curId = Number(pickVal(name) || 0) || 0; %>
                    <select id="<%= inputId %>" name="<%= name %>">
                      <option value="">—</option>
                      <% (formasPago || []).forEach((r) => { %>
                        <% const rid = Number(r.id ?? r.Id ?? r.ID ?? 0) || 0; %>
                      <% const rlabel = r.FormaPago ?? r.Nombre ?? r.nombre ?? r.descripcion ?? r.Descripcion ?? r.nombre ?? ('Forma pago ' + rid); %>
                      <option value="<%= rid %>" <%= rid === curId ? 'selected' : '' %>><%= rlabel %></option>
                    <% }) %>
                  </select>
                <% } else if (spec.kind === 'select' && spec.options === 'tipos_clientes') { %>
                  <% const curId = Number(pickVal(name) || 0) || 0; %>
                  <select id="<%= inputId %>" name="<%= name %>">
                    <option value="">—</option>
                    <% (tiposClientes || []).forEach((r) => { %>
                      <% const rid = Number(r.id ?? r.Id ?? r.ID ?? 0) || 0; %>
                      <% const rlabel = r.Tipo ?? r.Nombre ?? r.nombre ?? r.descripcion ?? r.Descripcion ?? ('Tipo cliente ' + rid); %>
                      <option value="<%= rid %>" <%= rid === curId ? 'selected' : '' %>><%= rlabel %></option>
                    <% }) %>
                  </select>
                <% } else if (spec.kind === 'select' && spec.options === 'tipos_clientes_nombre') { %>
                  <% const cur = String(pickVal(name) || '').trim().toLowerCase(); %>
                  <select id="<%= inputId %>" name="<%= name %>">
                    <option value="">—</option>
                    <% (tiposClientes || []).forEach((r) => { %>
                      <% const rlabel = String(r.Tipo ?? r.Nombre ?? r.nombre ?? r.descripcion ?? r.Descripcion ?? '').trim(); %>
                      <% const rval = rlabel; %>
                      <option value="<%= rval %>" <%= (rlabel && rlabel.trim().toLowerCase() === cur) ? 'selected' : '' %>><%= rlabel || '—' %></option>
                    <% }) %>
                  </select>
                <% } else if (spec.kind === 'select' && spec.options === 'idiomas') { %>
                  <% const curId = Number(pickVal(name) || 0) || 0; %>
                  <select id="<%= inputId %>" name="<%= name %>">
                    <option value="">—</option>
                    <% (idiomas || []).forEach((r) => { %>
                      <% const rid = Number(r.id ?? r.Id ?? r.ID ?? 0) || 0; %>
                      <% const code = (r.Codigo ?? r.codigo ?? '').toString().trim(); %>
                      <% const name = r.Nombre ?? r.Idioma ?? r.descripcion ?? r.Descripcion ?? ('Idioma ' + rid); %>
                      <% const rlabel = code ? (code + ' · ' + name) : name; %>
                      <option value="<%= rid %>" <%= rid === curId ? 'selected' : '' %>><%= rlabel %></option>
                    <% }) %>
                  </select>
                <% } else if (spec.kind === 'select' && spec.options === 'monedas') { %>
                  <% const curId = Number(pickVal(name) || 0) || 0; %>
                  <select id="<%= inputId %>" name="<%= name %>">
                    <option value="">—</option>
                    <% (monedas || []).forEach((r) => { %>
                      <% const rid = Number(r.id ?? r.Id ?? r.ID ?? 0) || 0; %>
                      <% const code = (r.Codigo ?? r.codigo ?? r.ISO ?? r.Iso ?? '').toString().trim(); %>
                      <% const name = r.Nombre ?? r.Moneda ?? r.descripcion ?? r.Descripcion ?? ('Moneda ' + rid); %>
                      <% const rlabel = code ? (code + ' · ' + name) : name; %>
                      <option value="<%= rid %>" <%= rid === curId ? 'selected' : '' %>><%= rlabel %></option>
                    <% }) %>
                  </select>
                <% } else if (spec.kind === 'select' && spec.options === 'cooperativas') { %>
                  <% const curId = Number(pickVal(name) || 0) || 0; %>
                  <select id="<%= inputId %>" name="<%= name %>">
                    <option value="">—</option>
                    <% (cooperativas || []).forEach((r) => { %>
                      <% const rid = Number(r.id ?? r.Id ?? r.ID ?? 0) || 0; %>
                      <% const rlabel = r.Nombre ?? r.nombre ?? ('Cooperativa ' + rid); %>
                      <option value="<%= rid %>" <%= rid === curId ? 'selected' : '' %>><%= rlabel %></option>
                    <% }) %>
                  </select>
                <% } else if (spec.kind === 'select' && spec.options === 'grupos_compras') { %>
                  <% const curId = Number(pickVal(name) || 0) || 0; %>
                  <select id="<%= inputId %>" name="<%= name %>">
                    <option value="">—</option>
                    <% (gruposCompras || []).forEach((r) => { %>
                      <% const rid = Number(r.id ?? r.Id ?? r.ID ?? 0) || 0; %>
                      <% const rlabel = r.Nombre ?? r.nombre ?? ('Grupo compras ' + rid); %>
                      <option value="<%= rid %>" <%= rid === curId ? 'selected' : '' %>><%= rlabel %></option>
                    <% }) %>
                  </select>
                <% } else { %>
                  <% const type = spec.type || 'text'; %>
                  <input
                    id="<%= inputId %>"
                    name="<%= name %>"
                    type="<%= type %>"
                    <%= required ? 'required' : '' %>
                    value="<%= (type === 'number') ? numVal(name) : pickVal(name) %>"
                    aria-invalid="<%= isMissing ? 'true' : 'false' %>"
                    <%= type === 'number' ? 'step="0.01"' : '' %>
                  />
                <% } %>

                <% if (isMissing) { %><small class="gv-field-error-msg">Campo obligatorio</small><% } %>
              </label>
            <% }) %>
          </div>
          <% } %>
        </section>
      <% }) %>
    </form>

    <div class="gv-modal-backdrop" id="gvUnsavedBackdrop" hidden></div>
    <div class="gv-modal" id="gvUnsavedModal" hidden role="dialog" aria-modal="true" aria-labelledby="gvUnsavedTitle">
      <div class="gv-modal-card">
        <div class="gv-modal-hd">
          <div class="gv-modal-title" id="gvUnsavedTitle">Salir sin guardar</div>
          <div class="gv-modal-subtitle">Has modificado campos. Si sales ahora, perderás los cambios.</div>
        </div>
        <div class="gv-modal-actions">
          <button type="button" class="btn secondary" id="gvUnsavedStay">Seguir editando</button>
          <a class="btn" href="<%= cancelHref %>" id="gvUnsavedLeave">Salir sin guardar</a>
        </div>
      </div>
    </div>

    <% if (mode === 'create') { %>
      <div class="gv-modal-backdrop" id="gvDupBackdrop" hidden></div>
      <div class="gv-modal" id="gvDupModal" hidden role="dialog" aria-modal="true" aria-labelledby="gvDupTitle">
        <div class="gv-modal-card" style="max-width: 760px;">
          <div class="gv-modal-hd">
            <div class="gv-modal-title" id="gvDupTitle">Este contacto puede estar ya dado de alta</div>
            <div class="gv-modal-subtitle">Hemos encontrado coincidencias por CIF/NIF o por nombre. Revisa antes de crear un duplicado.</div>
          </div>
          <div class="gv-modal-bd" style="padding: 0 16px 10px 16px;">
            <div id="gvDupList" style="display:grid; gap: 10px;"></div>
          </div>
          <div class="gv-modal-actions" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
            <button type="button" class="btn secondary" id="gvDupContinue">Seguir creando</button>
            <a class="btn" href="/clientes" id="gvDupCancel">Cancelar alta</a>
          </div>
        </div>
      </div>
    <% } %>
  </div>
</section>

<script>
(function () {
  var form = document.getElementById('gvClienteForm');
  if (!form) return;

  // Tabs
  var tabButtons = Array.prototype.slice.call(document.querySelectorAll('.gv-tab[data-tab]'));
  var panels = Array.prototype.slice.call(document.querySelectorAll('.gv-tabpanel[data-tabpanel]'));
  function setTab(id) {
    tabButtons.forEach(function (b) {
      var active = b.getAttribute('data-tab') === id;
      b.classList.toggle('is-active', active);
      b.setAttribute('aria-selected', active ? 'true' : 'false');
    });
    panels.forEach(function (p) {
      var active = p.getAttribute('data-tabpanel') === id;
      p.classList.toggle('is-active', active);
    });
  }
  tabButtons.forEach(function (b) {
    b.addEventListener('click', function () {
      setTab(b.getAttribute('data-tab'));
    });
  });

  // Dirty tracking
  var dirtyHint = document.getElementById('gvDirtyHint');
  var initial = null;
  function snapshot() {
    var fd = new FormData(form);
    var obj = {};
    fd.forEach(function (v, k) {
      // Si hay múltiples entradas con mismo nombre (ej hidden+checkbox), quedarnos con la última
      obj[k] = String(v);
    });
    return obj;
  }
  initial = snapshot();
  function isDirty() {
    var cur = snapshot();
    var keys = Object.keys(initial);
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      if (String(cur[k] || '') !== String(initial[k] || '')) return true;
    }
    // nuevos campos
    var curKeys = Object.keys(cur);
    for (var j = 0; j < curKeys.length; j++) {
      var kk = curKeys[j];
      if (initial[kk] === undefined && String(cur[kk] || '') !== '') return true;
    }
    return false;
  }
  function updateDirtyUi() {
    var d = isDirty();
    if (dirtyHint) dirtyHint.style.display = d ? 'block' : 'none';
  }
  form.addEventListener('input', updateDirtyUi);
  form.addEventListener('change', updateDirtyUi);
  updateDirtyUi();

  // Cancel confirm modal
  var cancelBtn = document.getElementById('gvCancelBtn');
  var backdrop = document.getElementById('gvUnsavedBackdrop');
  var modal = document.getElementById('gvUnsavedModal');
  var stay = document.getElementById('gvUnsavedStay');

  function showModal() {
    if (backdrop) backdrop.hidden = false;
    if (modal) modal.hidden = false;
    if (stay) stay.focus();
  }
  function hideModal() {
    if (backdrop) backdrop.hidden = true;
    if (modal) modal.hidden = true;
  }

  if (cancelBtn) {
    cancelBtn.addEventListener('click', function (e) {
      if (!isDirty()) return;
      e.preventDefault();
      showModal();
    });
  }
  if (backdrop) backdrop.addEventListener('click', hideModal);
  if (stay) stay.addEventListener('click', hideModal);

  // DNI/CIF -> no permitir OK si vacío
  var dni = document.getElementById('gv_DNI_CIF') || document.getElementById('gv-dni-cif');
  var okKo = document.getElementById('gv-ok-ko');
  if (dni && okKo) {
    function sync() {
      var vacio = !String(dni.value || '').trim();
      var opt = okKo.querySelector('option[value=\"1\"]');
      if (opt) opt.disabled = vacio;
      if (vacio && okKo.value === '1') okKo.value = '0';
    }
    dni.addEventListener('input', sync);
    dni.addEventListener('change', sync);
    sync();
  }

  // Duplicados (solo alta)
  var mode = "<%= mode %>";
  if (mode === 'create') {
    var dupBackdrop = document.getElementById('gvDupBackdrop');
    var dupModal = document.getElementById('gvDupModal');
    var dupList = document.getElementById('gvDupList');
    var dupContinue = document.getElementById('gvDupContinue');
    var dupConfirmed = document.getElementById('gvDupConfirmed');

    var lastKeyShown = '';
    var aborter = null;

    function showDupModal() {
      if (dupBackdrop) dupBackdrop.hidden = false;
      if (dupModal) dupModal.hidden = false;
      if (dupContinue) dupContinue.focus();
    }
    function hideDupModal() {
      if (dupBackdrop) dupBackdrop.hidden = true;
      if (dupModal) dupModal.hidden = true;
    }
    if (dupBackdrop) dupBackdrop.addEventListener('click', hideDupModal);
    if (dupContinue) dupContinue.addEventListener('click', function () {
      if (dupConfirmed) dupConfirmed.value = '1';
      hideDupModal();
      // si el usuario estaba intentando guardar, reenviar submit
      try { form.requestSubmit ? form.requestSubmit() : form.submit(); } catch (_) {}
    });

    function debounce(fn, wait) {
      var t = null;
      return function () {
        var args = arguments;
        if (t) window.clearTimeout(t);
        t = window.setTimeout(function () { fn.apply(null, args); }, wait);
      };
    }
    function escapeHtml(s) {
      return String(s || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    function normDni(s) {
      return String(s || '')
        .trim()
        .toUpperCase()
        .replace(/\s+/g, '')
        .replace(/-/g, '');
    }
    function normName(s) {
      try {
        return String(s || '')
          .trim()
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, ' ');
      } catch (_) {
        return String(s || '').trim().toLowerCase().replace(/\s+/g, ' ');
      }
    }
    async function duplicates(dni, nombre, nombreCial) {
      var url = "/api/clientes/duplicates?limit=6"
        + "&dni=" + encodeURIComponent(String(dni || ''))
        + "&nombre=" + encodeURIComponent(String(nombre || ''))
        + "&nombreCial=" + encodeURIComponent(String(nombreCial || ''));
      var opts = { headers: { Accept: 'application/json' } };
      if (aborter) aborter.abort();
      aborter = new AbortController();
      opts.signal = aborter.signal;
      var r = await fetch(url, opts);
      if (!r.ok) throw new Error("HTTP " + r.status);
      var json = await r.json();
      if (!json || json.ok !== true) return [];
      return {
        matches: Array.isArray(json.matches) ? json.matches : [],
        otherCount: Number(json.otherCount || 0) || 0
      };
    }
    function renderMatches(items, otherCount) {
      if (!dupList) return;
      if ((!items || !items.length) && !otherCount) {
        dupList.innerHTML = '<div class="gv-alert gv-alert--warn" style="margin:0;">No se han encontrado coincidencias.</div>';
        return;
      }
      var html = '';
      if (otherCount && (!items || !items.length)) {
        html += '<div class="gv-alert gv-alert--warn" style="margin:0;">Se han detectado coincidencias en otros contactos a los que no tienes acceso (' + escapeHtml(otherCount) + '). Contacta con un administrador.</div>';
      }
      html += (items || []).map(function (it) {
        var id = it.Id || it.id || '';
        var rs = it.Nombre_Razon_Social || it.Nombre || '';
        var nc = it.Nombre_Cial || '';
        var cif = it.DNI_CIF || '';
        var cp = it.CodigoPostal || '';
        var pob = it.Poblacion || '';
        var title = [rs, nc].filter(Boolean).join(' / ') || ('Contacto ' + id);
        var meta = [cif, [cp, pob].filter(Boolean).join(' ')].filter(Boolean).join(' · ');
        return (
          '<div style="display:flex; gap:10px; align-items:flex-start; justify-content:space-between; border:1px solid var(--gv-border); border-radius:12px; padding:12px; background: rgba(255,255,255,.85);">' +
            '<div style="min-width:0;">' +
              '<div style="font-weight:900; color:var(--gv-ink);">' + escapeHtml(id) + ' · ' + escapeHtml(title) + '</div>' +
              (meta ? ('<div style="margin-top:4px; color:var(--gv-muted); font-weight:700;">' + escapeHtml(meta) + '</div>') : '') +
            '</div>' +
            '<div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">' +
              '<a class="btn secondary" href="/clientes/' + encodeURIComponent(String(id)) + '">Ver</a>' +
              '<a class="btn" href="/clientes/' + encodeURIComponent(String(id)) + '/edit">Modificar</a>' +
            '</div>' +
          '</div>'
        );
      }).join('');
      dupList.innerHTML = html || '<div class="gv-alert gv-alert--warn" style="margin:0;">No se han encontrado coincidencias.</div>';
    }

    var dniInput = document.getElementById('gv_DNI_CIF');
    var nameInput = document.getElementById('gv_Nombre_Razon_Social');
    var comercialNameInput = document.getElementById('gv_Nombre_Cial');

    var run = debounce(async function () {
      try {
        var dniVal = normDni(dniInput ? dniInput.value : '');
        var nameVal = normName(nameInput ? nameInput.value : '');
        var cialVal = normName(comercialNameInput ? comercialNameInput.value : '');

        var key = [dniVal, nameVal, cialVal].join('|');
        // no re-lanzar si no cambió nada desde que ya lo mostramos
        if (key && key === lastKeyShown) return;

        // Solo lanzar cuando haya señales suficientes
        if (!(dniVal && dniVal.length >= 8) && !(nameVal && nameVal.length >= 6) && !(cialVal && cialVal.length >= 6)) return;

        var result = await duplicates(dniVal, nameVal, cialVal);
        var matches = result.matches || [];
        var otherCount = Number(result.otherCount || 0) || 0;
        if (!matches.length && !otherCount) return;

        lastKeyShown = key;
        renderMatches(matches.slice(0, 6), otherCount);
        showDupModal();
      } catch (_e) {
        // silencioso: no bloquear el alta si falla el lookup
      }
    }, 350);

    [dniInput, nameInput, comercialNameInput].filter(Boolean).forEach(function (el) {
      el.addEventListener('input', run);
      el.addEventListener('change', run);
    });

    // Bloquear submit si hay duplicados y no se ha confirmado aún
    form.addEventListener('submit', async function (e) {
      try {
        if (dupConfirmed && String(dupConfirmed.value) === '1') return;
        var dniVal = normDni(dniInput ? dniInput.value : '');
        var nameVal = normName(nameInput ? nameInput.value : '');
        var cialVal = normName(comercialNameInput ? comercialNameInput.value : '');
        if (!(dniVal && dniVal.length >= 8) && !(nameVal && nameVal.length >= 6) && !(cialVal && cialVal.length >= 6)) return;
        e.preventDefault();
        var result = await duplicates(dniVal, nameVal, cialVal);
        var matches = result.matches || [];
        var otherCount = Number(result.otherCount || 0) || 0;
        if (!matches.length && !otherCount) {
          if (dupConfirmed) dupConfirmed.value = '1'; // no hay duplicados: permitir crear
          try { form.requestSubmit ? form.requestSubmit() : form.submit(); } catch (_) {}
          return;
        }
        renderMatches(matches.slice(0, 6), otherCount);
        showDupModal();
      } catch (_err) {
        // si falla, no bloquear el alta (fallback a validación servidor)
      }
    });

    // Si el servidor re-renderiza con coincidencias, mostrarlas al cargar
    try {
      var serverMatches = <%- JSON.stringify(typeof dupMatches !== 'undefined' ? dupMatches : []) %>;
      var serverOther = <%- JSON.stringify(typeof dupOtherCount !== 'undefined' ? dupOtherCount : 0) %>;
      if ((serverMatches && serverMatches.length) || (serverOther && Number(serverOther) > 0)) {
        renderMatches((serverMatches || []).slice(0, 6), Number(serverOther || 0) || 0);
        showDupModal();
      }
    } catch (_) {}
  }
})();
</script>

<%- include('partials/footer') %>

