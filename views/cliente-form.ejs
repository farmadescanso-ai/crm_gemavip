<%- include('partials/header', { title: mode === 'edit' ? 'Editar contacto' : 'Nuevo contacto' }) %>

<section class="card" style="max-width: 980px; margin: 0 auto;">
  <div class="card-hd">
    <h1 class="card-title"><%= mode === 'edit' ? 'Editar contacto' : 'Nuevo contacto' %></h1>
    <p class="card-subtitle">Completa la información básica. Solo los contactos con DNI/CIF y estado activo pueden recibir pedidos.</p>
  </div>
  <div class="card-bd">
    <% const missingFieldsList = (typeof missingFields !== 'undefined' && Array.isArray(missingFields)) ? missingFields : []; %>
    <% if (error) { %>
      <div class="gv-alert gv-alert--warn"><%= error %></div>
      <div style="height: 10px;"></div>
    <% } %>

    <form method="post" action="<%= mode === 'edit' ? ('/clientes/' + (item.Id || item.id) + '/edit') : '/clientes/new' %>" style="display:grid; gap: 12px;">
      <div class="grid cols-2" style="gap: 12px;">
        <label style="display:grid; gap: 6px;" class="<%= missingFieldsList.indexOf('Nombre_Razon_Social') !== -1 ? 'gv-field-error' : '' %>">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Nombre / Razón Social *</span>
          <input name="Nombre_Razon_Social" required value="<%= item.Nombre_Razon_Social ?? item.Nombre ?? '' %>" aria-invalid="<%= missingFieldsList.indexOf('Nombre_Razon_Social') !== -1 ? 'true' : 'false' %>" />
          <% if (missingFieldsList.indexOf('Nombre_Razon_Social') !== -1) { %><small class="gv-field-error-msg">Campo obligatorio</small><% } %>
        </label>
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Tipo de contacto</span>
          <select name="TipoContacto">
            <option value="">— Seleccionar —</option>
            <option value="Empresa" <%= (item.TipoContacto || '').toString() === 'Empresa' ? 'selected' : '' %>>Empresa</option>
            <option value="Persona" <%= (item.TipoContacto || '').toString() === 'Persona' ? 'selected' : '' %>>Persona</option>
            <option value="Otros" <%= (item.TipoContacto || '').toString() === 'Otros' ? 'selected' : '' %>>Otros</option>
          </select>
        </label>
      </div>

      <div class="grid cols-2" style="gap: 12px;">
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">DNI/CIF</span>
          <input name="DNI_CIF" id="gv-dni-cif" value="<%= item.DNI_CIF ?? '' %>" placeholder="Obligatorio para pedidos y estado activo" />
        </label>
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Email</span>
          <input type="email" name="Email" value="<%= item.Email ?? '' %>" />
        </label>
      </div>

      <div class="grid cols-3" style="gap: 12px;">
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Teléfono</span>
          <input name="Telefono" value="<%= item.Telefono ?? '' %>" />
        </label>
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Móvil</span>
          <input name="Movil" value="<%= item.Movil ?? '' %>" />
        </label>
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Estado</span>
          <select name="OK_KO" id="gv-ok-ko">
            <option value="1" <%= String(item.OK_KO ?? '1') === '1' ? 'selected' : '' %>>Activo</option>
            <option value="0" <%= String(item.OK_KO ?? '1') === '0' ? 'selected' : '' %>>Inactivo</option>
          </select>
          <small style="color: var(--gv-muted, #6c757d);">Solo se puede estar activo con DNI/CIF informado.</small>
        </label>
      </div>

      <div class="grid cols-2" style="gap: 12px;">
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Dirección</span>
          <input name="Direccion" value="<%= item.Direccion ?? '' %>" />
        </label>
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Población</span>
          <input name="Poblacion" value="<%= item.Poblacion ?? '' %>" />
        </label>
      </div>

      <div class="grid cols-3" style="gap: 12px;">
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Código Postal</span>
          <input name="CodigoPostal" value="<%= item.CodigoPostal ?? '' %>" />
        </label>
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Tarifa</span>
          <select name="Tarifa">
            <% const curTar = Number(item.Tarifa ?? item.Id_Tarifa ?? 0) || 0; %>
            <% (tarifas || []).forEach((t) => { %>
              <% const tid = Number(t.Id ?? t.id ?? 0) || 0; %>
              <% const label = t.NombreTarifa ?? t.Nombre ?? t.nombre ?? ('Tarifa ' + tid); %>
              <option value="<%= tid %>" <%= tid === curTar ? 'selected' : '' %>><%= tid %> · <%= label %></option>
            <% }) %>
          </select>
        </label>
        <label style="display:grid; gap: 6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Dto (%)</span>
          <input type="number" step="0.01" min="0" max="100" name="Dto" value="<%= item.Dto ?? 0 %>" />
        </label>
      </div>

      <% /* Comercial asignado: se muestra como "Nombre · Email" (ej. Farmadescanso 2021 SL · pedidos@farmadescanso.com). El ID del comercial se puede obtener con db.getComercialIdFromDisplayString(eseTexto). */ %>
      <label style="display:grid; gap: 6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Comercial asignado</span>
        <% const curCial = Number(item.Id_Cial ?? item.id_cial ?? item.ComercialId ?? 0) || 0; %>
        <% const comercialAsignado = (comerciales || []).find(function(c){ return Number(c.id ?? c.Id ?? 0) === curCial; }); %>
        <% const mostrarDropdown = mode !== 'edit' || (typeof canChangeComercial !== 'undefined' && canChangeComercial); %>
        <% if (mostrarDropdown) { %>
          <select name="Id_Cial">
            <option value="">(sin asignar)</option>
            <% (comerciales || []).forEach((c) => { %>
              <% const cid = Number(c.id ?? c.Id ?? 0) || 0; %>
              <option value="<%= cid %>" <%= cid === curCial ? 'selected' : '' %>><%= c.Nombre ?? '' %> (<%= c.Email || c.email || '' %>)</option>
            <% }) %>
          </select>
          <% if (mode === 'edit' && canChangeComercial) { %>
            <small style="color: var(--gv-muted, #6c757d);">Cambia al comercial que debe quedar asignado y guarda. Las solicitudes pendientes se gestionan en Solicitudes.</small>
          <% } %>
        <% } else { %>
          <p style="margin:0; padding: 8px 12px; background: var(--gv-muted-bg, #f1f3f5); border-radius: 8px; color: var(--gv-ink);"><%= comercialAsignado ? (comercialAsignado.Nombre ?? '') + (comercialAsignado.Email || comercialAsignado.email ? ' · ' + (comercialAsignado.Email || comercialAsignado.email) : '') : 'Sin asignar' %></p>
          <input type="hidden" name="Id_Cial" value="<%= item.Id_Cial ?? item.id_cial ?? item.ComercialId ?? '' %>" />
          <% if (puedeSolicitarAsignacion && contactoId) { %>
            <div style="margin-top: 8px;">
              <form method="post" action="/clientes/<%= contactoId %>/solicitar-asignacion" style="display:inline;">
                <button class="btn" type="submit">Solicitar que me asignen este contacto</button>
              </form>
              <small style="display:block; margin-top: 6px; color: var(--gv-muted, #6c757d);">Se enviará una solicitud al administrador; si la aprueba, el contacto quedará asignado a ti.</small>
            </div>
          <% } %>
        <% } %>
      </label>

      <label style="display:grid; gap: 6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Observaciones</span>
        <textarea name="Observaciones" rows="4"><%= item.Observaciones ?? item.Notas ?? '' %></textarea>
      </label>

      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <a class="btn secondary" href="/clientes">Cancelar</a>
        <button class="btn" type="submit"><%= mode === 'edit' ? 'Guardar' : 'Crear' %></button>
      </div>
    </form>
  </div>
</section>
<script>
(function () {
  var dni = document.getElementById('gv-dni-cif');
  var okKo = document.getElementById('gv-ok-ko');
  if (!dni || !okKo) return;
  function sync() {
    var vacio = !String(dni.value || '').trim();
    okKo.querySelector('option[value="1"]').disabled = vacio;
    if (vacio && okKo.value === '1') okKo.value = '0';
  }
  dni.addEventListener('input', sync);
  dni.addEventListener('change', sync);
  sync();
})();
</script>
<%- include('partials/footer') %>

