<%- include('partials/header', { title: mode === 'edit' ? 'Editar contacto' : 'Nuevo contacto' }) %>

<% const missingFieldsList = (typeof missingFields !== 'undefined' && Array.isArray(missingFields)) ? missingFields : []; %>
<% const formAction = mode === 'edit' ? ('/clientes/' + (item.Id || item.id) + '/edit') : '/clientes/new'; %>
<% const cancelHref = mode === 'edit' ? ('/clientes/' + (item.Id || item.id)) : '/clientes'; %>

<section class="card gv-cliente-form" style="max-width: 1080px; margin: 0 auto;">
  <div class="card-hd">
    <h1 class="card-title"><%= mode === 'edit' ? 'Editar contacto' : 'Nuevo contacto' %></h1>
    <p class="card-subtitle">Revisa y completa la ficha del cliente. Puedes moverte por pestañas sin perder cambios.</p>
  </div>
  <div class="card-bd">
    <% if (error) { %>
      <div class="gv-alert gv-alert--warn" style="margin-bottom:12px;"><%= error %></div>
    <% } %>

    <form id="gvClienteForm" method="post" action="<%= formAction %>" class="gv-form" style="display:grid; gap: 12px;">
      <div class="gv-form-actions-sticky">
        <div class="gv-form-actions-sticky__inner">
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <a class="btn secondary" href="<%= cancelHref %>" id="gvCancelBtn">Cancelar</a>
            <button class="btn" type="submit" id="gvSaveBtn"><%= mode === 'edit' ? 'Guardar' : 'Crear' %></button>
          </div>
          <div id="gvDirtyHint" style="display:none; color: var(--gv-muted); font-weight:800;">Tienes cambios sin guardar.</div>
        </div>
      </div>

      <div class="gv-tabs" role="tablist" aria-label="Secciones del contacto">
        <% (tabs || []).forEach((t, idx) => { %>
          <button
            type="button"
            class="gv-tab <%= idx === 0 ? 'is-active' : '' %>"
            role="tab"
            aria-selected="<%= idx === 0 ? 'true' : 'false' %>"
            aria-controls="tab_<%= t.id %>"
            data-tab="<%= t.id %>"
          ><%= t.label %></button>
        <% }) %>
      </div>

      <% const pickVal = (name) => { const v = (item && item[name] !== undefined) ? item[name] : ''; return (v === null || v === undefined) ? '' : String(v); }; %>
      <% const numVal = (name) => { const v = pickVal(name); return v === '' ? '' : v; }; %>

      <% (tabs || []).forEach((t, idx) => { %>
        <section id="tab_<%= t.id %>" class="gv-tabpanel <%= idx === 0 ? 'is-active' : '' %>" role="tabpanel" data-tabpanel="<%= t.id %>">
          <div class="grid cols-2" style="gap: 12px;">
            <% (t.fields || []).forEach((f) => { %>
              <% const name = f.name; %>
              <% const label = f.label; %>
              <% const required = !!f.required; %>
              <% const spec = f.spec || {}; %>
              <% const isMissing = missingFieldsList.indexOf(name) !== -1; %>
              <% const inputId = `gv_${String(name).replace(/[^a-zA-Z0-9_-]/g, '_')}`; %>

              <label style="display:grid; gap: 6px;" class="<%= isMissing ? 'gv-field-error' : '' %>">
                <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;"><%= label %><%= required ? ' *' : '' %></span>

                <% if (spec.kind === 'readonly') { %>
                  <div class="gv-readonly"><%= pickVal(name) || '—' %></div>
                <% } else if (spec.kind === 'textarea') { %>
                  <textarea id="<%= inputId %>" name="<%= name %>" rows="4" <%= required ? 'required' : '' %> aria-invalid="<%= isMissing ? 'true' : 'false' %>"><%= pickVal(name) %></textarea>
                <% } else if (spec.kind === 'checkbox') { %>
                  <input type="hidden" name="<%= name %>" value="0" />
                  <div style="display:flex; align-items:center; gap:10px;">
                    <input id="<%= inputId %>" type="checkbox" name="<%= name %>" value="1" <%= (pickVal(name) === '1' || pickVal(name).toLowerCase() === 'true') ? 'checked' : '' %> />
                    <span style="color: var(--gv-muted); font-weight:700;">Sí</span>
                  </div>
                <% } else if (spec.kind === 'select' && spec.options === 'ok_ko') { %>
                  <select id="gv-ok-ko" name="<%= name %>">
                    <option value="1" <%= pickVal(name) === '1' ? 'selected' : '' %>>Activo</option>
                    <option value="0" <%= pickVal(name) === '0' ? 'selected' : '' %>>Inactivo</option>
                  </select>
                  <small style="color: var(--gv-muted);">Solo se puede estar activo con DNI/CIF informado.</small>
                <% } else if (spec.kind === 'select' && spec.options === 'tipo_contacto') { %>
                  <select id="<%= inputId %>" name="<%= name %>">
                    <option value="">— Seleccionar —</option>
                    <option value="Empresa" <%= pickVal(name) === 'Empresa' ? 'selected' : '' %>>Empresa</option>
                    <option value="Persona" <%= pickVal(name) === 'Persona' ? 'selected' : '' %>>Persona</option>
                    <option value="Otros" <%= pickVal(name) === 'Otros' ? 'selected' : '' %>>Otros</option>
                  </select>
                <% } else if (spec.kind === 'select' && spec.options === 'comerciales') { %>
                  <% const cur = Number(pickVal(name) || 0) || 0; %>
                  <% if (canChangeComercial) { %>
                    <select id="<%= inputId %>" name="<%= name %>">
                      <option value="">(sin asignar)</option>
                      <% (comerciales || []).forEach((c) => { %>
                        <% const cid = Number(c.id ?? c.Id ?? 0) || 0; %>
                        <option value="<%= cid %>" <%= cid === cur ? 'selected' : '' %>><%= c.Nombre ?? '' %> (<%= c.Email || c.email || '' %>)</option>
                      <% }) %>
                    </select>
                  <% } else { %>
                    <% const comercialAsignado = (comerciales || []).find(function(c){ return Number(c.id ?? c.Id ?? 0) === cur; }); %>
                    <div class="gv-readonly"><%= comercialAsignado ? (comercialAsignado.Nombre ?? '') : 'Sin asignar' %></div>
                    <input type="hidden" name="<%= name %>" value="<%= pickVal(name) %>" />
                  <% } %>
                <% } else if (spec.kind === 'select' && spec.options === 'tarifas') { %>
                  <% const curTar = Number(pickVal(name) || 0) || 0; %>
                  <select id="<%= inputId %>" name="<%= name %>">
                    <% (tarifas || []).forEach((t) => { %>
                      <% const tid = Number(t.Id ?? t.id ?? 0) || 0; %>
                      <% const tlabel = t.NombreTarifa ?? t.Nombre ?? t.nombre ?? ('Tarifa ' + tid); %>
                      <option value="<%= tid %>" <%= tid === curTar ? 'selected' : '' %>><%= tid %> · <%= tlabel %></option>
                    <% }) %>
                  </select>
                <% } else if (spec.kind === 'select' && spec.options === 'paises') { %>
                  <% const curId = Number(pickVal(name) || 0) || 0; %>
                  <select id="<%= inputId %>" name="<%= name %>">
                    <option value="">—</option>
                    <% (paises || []).forEach((p) => { %>
                      <% const pid = Number(p.id ?? p.Id ?? p.ID ?? 0) || 0; %>
                      <% const plabel = p.Nombre_pais ?? p.Nombre ?? p.nombre ?? p.Pais ?? ('País ' + pid); %>
                      <option value="<%= pid %>" <%= pid === curId ? 'selected' : '' %>><%= plabel %></option>
                    <% }) %>
                  </select>
                <% } else if (spec.kind === 'select' && spec.options === 'provincias') { %>
                  <% const curId = Number(pickVal(name) || 0) || 0; %>
                  <select id="<%= inputId %>" name="<%= name %>">
                    <option value="">—</option>
                    <% (provincias || []).forEach((p) => { %>
                      <% const pid = Number(p.id ?? p.Id ?? p.ID ?? 0) || 0; %>
                      <% const plabel = p.Nombre_provincia ?? p.Nombre ?? p.nombre ?? p.Provincia ?? ('Provincia ' + pid); %>
                      <option value="<%= pid %>" <%= pid === curId ? 'selected' : '' %>><%= plabel %></option>
                    <% }) %>
                  </select>
                <% } else { %>
                  <% const type = spec.type || 'text'; %>
                  <input
                    id="<%= inputId %>"
                    name="<%= name %>"
                    type="<%= type %>"
                    <%= required ? 'required' : '' %>
                    value="<%= (type === 'number') ? numVal(name) : pickVal(name) %>"
                    aria-invalid="<%= isMissing ? 'true' : 'false' %>"
                    <%= type === 'number' ? 'step="0.01"' : '' %>
                  />
                <% } %>

                <% if (isMissing) { %><small class="gv-field-error-msg">Campo obligatorio</small><% } %>
              </label>
            <% }) %>
          </div>
        </section>
      <% }) %>
    </form>

    <div class="gv-modal-backdrop" id="gvUnsavedBackdrop" hidden></div>
    <div class="gv-modal" id="gvUnsavedModal" hidden role="dialog" aria-modal="true" aria-labelledby="gvUnsavedTitle">
      <div class="gv-modal-card">
        <div class="gv-modal-hd">
          <div class="gv-modal-title" id="gvUnsavedTitle">Salir sin guardar</div>
          <div class="gv-modal-subtitle">Has modificado campos. Si sales ahora, perderás los cambios.</div>
        </div>
        <div class="gv-modal-actions">
          <button type="button" class="btn secondary" id="gvUnsavedStay">Seguir editando</button>
          <a class="btn" href="<%= cancelHref %>" id="gvUnsavedLeave">Salir sin guardar</a>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(function () {
  var form = document.getElementById('gvClienteForm');
  if (!form) return;

  // Tabs
  var tabButtons = Array.prototype.slice.call(document.querySelectorAll('.gv-tab[data-tab]'));
  var panels = Array.prototype.slice.call(document.querySelectorAll('.gv-tabpanel[data-tabpanel]'));
  function setTab(id) {
    tabButtons.forEach(function (b) {
      var active = b.getAttribute('data-tab') === id;
      b.classList.toggle('is-active', active);
      b.setAttribute('aria-selected', active ? 'true' : 'false');
    });
    panels.forEach(function (p) {
      var active = p.getAttribute('data-tabpanel') === id;
      p.classList.toggle('is-active', active);
    });
  }
  tabButtons.forEach(function (b) {
    b.addEventListener('click', function () {
      setTab(b.getAttribute('data-tab'));
    });
  });

  // Dirty tracking
  var dirtyHint = document.getElementById('gvDirtyHint');
  var initial = null;
  function snapshot() {
    var fd = new FormData(form);
    var obj = {};
    fd.forEach(function (v, k) {
      // Si hay múltiples entradas con mismo nombre (ej hidden+checkbox), quedarnos con la última
      obj[k] = String(v);
    });
    return obj;
  }
  initial = snapshot();
  function isDirty() {
    var cur = snapshot();
    var keys = Object.keys(initial);
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      if (String(cur[k] || '') !== String(initial[k] || '')) return true;
    }
    // nuevos campos
    var curKeys = Object.keys(cur);
    for (var j = 0; j < curKeys.length; j++) {
      var kk = curKeys[j];
      if (initial[kk] === undefined && String(cur[kk] || '') !== '') return true;
    }
    return false;
  }
  function updateDirtyUi() {
    var d = isDirty();
    if (dirtyHint) dirtyHint.style.display = d ? 'block' : 'none';
  }
  form.addEventListener('input', updateDirtyUi);
  form.addEventListener('change', updateDirtyUi);
  updateDirtyUi();

  // Cancel confirm modal
  var cancelBtn = document.getElementById('gvCancelBtn');
  var backdrop = document.getElementById('gvUnsavedBackdrop');
  var modal = document.getElementById('gvUnsavedModal');
  var stay = document.getElementById('gvUnsavedStay');

  function showModal() {
    if (backdrop) backdrop.hidden = false;
    if (modal) modal.hidden = false;
    if (stay) stay.focus();
  }
  function hideModal() {
    if (backdrop) backdrop.hidden = true;
    if (modal) modal.hidden = true;
  }

  if (cancelBtn) {
    cancelBtn.addEventListener('click', function (e) {
      if (!isDirty()) return;
      e.preventDefault();
      showModal();
    });
  }
  if (backdrop) backdrop.addEventListener('click', hideModal);
  if (stay) stay.addEventListener('click', hideModal);

  // DNI/CIF -> no permitir OK si vacío
  var dni = document.getElementById('gv_DNI_CIF') || document.getElementById('gv-dni-cif');
  var okKo = document.getElementById('gv-ok-ko');
  if (dni && okKo) {
    function sync() {
      var vacio = !String(dni.value || '').trim();
      var opt = okKo.querySelector('option[value=\"1\"]');
      if (opt) opt.disabled = vacio;
      if (vacio && okKo.value === '1') okKo.value = '0';
    }
    dni.addEventListener('input', sync);
    dni.addEventListener('change', sync);
    sync();
  }
})();
</script>

<%- include('partials/footer') %>

