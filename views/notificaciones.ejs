<%- include('partials/header', { title: 'Notificaciones' }) %>

<section class="card">
  <div class="card-hd">
    <h1 class="card-title">Notificaciones</h1>
    <p class="card-subtitle">Solicitudes pendientes (asignaciÃ³n de clientes y pedidos especiales). Puedes aprobar o rechazar.</p>
  </div>
  <div class="card-bd">
    <% if (typeof resuelto !== 'undefined' && resuelto) { %>
      <p class="notice" style="margin-bottom:12px; padding:10px; background: rgba(25,135,84,.1); border-radius:8px; color:#198754;">
        <%= resuelto === 'aprobada' ? 'Solicitud aprobada.' : 'Solicitud rechazada.' %>
      </p>
    <% } %>
    <p style="margin-bottom: 16px; font-weight: 600; color: var(--gv-ink);">
      <span aria-hidden="true">ðŸ””</span> Solicitudes pendientes: <strong><%= typeof paging !== 'undefined' ? paging.total : 0 %></strong>
    </p>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Referencia</th>
            <th>Comercial solicitante</th>
            <th>Estado</th>
            <th>Fecha resoluciÃ³n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="notif-tbody">
          <% if (!items || items.length === 0) { %>
            <tr id="notif-empty-row">
              <td colspan="7" style="text-align:center; color: var(--gv-muted); padding: 24px;">No hay notificaciones.</td>
            </tr>
          <% } else { %>
            <% items.forEach((n) => { %>
              <tr>
                <td><%= typeof fmtDateES !== 'undefined' ? fmtDateES(n.fecha_creacion) : (n.fecha_creacion || '') %></td>
                <td>
                  <%= (n.tipo || '').toLowerCase() === 'pedido_especial' ? 'Pedido especial' : 'AsignaciÃ³n cliente' %>
                </td>
                <td>
                  <% const tipoN = (n.tipo || '').toLowerCase(); %>
                  <% const pidFromNotas = (() => { const m = String(n.notas || '').match(/pedidoId\s*=\s*(\d+)/i); return m && m[1] ? Number(m[1]) : null; })(); %>
                  <% const pid = (n.id_pedido != null ? Number(n.id_pedido) : null) || pidFromNotas; %>
                  <% if (tipoN === 'pedido_especial' && pid) { %>
                    <a href="/pedidos/<%= pid %>/edit"><%= n.pedido_num ? String(n.pedido_num) : 'Pedido' %></a>
                    <% if (n.contacto_nombre) { %>
                      <span style="color: var(--gv-muted);"> Â· Cliente <a href="/clientes/<%= n.id_contacto %>"><%= n.contacto_nombre %></a></span>
                    <% } %>
                  <% } else { %>
                    <a href="/clientes/<%= n.id_contacto %>"><%= n.contacto_nombre || 'Cliente' %></a>
                  <% } %>
                </td>
                <td><%= n.comercial_nombre || 'Comercial #' + n.id_comercial_solicitante %></td>
                <td>
                  <span class="gv-badge gv-badge--<%= (n.estado || '').toLowerCase() === 'pendiente' ? 'otros' : ((n.estado || '').toLowerCase() === 'aprobada' ? 'persona' : 'empresa') %>">
                    <%= (n.estado || '').toLowerCase() === 'pendiente' ? 'Pendiente' : ((n.estado || '').toLowerCase() === 'aprobada' ? 'Aprobada' : 'Rechazada') %>
                  </span>
                </td>
                <td><%= (n.estado || '').toLowerCase() !== 'pendiente' && n.fecha_resolucion ? (typeof fmtDateES !== 'undefined' ? fmtDateES(n.fecha_resolucion) : n.fecha_resolucion) : 'â€”' %></td>
                <td>
                  <% if ((n.estado || '').toLowerCase() === 'pendiente') { %>
                    <div class="gv-actions">
                      <form method="post" action="/notificaciones/<%= n.id %>/aprobar">
                        <button class="btn secondary icon success" type="submit" title="Aprobar" aria-label="Aprobar">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                      </form>
                      <form method="post" action="/notificaciones/<%= n.id %>/rechazar">
                        <button class="btn secondary icon danger" type="submit" title="Rechazar" aria-label="Rechazar">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                      </form>
                    </div>
                  <% } else { %>
                    â€”
                  <% } %>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</section>
<script>
(function() {
  var emptyRow = document.getElementById('notif-empty-row');
  var total = <%= (typeof paging !== 'undefined' && paging && paging.total) ? paging.total : 0 %>;
  if (!emptyRow || total === 0) return;
  fetch('/api/notificaciones?limit=50')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (!data.ok || !data.items || data.items.length === 0) return;
      var tbody = document.getElementById('notif-tbody');
      emptyRow.remove();
      var fmtDate = function(d) {
        if (!d) return '';
        var s = String(d);
        var m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m) return m[3] + '/' + m[2] + '/' + m[1];
        return s;
      };
      data.items.forEach(function(n) {
        var estado = (n.estado || '').toLowerCase();
        var estadoLabel = estado === 'pendiente' ? 'Pendiente' : (estado === 'aprobada' ? 'Aprobada' : 'Rechazada');
        var badgeClass = estado === 'pendiente' ? 'otros' : (estado === 'aprobada' ? 'persona' : 'empresa');
        var tipo = (n.tipo || '').toLowerCase();
        var tipoLabel = tipo === 'pedido_especial' ? 'Pedido especial' : 'AsignaciÃ³n cliente';
        var pid = n.id_pedido;
        if (!pid && tipo === 'pedido_especial' && n.notas) {
          var mm = String(n.notas).match(/pedidoId\s*=\s*(\d+)/i);
          if (mm && mm[1]) pid = parseInt(mm[1], 10) || null;
        }
        var pedidoLabel = (n.pedido_num ? String(n.pedido_num) : 'Pedido');
        var clienteLabel = (n.contacto_nombre ? String(n.contacto_nombre) : 'Cliente');
        var ref = (tipo === 'pedido_especial' && pid)
          ? ('<a href="/pedidos/' + pid + '/edit">' + pedidoLabel + '</a>' + (n.id_contacto ? ('<span style="color: var(--gv-muted);"> Â· Cliente <a href="/clientes/' + n.id_contacto + '">' + clienteLabel + '</a></span>') : ''))
          : ('<a href="/clientes/' + n.id_contacto + '">' + clienteLabel + '</a>');
        var tr = document.createElement('tr');
        var acc = estado === 'pendiente'
          ? '<div class="gv-actions"><form method="post" action="/notificaciones/' + n.id + '/aprobar"><button class="btn secondary icon success" type="submit" title="Aprobar" aria-label="Aprobar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg></button></form><form method="post" action="/notificaciones/' + n.id + '/rechazar"><button class="btn secondary icon danger" type="submit" title="Rechazar" aria-label="Rechazar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></form></div>'
          : 'â€”';
        var fechaResol = (estado !== 'pendiente' && n.fecha_resolucion) ? fmtDate(n.fecha_resolucion) : 'â€”';
        tr.innerHTML = '<td>' + fmtDate(n.fecha_creacion) + '</td><td>' + tipoLabel + '</td><td>' + ref + '</td><td>' + (n.comercial_nombre || 'Comercial #' + n.id_comercial_solicitante) + '</td><td><span class="gv-badge gv-badge--' + badgeClass + '">' + estadoLabel + '</span></td><td>' + fechaResol + '</td><td>' + acc + '</td>';
        tbody.appendChild(tr);
      });
    })
    .catch(function() {});
})();
</script>
<%- include('partials/footer') %>
