<%- include('partials/header', { title: 'Dashboard' }) %>

<% const isAdmin = user && (user.roles || []).some((r) => String(r).toLowerCase().includes('admin')); %>
<% const errs = typeof dashboardErrors !== 'undefined' ? (dashboardErrors || {}) : {}; %>

<% if (isAdmin && (errs.clientes || errs.pedidos)) { %>
  <section class="card" style="margin-bottom: 16px; border-color: #dc2626;">
    <div class="card-hd" style="background: #fef2f2;">
      <h2 class="card-title" style="color: #dc2626;">Errores al cargar el Dashboard</h2>
    </div>
    <div class="card-bd" style="font-family: monospace; font-size: 13px; white-space: pre-wrap; word-break: break-word;">
      <% if (errs.clientes) { %><p><strong>Clientes (top facturación):</strong> <%= errs.clientes %></p><% } %>
      <% if (errs.pedidos) { %><p><strong>Últimos pedidos:</strong> <%= errs.pedidos %></p><% } %>
    </div>
  </section>
<% } %>

<section class="card">
  <div class="card-hd">
    <h1 class="card-title">Dashboard</h1>
    <p class="card-subtitle">Resumen rápido del CRM.</p>
  </div>
  <div class="card-bd">
    <div class="dash-stats">
      <div class="dash-stat" data-variant="blue">
        <div class="dash-stat-label">Clientes</div>
        <div class="dash-stat-value"><%= stats.clientes ?? '—' %></div>
        <div class="dash-stat-foot"><%= isAdmin ? 'Total en BD' : 'Tus clientes' %></div>
      </div>
      <div class="dash-stat" data-variant="navy">
        <div class="dash-stat-label">Pedidos</div>
        <div class="dash-stat-value"><%= stats.pedidos ?? '—' %></div>
        <div class="dash-stat-foot"><%= isAdmin ? 'Total en BD' : 'Tus pedidos' %></div>
      </div>
      <div class="dash-stat" data-variant="green">
        <div class="dash-stat-label">Visitas</div>
        <div class="dash-stat-value"><%= stats.visitas ?? '—' %></div>
        <div class="dash-stat-foot"><%= isAdmin ? 'Total en BD' : 'Tus visitas' %></div>
      </div>
      <div class="dash-stat" data-variant="yellow">
        <div class="dash-stat-label">Ventas</div>
        <div class="dash-stat-value"><%= stats.ventas == null ? '—' : fmtEurES(stats.ventas) %></div>
        <div class="dash-stat-foot"><%= isAdmin ? 'Total de todos los comerciales' : 'Tus ventas acumuladas' %></div>
      </div>
      <% if (isAdmin) { %>
        <div class="dash-stat" data-variant="navy">
          <div class="dash-stat-label">Comerciales</div>
          <div class="dash-stat-value"><%= stats.comerciales ?? '—' %></div>
          <div class="dash-stat-foot">Total en BD</div>
        </div>
      <% } %>
    </div>

    <div style="margin-top: 14px; display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn" href="/clientes">Clientes</a>
      <a class="btn secondary" href="/pedidos">Pedidos</a>
      <a class="btn secondary" href="/visitas">Visitas</a>
      <% if (isAdmin) { %>
        <a class="btn secondary" href="/api/docs">API Docs</a>
      <% } %>
    </div>
  </div>
</section>

<div class="dash-grid" style="margin-top: 16px;">
  <section class="card dash-card">
    <div class="card-hd">
      <h2 class="card-title"><%= isAdmin ? 'Clientes con más facturación' : 'Últimos clientes' %></h2>
      <p class="card-subtitle"><%= isAdmin ? 'Top ' + (latest.clientes || []).length + ' por facturación' : 'Últimos ' + (latest.clientes || []).length %></p>
    </div>
    <div class="card-bd">
      <div class="table-wrap">
        <table class="dash-table">
          <thead>
            <tr>
              <th class="dash-th-actions">Acciones</th>
              <th>Nombre</th>
              <th>Población</th>
              <th>CP</th>
              <% if (isAdmin) { %><th>Facturación</th><% } %>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <% (latest.clientes || []).forEach((c) => { %>
              <% const cid = c.Id ?? c.id; %>
              <tr>
                <td class="dash-td-actions">
                  <div class="gv-actions">
                    <a class="btn secondary icon" href="/clientes/<%= cid %>" title="Ver ficha" aria-label="Ver cliente <%= cid %>">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </a>
                    <a class="btn secondary icon" href="/clientes/<%= cid %>/edit" title="Editar ficha" aria-label="Editar cliente <%= cid %>">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 20h9"></path><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path></svg>
                    </a>
                  </div>
                </td>
                <td><%= c.Nombre_Razon_Social ?? '' %></td>
                <td><%= c.Poblacion ?? '' %></td>
                <td><%= c.CodigoPostal ?? '' %></td>
                <% if (isAdmin && (c.TotalFacturado != null)) { %><td><%= fmtEurES(c.TotalFacturado) %></td><% } %>
                <td>
                  <% const st = (c.OK_KO ?? c.Estado ?? '').toString().toUpperCase(); %>
                  <% if (st === 'OK' || st === '1') { %>
                    <span class="badge ok">OK</span>
                  <% } else if (st === 'KO' || st === '0') { %>
                    <span class="badge warn">KO</span>
                  <% } else { %>
                    <span class="badge info"><%= st || '—' %></span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <div style="margin-top: 10px;">
        <a class="btn secondary" href="/clientes">Ver todos</a>
      </div>
    </div>
  </section>

  <section class="card dash-card">
    <div class="card-hd">
      <h2 class="card-title">Últimos pedidos</h2>
      <p class="card-subtitle"><%= isAdmin ? 'Últimos ' + (latest.pedidos || []).length : 'Últimos ' + (latest.pedidos || []).length %></p>
    </div>
    <div class="card-bd">
      <div class="table-wrap">
        <table class="dash-table">
          <thead>
            <tr>
              <th class="dash-th-actions">Acciones</th>
              <th>NumPedido</th>
              <th>Fecha</th>
              <th>Total</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <% (latest.pedidos || []).forEach((p) => { %>
              <% const pid = p.Id ?? p.id; %>
              <tr>
                <td class="dash-td-actions">
                  <div class="gv-actions">
                    <a class="btn secondary icon" href="/pedidos/<%= pid %>" title="Ver pedido" aria-label="Ver pedido <%= pid %>">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </a>
                    <a class="btn secondary icon" href="/pedidos/<%= pid %>/duplicate" title="Duplicar pedido" aria-label="Duplicar pedido <%= pid %>">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </a>
                  </div>
                </td>
                <td><%= p.NumPedido ?? p.Numero_Pedido ?? '' %></td>
                <td><%= fmtDateES(p.FechaPedido ?? p.Fecha ?? '') %></td>
                <td><%= fmtEurES(p.TotalPedido ?? p.Total ?? p.ImporteTotal ?? 0) %></td>
                <td><%= p.EstadoPedido ?? p.Estado ?? '' %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <div style="margin-top: 10px;">
        <a class="btn secondary" href="/pedidos">Ver todos</a>
      </div>
    </div>
  </section>
</div>

<% if ((latest.visitas || []).length > 0) { %>
<section class="card dash-card-visitas" style="margin-top: 16px;">
  <div class="card-hd">
    <h2 class="card-title">Últimas visitas</h2>
    <p class="card-subtitle">Últimas <%= (latest.visitas || []).length %></p>
  </div>
  <div class="card-bd">
    <div class="table-wrap">
      <table class="dash-table">
        <thead>
          <tr>
            <th class="dash-th-actions">Acciones</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Cliente</th>
            <% if (isAdmin) { %><th>Comercial</th><% } %>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <% (latest.visitas || []).forEach((v) => { %>
            <% const vid = v.Id ?? v.id; %>
            <tr>
              <td class="dash-td-actions">
                <div class="gv-actions">
                  <a class="btn secondary icon" href="/visitas/<%= vid %>" title="Ver" aria-label="Ver visita <%= vid %>">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                  </a>
                  <a class="btn secondary icon" href="/visitas/<%= vid %>/edit" title="Editar" aria-label="Editar visita <%= vid %>">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 20h9"></path><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path></svg>
                  </a>
                </div>
              </td>
              <td><%= fmtDateES(v.Fecha ?? v.FechaVisita ?? '') %></td>
              <td><%= v.TipoVisita ?? '' %></td>
              <td><%= v.ClienteNombre ?? v.ClienteId ?? v.FarmaciaClienteId ?? '' %></td>
              <% if (isAdmin) { %><td><%= v.ComercialNombre ?? v.Id_Cial ?? v.ComercialId ?? '' %></td><% } %>
              <td><%= v.Estado ?? '' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</section>
<% } %>

<%- include('partials/footer') %>

