<%- include('partials/header', { title: 'Clientes' }) %>

<section class="card">
  <div class="card-hd">
    <h1 class="card-title">Clientes</h1>
    <p class="card-subtitle">
      Página <%= paging.page %> · Mostrando <%= items.length %> de <%= paging.total %> (limit <%= paging.limit %>)
      <% if (typeof q !== 'undefined' && q) { %>
        · Buscando: "<%= q %>"
      <% } %>
    </p>
  </div>
  <div class="card-bd">
    <% if (admin) { %>
      <div style="display:flex; justify-content:flex-end; margin-bottom: 10px;">
        <a class="btn" href="/clientes/new">Nuevo cliente</a>
      </div>
    <% } %>
    <form method="get" action="/clientes" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom: 12px;">
      <input
        type="search"
        name="q"
        placeholder="Búsqueda inteligente (nombre, CIF, email, teléfono, CP o ID...)"
        value="<%= (typeof q !== 'undefined' && q) ? q : '' %>"
        style="min-width: 320px; flex: 1 1 320px;"
      />
      <input type="hidden" name="limit" value="<%= paging.limit %>" />
      <button class="btn" type="submit">Buscar</button>
      <% if (typeof q !== 'undefined' && q) { %>
        <a class="btn secondary" href="/clientes?limit=<%= paging.limit %>">Limpiar</a>
      <% } %>
    </form>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 12px;">
      <% if (paging.page > 1) { %>
        <a class="btn secondary" href="/clientes?page=<%= paging.page - 1 %>&limit=<%= paging.limit %><%= (typeof q !== 'undefined' && q) ? ('&q=' + encodeURIComponent(q)) : '' %>">Anterior</a>
      <% } %>
      <% if ((paging.page * paging.limit) < paging.total) { %>
        <a class="btn secondary" href="/clientes?page=<%= paging.page + 1 %>&limit=<%= paging.limit %><%= (typeof q !== 'undefined' && q) ? ('&q=' + encodeURIComponent(q)) : '' %>">Siguiente</a>
      <% } %>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Acciones</th>
            <th>ID</th>
            <th>Nombre/Razón Social</th>
            <th>Nombre Comercial</th>
            <th>CP</th>
            <th>Población</th>
            <th>Provincia</th>
            <th>Comercial</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <% items.forEach((c) => { %>
            <tr>
              <td>
                <div class="gv-actions">
                  <a class="btn secondary icon" href="/clientes/<%= c.id ?? c.Id %>" title="Ver" aria-label="Ver cliente <%= c.id ?? c.Id %>">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </a>
                  <% if (admin) { %>
                    <a class="btn secondary icon" href="/clientes/<%= c.id ?? c.Id %>/edit" title="Editar" aria-label="Editar cliente <%= c.id ?? c.Id %>">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                      </svg>
                    </a>
                    <form method="post" action="/clientes/<%= c.id ?? c.Id %>/delete" onsubmit="return confirm('¿Mover este cliente a la papelera?');">
                      <button class="btn secondary icon danger" type="submit" title="Papelera" aria-label="Enviar cliente <%= c.id ?? c.Id %> a papelera">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <path d="M3 6h18"></path>
                          <path d="M8 6V4h8v2"></path>
                          <path d="M19 6l-1 14H6L5 6"></path>
                          <path d="M10 11v6"></path>
                          <path d="M14 11v6"></path>
                        </svg>
                      </button>
                    </form>
                  <% } %>
                </div>
              </td>
              <td><%= c.id ?? c.Id %></td>
              <td><%= c.Nombre_Razon_Social ?? c.Nombre ?? '' %></td>
              <td><%= c.Nombre_Cial ?? '' %></td>
              <td><%= c.CodigoPostal ?? '' %></td>
              <td><%= c.Poblacion ?? '' %></td>
              <td><%= c.ProvinciaNombre ?? (c.Id_Provincia ?? '') %></td>
              <td><%= c.ComercialNombre ?? '' %></td>
              <td><%= c.EstadoClienteNombre ?? c.OK_KO ?? '' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<%- include('partials/footer') %>

