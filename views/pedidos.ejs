<%- include('partials/header', { title: 'Pedidos' }) %>

<section class="card">
  <div class="card-hd">
    <h1 class="card-title">Pedidos</h1>
    <p class="card-subtitle">
      Año <strong><%= selectedYear ?? new Date().getFullYear() %></strong> · <%= items.length %> pedidos (vista ligera).
    </p>
  </div>
  <div class="card-bd">
    <div style="display:flex; justify-content:flex-end; margin-bottom: 10px;">
      <a class="btn" href="/pedidos/new">Nuevo pedido</a>
    </div>
    <% if (typeof n8nNotice !== 'undefined' && n8nNotice) { %>
      <div id="gv-n8n-notice" class="gv-alert <%= n8nNotice.ok ? 'success' : 'error' %>" style="margin: 0 0 12px 0;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;">
          <div>
            <strong><%= n8nNotice.ok ? 'Pedido enviado a N8N' : 'No se pudo enviar el pedido' %></strong>
            <% if (n8nNotice.message) { %>
              <div style="margin-top:6px; white-space:pre-wrap;"><%= n8nNotice.message %></div>
            <% } %>
          </div>
          <% if (!n8nNotice.ok) { %>
            <button type="button" class="btn secondary icon warn" id="gv-n8n-notice-close" title="Cerrar" aria-label="Cerrar mensaje">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M18 6L6 18"></path>
                <path d="M6 6l12 12"></path>
              </svg>
            </button>
          <% } %>
        </div>
      </div>
      <script>
        (() => {
          const box = document.getElementById('gv-n8n-notice');
          if (!box) return;
          const isOk = <%= n8nNotice.ok ? 'true' : 'false' %>;
          if (isOk) {
            window.setTimeout(() => {
              if (box && box.parentNode) box.parentNode.removeChild(box);
            }, 5000);
            return;
          }
          const btn = document.getElementById('gv-n8n-notice-close');
          if (btn) {
            btn.addEventListener('click', () => {
              if (box && box.parentNode) box.parentNode.removeChild(box);
            });
          }
        })();
      </script>
    <% } %>
    <form method="get" action="/pedidos" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 0 0 12px 0;">
      <label for="year" style="font-weight:700; color: var(--gv-ink);">Año</label>
      <select id="year" name="year" class="gv-client-picker__q" style="width:auto; min-width: 140px;">
        <% (years || []).forEach((y) => { %>
          <option value="<%= y %>" <%= Number(selectedYear) === Number(y) ? 'selected' : '' %>><%= y %></option>
        <% }) %>
      </select>
      <label for="marca" style="font-weight:700; color: var(--gv-ink);">Marca</label>
      <select id="marca" name="marca" class="gv-client-picker__q" style="width:auto; min-width: 220px;">
        <option value="" <%= !selectedMarcaId ? 'selected' : '' %>>Todas</option>
        <% (marcas || []).forEach((m) => { %>
          <option value="<%= m.id %>" <%= Number(selectedMarcaId) === Number(m.id) ? 'selected' : '' %>><%= m.nombre ?? m.Nombre ?? m.marca ?? m.Marca ?? m.id %></option>
        <% }) %>
      </select>
      <button class="btn secondary" type="submit">Ver</button>
      <a class="btn secondary" href="/pedidos">Año actual</a>
    </form>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Acciones</th>
            <th>Fecha</th>
            <th>PEDIDO</th>
            <th>Cliente</th>
            <th>PEDIDO CLIENTE</th>
            <th>Nº Hefame</th>
            <th>Total</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <% items.forEach((p) => { %>
            <% const pid = p.Id ?? p.id; %>
            <% const owner = Number(p.Id_Cial ?? p.id_cial ?? p.ComercialId ?? p.comercialId ?? 0) || 0; %>
            <% const canWrite = admin || (userId && Number(userId) === owner); %>
            <% const noticePid = (typeof n8nNotice !== 'undefined' && n8nNotice && n8nNotice.pid != null) ? String(n8nNotice.pid) : null; %>
            <% const isNoticeRow = noticePid && String(pid) === noticePid; %>
            <tr>
              <td>
                <div class="gv-actions">
                  <a class="btn secondary icon" href="/pedidos/<%= pid %>" title="Ver" aria-label="Ver pedido <%= pid %>">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </a>
                  <% if (canWrite) { %>
                    <a class="btn secondary icon" href="/pedidos/<%= pid %>/edit" title="Editar" aria-label="Editar pedido <%= pid %>">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                      </svg>
                    </a>
                    <form method="post" action="/pedidos/<%= pid %>/enviar-n8n">
                      <button class="btn secondary icon <%= isNoticeRow ? (n8nNotice.ok ? 'success' : 'warn') : '' %>" type="submit" title="Enviar a N8N" aria-label="Enviar pedido <%= pid %> a N8N">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <path d="M22 2L11 13"></path>
                          <path d="M22 2l-7 20-4-9-9-4z"></path>
                        </svg>
                      </button>
                    </form>
                    <form method="post" action="/pedidos/<%= pid %>/delete" onsubmit="return confirm('¿Eliminar este pedido?');">
                      <button class="btn secondary icon danger" type="submit" title="Borrar" aria-label="Borrar pedido <%= pid %>">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <path d="M3 6h18"></path>
                          <path d="M8 6V4h8v2"></path>
                          <path d="M19 6l-1 14H6L5 6"></path>
                          <path d="M10 11v6"></path>
                          <path d="M14 11v6"></path>
                        </svg>
                      </button>
                    </form>
                  <% } %>
                </div>
              </td>
              <td><%= fmtDateES(p.FechaPedido ?? p.Fecha ?? '') %></td>
              <td><%= p.NumPedido ?? p.Numero_Pedido ?? '' %></td>
              <td><%= p.ClienteNombre ?? p.ClienteNombreCial ?? p.Nombre_Razon_Social ?? p.Nombre ?? (p.Id_Cliente ?? p.ClienteId ?? '') %></td>
              <td><%= p.NumPedidoCliente ?? p.Num_Pedido_Cliente ?? '' %></td>
              <td><%= p.NumAsociadoHefame ?? p.num_asociado_hefame ?? '—' %></td>
              <td><%= fmtEurES(p.TotalPedido ?? p.Total ?? 0) %></td>
              <td>
                <% const estadoLabel = String(p.EstadoPedidoNombre ?? p.EstadoPedido ?? p.Estado ?? '').trim(); %>
                <% const estadoColor = String(p.EstadoColor ?? '').trim().toLowerCase(); %>
                <% const st = estadoLabel.toLowerCase(); %>
                <% const cls = estadoColor || (st.includes('deneg') ? 'danger' : (st.includes('pagad') || st.includes('aprob') ? 'ok' : (st.includes('pend') ? 'warn' : 'info'))); %>
                <% if (estadoLabel) { %>
                  <span class="badge <%= cls %>"><%= estadoLabel %></span>
                <% } else { %>
                  —
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<%- include('partials/footer') %>

