<%- include('partials/header', { title: 'Pedidos' }) %>

<style>
  /* Spinner de carga (uso puntual en modales) */
  .gv-spinner{
    width: 16px;
    height: 16px;
    display: inline-block;
    border-radius: 999px;
    border: 2px solid rgba(255,255,255,.35);
    border-top-color: #fff;
    animation: gvSpin 0.9s linear infinite;
  }
  @keyframes gvSpin{ to{ transform: rotate(360deg); } }
  .gv-btn-loading{
    display:inline-flex;
    align-items:center;
    gap: 8px;
  }
</style>

<section class="card">
  <div class="card-hd">
    <h1 class="card-title">Pedidos</h1>
    <p class="card-subtitle">
      Año <strong><%= selectedYear ?? new Date().getFullYear() %></strong> · <%= items.length %> pedidos (vista ligera).
    </p>
  </div>
  <div class="card-bd">
    <%
      const toNum = (v, dflt = 0) => {
        if (v === null || v === undefined) return dflt;
        const s = String(v).trim();
        if (!s) return dflt;
        const n = Number(String(s).replace(',', '.'));
        return Number.isFinite(n) ? n : dflt;
      };
      const round2 = (n) => Math.round((Number(n) + Number.EPSILON) * 100) / 100;
      const itemsArr = Array.isArray(items) ? items : [];
      const estadoNorm = (p) => String(p?.EstadoPedidoNombre ?? p?.EstadoPedido ?? p?.Estado ?? '').trim().toLowerCase();
      const isPendiente = (p) => estadoNorm(p).includes('pend');
      const isEspecial = (p) => {
        const v = p?.EsEspecial ?? p?.es_especial ?? p?.especial ?? 0;
        return Number(v) === 1 || String(v).trim().toLowerCase() === 'true';
      };
      const especialEstado = (p) => String(p?.EspecialEstado ?? p?.especial_estado ?? '').trim().toLowerCase();
      const totalPedidoNum = (p) => toNum(p?.TotalPedido ?? p?.Total ?? p?.ImporteTotal ?? 0, 0);
      const ventasTotal = round2(itemsArr.reduce((s, p) => s + totalPedidoNum(p), 0));
      const ticketMedio = itemsArr.length ? round2(ventasTotal / itemsArr.length) : 0;
      const pendientesCount = itemsArr.filter(isPendiente).length;
      const especialesCount = itemsArr.filter(isEspecial).length;

      const groupSum = (rows, getKey, getValue) => {
        const map = new Map();
        (rows || []).forEach((r) => {
          const k = String(getKey(r) || '').trim() || '—';
          const cur = map.get(k) || { key: k, count: 0, sum: 0 };
          cur.count += 1;
          cur.sum += getValue(r);
          map.set(k, cur);
        });
        return Array.from(map.values()).sort((a, b) => b.sum - a.sum);
      };

      const byEstado = groupSum(itemsArr, (p) => (p?.EstadoPedidoNombre ?? p?.EstadoPedido ?? p?.Estado ?? '—'), totalPedidoNum);
      const byComercial = groupSum(itemsArr, (p) => (p?.ComercialNombre ?? p?.Id_Cial ?? p?.id_cial ?? '—'), totalPedidoNum);
      const byProvincia = groupSum(itemsArr, (p) => (p?.ProvinciaNombre ?? '—'), totalPedidoNum);
      const byTipoCliente = groupSum(itemsArr, (p) => (p?.TipoClienteNombre ?? '—'), totalPedidoNum);

      const incompletos = itemsArr.filter((p) => {
        const idDir = Number(p?.Id_DireccionEnvio ?? p?.id_direccion_envio ?? 0) || 0;
        const ref = String(p?.NumPedidoCliente ?? p?.Num_Pedido_Cliente ?? '').trim();
        const fp = Number(p?.Id_FormaPago ?? p?.id_forma_pago ?? 0) || 0;
        const tp = Number(p?.Id_TipoPedido ?? p?.id_tipo_pedido ?? 0) || 0;
        return (!idDir) || (!ref) || (!fp) || (!tp);
      });
      const pendientes = itemsArr.filter(isPendiente);
      const especialesPend = itemsArr.filter((p) => isEspecial(p) && (especialEstado(p) === 'pendiente' || especialEstado(p) === '' || especialEstado(p) === 'pending'));
    %>

    <div id="gvPedidosTabs">
      <div class="gv-form-actions-sticky gv-no-print" style="margin-bottom: 10px;">
        <div class="gv-form-actions-sticky__inner" style="flex-direction: column; align-items: stretch; gap: 10px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap:wrap;">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <a class="btn" href="/pedidos/new">Nuevo pedido</a>
              <a class="btn secondary" href="/pedidos?<%= `year=${encodeURIComponent(String(selectedYear ?? ''))}` %><%= selectedMarcaId ? `&marca=${encodeURIComponent(String(selectedMarcaId))}` : '' %>">Limpiar búsqueda</a>
            </div>
            <div style="color: var(--gv-muted); font-weight:800;">
              Total: <%= (typeof fmtEurES === 'function') ? fmtEurES(ventasTotal) : ventasTotal %>
            </div>
          </div>

          <% if (typeof n8nNotice !== 'undefined' && n8nNotice) { %>
            <div id="gv-n8n-notice" class="gv-alert <%= n8nNotice.ok ? 'success' : 'error' %>" style="margin: 0;">
              <div style="display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;">
                <div>
                  <strong><%= n8nNotice.ok ? 'Pedido enviado a N8N' : 'No se pudo enviar el pedido' %></strong>
                  <% if (n8nNotice.message) { %>
                    <div style="margin-top:6px; white-space:pre-wrap;"><%= n8nNotice.message %></div>
                  <% } %>
                </div>
                <% if (!n8nNotice.ok) { %>
                  <button type="button" class="btn secondary icon warn" id="gv-n8n-notice-close" title="Cerrar" aria-label="Cerrar mensaje">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M18 6L6 18"></path>
                      <path d="M6 6l12 12"></path>
                    </svg>
                  </button>
                <% } %>
              </div>
            </div>
            <script>
              (() => {
                const box = document.getElementById('gv-n8n-notice');
                if (!box) return;
                const isOk = <%= n8nNotice.ok ? 'true' : 'false' %>;
                if (isOk) {
                  window.setTimeout(() => {
                    if (box && box.parentNode) box.parentNode.removeChild(box);
                  }, 5000);
                  return;
                }
                const btn = document.getElementById('gv-n8n-notice-close');
                if (btn) {
                  btn.addEventListener('click', () => {
                    if (box && box.parentNode) box.parentNode.removeChild(box);
                  });
                }
              })();
            </script>
          <% } %>

          <form method="get" action="/pedidos" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 0;">
            <label for="year" style="font-weight:700; color: var(--gv-ink);">Año</label>
            <select id="year" name="year" class="gv-client-picker__q" style="width:auto; min-width: 140px;">
              <% (years || []).forEach((y) => { %>
                <option value="<%= y %>" <%= Number(selectedYear) === Number(y) ? 'selected' : '' %>><%= y %></option>
              <% }) %>
            </select>
            <label for="marca" style="font-weight:700; color: var(--gv-ink);">Marca</label>
            <select id="marca" name="marca" class="gv-client-picker__q" style="width:auto; min-width: 220px;">
              <option value="" <%= !selectedMarcaId ? 'selected' : '' %>>Todas</option>
              <% (marcas || []).forEach((m) => { %>
                <option value="<%= m.id %>" <%= Number(selectedMarcaId) === Number(m.id) ? 'selected' : '' %>><%= m.nombre ?? m.Nombre ?? m.marca ?? m.Marca ?? m.id %></option>
              <% }) %>
            </select>
            <label for="q" style="font-weight:700; color: var(--gv-ink);">Buscar</label>
            <input
              id="q"
              name="q"
              type="search"
              class="gv-client-picker__q"
              style="min-width: 260px; flex: 1 1 340px;"
              placeholder="Ej: provincia:Murcia comercial:Paco estado:pendiente · o texto libre"
              value="<%= typeof q === 'string' ? q : '' %>"
            />
            <button class="btn secondary" type="submit">Ver</button>
            <a class="btn secondary" href="/pedidos">Año actual</a>
          </form>

          <div class="gv-tabs" role="tablist" aria-label="Vistas de pedidos">
            <button type="button" class="gv-tab is-active" role="tab" aria-selected="true" aria-controls="tab_listado" data-tab="listado">Listado</button>
            <button type="button" class="gv-tab" role="tab" aria-selected="false" aria-controls="tab_resumen" data-tab="resumen">Resumen</button>
            <button type="button" class="gv-tab" role="tab" aria-selected="false" aria-controls="tab_seguimiento" data-tab="seguimiento">Seguimiento</button>
          </div>
        </div>
      </div>

      <section id="tab_listado" class="gv-tabpanel is-active" role="tabpanel" data-tabpanel="listado">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Estado</th>
                <th>Fecha</th>
                <th>PEDIDO</th>
                <th>Cliente</th>
                <th>Provincia</th>
                <th>Comercial</th>
                <th>Tipo cliente</th>
                <th>PEDIDO CLIENTE</th>
                <th>Nº Hefame</th>
                <th>Total</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <% itemsArr.forEach((p) => { %>
                <% const pid = p.Id ?? p.id; %>
                <% const owner = Number(p.Id_Cial ?? p.id_cial ?? p.ComercialId ?? p.comercialId ?? 0) || 0; %>
                <% const canWrite = admin || (userId && Number(userId) === owner); %>
                <% const noticePid = (typeof n8nNotice !== 'undefined' && n8nNotice && n8nNotice.pid != null) ? String(n8nNotice.pid) : null; %>
                <% const isNoticeRow = noticePid && String(pid) === noticePid; %>
                <tr>
                  <td>
                    <% const estadoLabel = String(p.EstadoPedidoNombre ?? p.EstadoPedido ?? p.Estado ?? '').trim(); %>
                    <% const estadoColor = String(p.EstadoColor ?? '').trim().toLowerCase(); %>
                    <% const st = estadoLabel.toLowerCase(); %>
                    <% const cls = estadoColor || (st.includes('deneg') ? 'danger' : (st.includes('pagad') || st.includes('aprob') ? 'ok' : (st.includes('pend') ? 'warn' : 'info'))); %>
                    <% const estadoId = Number(p.Id_EstadoPedido ?? p.id_estado_pedido ?? 0) || 0; %>
                    <% if (admin) { %>
                      <button
                        type="button"
                        id="gvEstadoBadge_<%= pid %>"
                        class="badge <%= estadoLabel ? cls : 'info' %> gv-pedido-estado-badge"
                        data-pid="<%= pid %>"
                        data-num="<%= (p.NumPedido ?? p.Numero_Pedido ?? pid) %>"
                        data-estado-id="<%= estadoId %>"
                        data-estado-label="<%= estadoLabel %>"
                        title="Hacer clic para modificar el estado del pedido"
                        style="appearance:none; border:0; cursor:pointer;"
                      ><%= estadoLabel || '—' %></button>
                    <% } else { %>
                      <% if (estadoLabel) { %>
                        <span class="badge <%= cls %>"><%= estadoLabel %></span>
                      <% } else { %>
                        —
                      <% } %>
                    <% } %>
                  </td>
                  <td><%= fmtDateES(p.FechaPedido ?? p.Fecha ?? '') %></td>
                  <td><%= p.NumPedido ?? p.Numero_Pedido ?? '' %></td>
                  <td><%= p.ClienteNombre ?? p.ClienteNombreCial ?? p.Nombre_Razon_Social ?? p.Nombre ?? (p.Id_Cliente ?? p.ClienteId ?? '') %></td>
                  <td><%= p.ProvinciaNombre ?? '—' %></td>
                  <td><%= p.ComercialNombre ?? (p.Id_Cial ?? p.id_cial ?? '—') %></td>
                  <td><%= p.TipoClienteNombre ?? '—' %></td>
                  <td><%= p.NumPedidoCliente ?? p.Num_Pedido_Cliente ?? '' %></td>
                  <td><%= p.NumAsociadoHefame ?? p.num_asociado_hefame ?? '—' %></td>
                  <td><%= fmtEurES(p.TotalPedido ?? p.Total ?? 0) %></td>
                  <td>
                    <div class="gv-actions">
                      <a class="btn secondary icon" href="/pedidos/<%= pid %>" title="Ver" aria-label="Ver pedido <%= pid %>">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"></path>
                          <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                      </a>
                      <% if (canWrite) { %>
                        <a class="btn secondary icon" href="/pedidos/<%= pid %>/edit" title="Editar" aria-label="Editar pedido <%= pid %>">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                          </svg>
                        </a>
                        <form method="post" action="/pedidos/<%= pid %>/enviar-n8n">
                          <button class="btn secondary icon <%= isNoticeRow ? (n8nNotice.ok ? 'success' : 'warn') : '' %>" type="submit" title="Enviar a N8N" aria-label="Enviar pedido <%= pid %> a N8N">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                              <path d="M22 2L11 13"></path>
                              <path d="M22 2l-7 20-4-9-9-4z"></path>
                            </svg>
                          </button>
                        </form>
                        <form method="post" action="/pedidos/<%= pid %>/delete" onsubmit="return confirm('¿Eliminar este pedido?');">
                          <button class="btn secondary icon danger" type="submit" title="Borrar" aria-label="Borrar pedido <%= pid %>">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                              <path d="M3 6h18"></path>
                              <path d="M8 6V4h8v2"></path>
                              <path d="M19 6l-1 14H6L5 6"></path>
                              <path d="M10 11v6"></path>
                              <path d="M14 11v6"></path>
                            </svg>
                          </button>
                        </form>
                      <% } %>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </section>

      <section id="tab_resumen" class="gv-tabpanel" role="tabpanel" data-tabpanel="resumen">
        <div class="dash-stats" style="margin-top: 4px;">
          <div class="dash-stat" data-variant="navy">
            <div class="dash-stat-label">Pedidos</div>
            <div class="dash-stat-value"><%= itemsArr.length %></div>
            <div class="dash-stat-foot">Resultados filtrados</div>
          </div>
          <div class="dash-stat" data-variant="yellow">
            <div class="dash-stat-label">Ventas</div>
            <div class="dash-stat-value"><%= fmtEurES(ventasTotal) %></div>
            <div class="dash-stat-foot">Suma de totales</div>
          </div>
          <div class="dash-stat" data-variant="blue">
            <div class="dash-stat-label">Ticket medio</div>
            <div class="dash-stat-value"><%= fmtEurES(ticketMedio) %></div>
            <div class="dash-stat-foot">Media por pedido</div>
          </div>
          <div class="dash-stat" data-variant="green">
            <div class="dash-stat-label">Pendientes</div>
            <div class="dash-stat-value"><%= pendientesCount %></div>
            <div class="dash-stat-foot"><%= itemsArr.length ? `${Math.round((pendientesCount / itemsArr.length) * 100)}%` : '—' %></div>
          </div>
          <div class="dash-stat" data-variant="navy">
            <div class="dash-stat-label">Especiales</div>
            <div class="dash-stat-value"><%= especialesCount %></div>
            <div class="dash-stat-foot"><%= itemsArr.length ? `${Math.round((especialesCount / itemsArr.length) * 100)}%` : '—' %></div>
          </div>
        </div>

        <div class="dash-grid" style="margin-top: 14px;">
          <section class="card dash-card">
            <div class="card-hd">
              <h2 class="card-title">Por estado</h2>
              <p class="card-subtitle">Pedidos y ventas</p>
            </div>
            <div class="card-bd">
              <div class="table-wrap">
                <table class="dash-table">
                  <thead><tr><th>Estado</th><th>Pedidos</th><th>Ventas</th></tr></thead>
                  <tbody>
                    <% (byEstado || []).forEach((r) => { %>
                      <tr>
                        <td><%= r.key %></td>
                        <td><%= r.count %></td>
                        <td><%= fmtEurES(round2(r.sum)) %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="card dash-card">
            <div class="card-hd">
              <h2 class="card-title">Por comercial</h2>
              <p class="card-subtitle">Top por ventas</p>
            </div>
            <div class="card-bd">
              <div class="table-wrap">
                <table class="dash-table">
                  <thead><tr><th>Comercial</th><th>Pedidos</th><th>Ventas</th></tr></thead>
                  <tbody>
                    <% (byComercial || []).slice(0, 12).forEach((r) => { %>
                      <tr>
                        <td><%= r.key %></td>
                        <td><%= r.count %></td>
                        <td><%= fmtEurES(round2(r.sum)) %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="card dash-card">
            <div class="card-hd">
              <h2 class="card-title">Por provincia</h2>
              <p class="card-subtitle">Top por ventas</p>
            </div>
            <div class="card-bd">
              <div class="table-wrap">
                <table class="dash-table">
                  <thead><tr><th>Provincia</th><th>Pedidos</th><th>Ventas</th></tr></thead>
                  <tbody>
                    <% (byProvincia || []).slice(0, 12).forEach((r) => { %>
                      <tr>
                        <td><%= r.key %></td>
                        <td><%= r.count %></td>
                        <td><%= fmtEurES(round2(r.sum)) %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="card dash-card">
            <div class="card-hd">
              <h2 class="card-title">Por tipo de cliente</h2>
              <p class="card-subtitle">Top por ventas</p>
            </div>
            <div class="card-bd">
              <div class="table-wrap">
                <table class="dash-table">
                  <thead><tr><th>Tipo</th><th>Pedidos</th><th>Ventas</th></tr></thead>
                  <tbody>
                    <% (byTipoCliente || []).slice(0, 12).forEach((r) => { %>
                      <tr>
                        <td><%= r.key %></td>
                        <td><%= r.count %></td>
                        <td><%= fmtEurES(round2(r.sum)) %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </div>
      </section>

      <section id="tab_seguimiento" class="gv-tabpanel" role="tabpanel" data-tabpanel="seguimiento">
        <div class="grid cols-2" style="gap: 12px;">
          <section class="card">
            <div class="card-hd">
              <h2 class="card-title">Pendientes</h2>
              <p class="card-subtitle"><%= pendientes.length %> pedidos</p>
            </div>
            <div class="card-bd">
              <div class="table-wrap">
                <table>
                  <thead><tr><th>Fecha</th><th>Pedido</th><th>Cliente</th><th>Total</th></tr></thead>
                  <tbody>
                    <% (pendientes || []).slice(0, 20).forEach((p) => { %>
                      <% const pid = p.Id ?? p.id; %>
                      <tr>
                        <td><%= fmtDateES(p.FechaPedido ?? p.Fecha ?? '') %></td>
                        <td><a href="/pedidos/<%= pid %>"><%= p.NumPedido ?? p.Numero_Pedido ?? pid %></a></td>
                        <td><%= p.ClienteNombre ?? p.ClienteNombreCial ?? p.Nombre_Razon_Social ?? p.Nombre ?? (p.Id_Cliente ?? p.ClienteId ?? '') %></td>
                        <td><%= fmtEurES(p.TotalPedido ?? p.Total ?? 0) %></td>
                      </tr>
                    <% }) %>
                    <% if (!pendientes.length) { %>
                      <tr><td colspan="4" style="color: var(--gv-muted); font-weight:800;">Sin pendientes.</td></tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="card">
            <div class="card-hd">
              <h2 class="card-title">Especiales (pendientes)</h2>
              <p class="card-subtitle"><%= especialesPend.length %> pedidos</p>
            </div>
            <div class="card-bd">
              <div class="table-wrap">
                <table>
                  <thead><tr><th>Fecha</th><th>Pedido</th><th>Cliente</th><th>Estado</th></tr></thead>
                  <tbody>
                    <% (especialesPend || []).slice(0, 20).forEach((p) => { %>
                      <% const pid = p.Id ?? p.id; %>
                      <tr>
                        <td><%= fmtDateES(p.FechaPedido ?? p.Fecha ?? '') %></td>
                        <td><a href="/pedidos/<%= pid %>"><%= p.NumPedido ?? p.Numero_Pedido ?? pid %></a></td>
                        <td><%= p.ClienteNombre ?? p.ClienteNombreCial ?? p.Nombre_Razon_Social ?? p.Nombre ?? (p.Id_Cliente ?? p.ClienteId ?? '') %></td>
                        <td><%= (p.EspecialEstado ?? p.especial_estado ?? 'pendiente') %></td>
                      </tr>
                    <% }) %>
                    <% if (!especialesPend.length) { %>
                      <tr><td colspan="4" style="color: var(--gv-muted); font-weight:800;">Sin especiales pendientes.</td></tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </div>

        <section class="card" style="margin-top: 12px;">
          <div class="card-hd">
            <h2 class="card-title">Incompletos</h2>
            <p class="card-subtitle">Faltan datos clave (dirección, referencia cliente, forma de pago o tipo)</p>
          </div>
          <div class="card-bd">
            <div class="table-wrap">
              <table>
                <thead><tr><th>Fecha</th><th>Pedido</th><th>Cliente</th><th>Faltan</th></tr></thead>
                <tbody>
                  <% (incompletos || []).slice(0, 30).forEach((p) => { %>
                    <%
                      const pid = p.Id ?? p.id;
                      const idDir = Number(p?.Id_DireccionEnvio ?? p?.id_direccion_envio ?? 0) || 0;
                      const ref = String(p?.NumPedidoCliente ?? p?.Num_Pedido_Cliente ?? '').trim();
                      const fp = Number(p?.Id_FormaPago ?? p?.id_forma_pago ?? 0) || 0;
                      const tp = Number(p?.Id_TipoPedido ?? p?.id_tipo_pedido ?? 0) || 0;
                      const faltan = [];
                      if (!idDir) faltan.push('Dirección envío');
                      if (!ref) faltan.push('Ref. cliente');
                      if (!fp) faltan.push('Forma pago');
                      if (!tp) faltan.push('Tipo pedido');
                    %>
                    <tr>
                      <td><%= fmtDateES(p.FechaPedido ?? p.Fecha ?? '') %></td>
                      <td><a href="/pedidos/<%= pid %>"><%= p.NumPedido ?? p.Numero_Pedido ?? pid %></a></td>
                      <td><%= p.ClienteNombre ?? p.ClienteNombreCial ?? p.Nombre_Razon_Social ?? p.Nombre ?? (p.Id_Cliente ?? p.ClienteId ?? '') %></td>
                      <td><%= faltan.join(' · ') || '—' %></td>
                    </tr>
                  <% }) %>
                  <% if (!incompletos.length) { %>
                    <tr><td colspan="4" style="color: var(--gv-muted); font-weight:800;">Sin incompletos.</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </section>

      <% if (admin && Array.isArray(estadosPedido) && estadosPedido.length) { %>
        <!-- Modal: seleccionar estado -->
        <div id="gv-estado-backdrop" class="gv-modal-backdrop" hidden></div>
        <div id="gv-estado-modal" class="gv-modal" hidden role="dialog" aria-modal="true" aria-labelledby="gv-estado-title">
          <div class="gv-modal-card">
            <div class="gv-modal-hd">
              <div class="gv-modal-title" id="gv-estado-title">Cambiar estado del pedido</div>
              <div class="gv-modal-subtitle">Selecciona el nuevo estado para el pedido <span id="gv-estado-pedido-num">—</span>.</div>
            </div>
            <div style="padding: 14px 16px; display:grid; gap: 10px;">
              <label style="display:grid; gap: 6px;">
                <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Nuevo estado</span>
                <select id="gv-estado-select" class="gv-client-picker__q">
                  <% (estadosPedido || []).forEach((e) => { %>
                    <option value="<%= e.id %>" data-color="<%= e.color %>"><%= e.nombre %></option>
                  <% }) %>
                </select>
              </label>
              <div id="gv-estado-error" class="gv-alert gv-alert--warn" style="display:none;"></div>
            </div>
            <div class="gv-modal-actions">
              <button type="button" class="btn secondary" id="gv-estado-cancel">Cerrar</button>
              <button type="button" class="btn" id="gv-estado-next">Guardar</button>
            </div>
          </div>
        </div>

        <!-- Modal: confirmación -->
        <div id="gv-estado-confirm-backdrop" class="gv-modal-backdrop" hidden></div>
        <div id="gv-estado-confirm-modal" class="gv-modal" hidden role="dialog" aria-modal="true" aria-labelledby="gv-estado-confirm-title">
          <div class="gv-modal-card">
            <div class="gv-modal-hd">
              <div class="gv-modal-title" id="gv-estado-confirm-title">Confirmar cambio</div>
              <div class="gv-modal-subtitle">¿Seguro que quieres cambiar el estado del pedido <span id="gv-estado-confirm-pedido-num">—</span> a <b id="gv-estado-confirm-nombre">—</b>?</div>
            </div>
            <div class="gv-modal-actions">
              <button type="button" class="btn secondary" id="gv-estado-confirm-cancel">Cerrar</button>
              <button type="button" class="btn" id="gv-estado-confirm-accept">
                <span class="gv-btn-loading">
                  <span class="gv-spinner" id="gv-estado-spinner" style="display:none;" aria-hidden="true"></span>
                  <span id="gv-estado-accept-label">Aceptar</span>
                </span>
              </button>
            </div>
          </div>
        </div>

        <script>
        (function () {
          var root = document.getElementById('gvPedidosTabs');
          if (!root) return;

          var modal = document.getElementById('gv-estado-modal');
          var backdrop = document.getElementById('gv-estado-backdrop');
          var select = document.getElementById('gv-estado-select');
          var errBox = document.getElementById('gv-estado-error');
          var pedidoNumSpan = document.getElementById('gv-estado-pedido-num');
          var btnCancel = document.getElementById('gv-estado-cancel');
          var btnNext = document.getElementById('gv-estado-next');

          var cModal = document.getElementById('gv-estado-confirm-modal');
          var cBackdrop = document.getElementById('gv-estado-confirm-backdrop');
          var cPedidoNum = document.getElementById('gv-estado-confirm-pedido-num');
          var cNombre = document.getElementById('gv-estado-confirm-nombre');
          var cCancel = document.getElementById('gv-estado-confirm-cancel');
          var cAccept = document.getElementById('gv-estado-confirm-accept');
          var cSpinner = document.getElementById('gv-estado-spinner');
          var cAcceptLabel = document.getElementById('gv-estado-accept-label');

          if (!modal || !backdrop || !select || !btnCancel || !btnNext || !cModal || !cBackdrop || !cCancel || !cAccept) return;

          var currentPid = null;
          var currentPedidoNum = '';
          var currentBadge = null;
          var isSaving = false;

          function setSaving(on) {
            isSaving = !!on;
            cAccept.disabled = isSaving;
            cCancel.disabled = isSaving;
            if (cSpinner) cSpinner.style.display = isSaving ? 'inline-block' : 'none';
            if (cAcceptLabel) cAcceptLabel.textContent = isSaving ? 'Guardando...' : 'Aceptar';
          }

          function openSelectModal(pid, pedidoNum, curEstadoId) {
            currentPid = pid;
            currentPedidoNum = pedidoNum || String(pid);
            pedidoNumSpan.textContent = currentPedidoNum;
            if (errBox) { errBox.style.display = 'none'; errBox.textContent = ''; }

            // preselección por ID si existe
            if (curEstadoId) {
              select.value = String(curEstadoId);
            } else if (select.options && select.options.length) {
              select.selectedIndex = 0;
            }

            backdrop.hidden = false;
            modal.hidden = false;
          }
          function closeSelectModal(resetState) {
            modal.hidden = true;
            backdrop.hidden = true;
            if (resetState) {
              currentPid = null;
              currentPedidoNum = '';
              currentBadge = null;
            }
          }

          function openConfirmModal(pedidoNum, estadoNombre) {
            cPedidoNum.textContent = pedidoNum || '—';
            cNombre.textContent = estadoNombre || '—';
            cBackdrop.hidden = false;
            cModal.hidden = false;
          }
          function closeConfirmModal() {
            cModal.hidden = true;
            cBackdrop.hidden = true;
          }

          btnCancel.addEventListener('click', function () {
            closeSelectModal(true);
          });
          backdrop.addEventListener('click', function () {
            closeSelectModal(true);
          });
          btnNext.addEventListener('click', function () {
            if (!currentPid) return;
            var opt = select.options[select.selectedIndex];
            var estadoNombre = opt ? (opt.textContent || '').trim() : '';
            var pedidoNum = currentPedidoNum || (pedidoNumSpan ? pedidoNumSpan.textContent : String(currentPid));
            closeSelectModal(false);
            openConfirmModal(pedidoNum, estadoNombre);
          });

          cCancel.addEventListener('click', function () {
            if (isSaving) return;
            closeConfirmModal();
            currentPid = null;
            currentPedidoNum = '';
            currentBadge = null;
          });
          cBackdrop.addEventListener('click', function () {
            if (isSaving) return;
            closeConfirmModal();
            currentPid = null;
            currentPedidoNum = '';
            currentBadge = null;
          });

          cAccept.addEventListener('click', async function () {
            if (!currentBadge) { closeConfirmModal(); return; }
            var pid = currentBadge.getAttribute('data-pid');
            var estadoId = select.value;
            var opt = select.options[select.selectedIndex];
            var estadoNombre = opt ? (opt.textContent || '').trim() : '';

            try {
              setSaving(true);
              var r = await fetch('/pedidos/' + encodeURIComponent(pid) + '/estado', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ estadoId: estadoId })
              });
              var json = await r.json().catch(function () { return null; });
              if (!r.ok || !json || !json.ok) {
                throw new Error((json && json.error) ? json.error : ('HTTP ' + r.status));
              }
              var color = (json.estado && json.estado.color) ? String(json.estado.color) : 'info';
              var nombre = (json.estado && json.estado.nombre) ? String(json.estado.nombre) : (estadoNombre || '—');

              currentBadge.textContent = nombre;
              currentBadge.setAttribute('data-estado-id', String(json.estado.id || estadoId || ''));
              currentBadge.setAttribute('data-estado-label', nombre);
              currentBadge.classList.remove('ok', 'info', 'warn', 'danger');
              currentBadge.classList.add(color || 'info');

              closeConfirmModal();
              currentPid = null;
              currentPedidoNum = '';
              currentBadge = null;
            } catch (e) {
              // Reabrir selector mostrando error
              closeConfirmModal();
              if (errBox) {
                errBox.textContent = 'No se pudo cambiar el estado. ' + (e && e.message ? e.message : '');
                errBox.style.display = 'block';
              }
              // Volver a abrir el modal de selección para que el admin pueda reintentar
              backdrop.hidden = false;
              modal.hidden = false;
              if (pedidoNumSpan) pedidoNumSpan.textContent = currentPedidoNum || (pid || '—');
            } finally {
              setSaving(false);
            }
          });

          root.addEventListener('click', function (ev) {
            var btn = ev.target && ev.target.closest ? ev.target.closest('button.gv-pedido-estado-badge[data-pid]') : null;
            if (!btn) return;
            currentBadge = btn;
            var pid = btn.getAttribute('data-pid');
            var pedidoNum = btn.getAttribute('data-num') || '';
            var curEstadoId = Number(btn.getAttribute('data-estado-id') || 0) || 0;
            openSelectModal(pid, pedidoNum, curEstadoId);
          });
        })();
        </script>
      <% } %>
    </div>
  </div>
</section>

<script>
(function () {
  var root = document.getElementById('gvPedidosTabs');
  if (!root) return;
  var tabButtons = Array.prototype.slice.call(root.querySelectorAll('.gv-tab[data-tab]'));
  var panels = Array.prototype.slice.call(root.querySelectorAll('.gv-tabpanel[data-tabpanel]'));
  if (!tabButtons.length || !panels.length) return;
  function setTab(id) {
    tabButtons.forEach(function (b) {
      var active = b.getAttribute('data-tab') === id;
      b.classList.toggle('is-active', active);
      b.setAttribute('aria-selected', active ? 'true' : 'false');
    });
    panels.forEach(function (p) {
      var active = p.getAttribute('data-tabpanel') === id;
      p.classList.toggle('is-active', active);
    });
  }
  tabButtons.forEach(function (b) {
    b.addEventListener('click', function () {
      setTab(b.getAttribute('data-tab'));
    });
  });
  var hash = String(window.location.hash || '').replace('#', '').trim().toLowerCase();
  if (hash === 'listado' || hash === 'resumen' || hash === 'seguimiento') setTab(hash);
})();
</script>

<%- include('partials/footer') %>

