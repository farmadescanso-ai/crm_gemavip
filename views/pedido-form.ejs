<%- include('partials/header', { title: mode === 'edit' ? 'Editar pedido' : 'Nuevo pedido' }) %>
<% var isAdminForm = !!(typeof user !== 'undefined' && user && (user.roles || []).some(function(r){ return String(r).toLowerCase().indexOf('admin') !== -1; })); %>

<section class="card gv-pedido-form">
  <div class="card-hd">
    <h1 class="card-title">
      <%= mode === 'edit' ? 'Editar pedido' : 'Nuevo pedido' %>
      <% if (mode === 'edit') { %>
        · <span style="font-weight:900;"><%= item.NumPedido ?? '' %></span>
      <% } %>
    </h1>
    <p class="card-subtitle">Cabecera + líneas. Al guardar, recalculamos base/IVA/total con la tarifa.</p>
  </div>
  <div class="card-bd">
    <% if (error) { %>
      <div class="gv-alert gv-alert--warn"><%= error %></div>
      <div style="height: 10px;"></div>
    <% } %>

    <form
      id="pedidoForm"
      method="post"
      action="<%= mode === 'edit' ? ('/pedidos/' + (item.id || item.Id) + '/edit') : '/pedidos/new' %>"
      class="gv-pedido-form__form"
    >
      <!-- Serie fija -->
      <input type="hidden" name="Serie" value="P" />

      <div class="gv-doc">
        <div class="gv-doc__title">
          <h2>Cabecera</h2>
          <div class="gv-doc__meta">
            <% if (mode === 'edit') { %>
              <span>Nº <%= item.NumPedido ?? '' %></span>
            <% } %>
            <span>Serie P</span>
          </div>
        </div>
        <div style="height: 10px;"></div>

      <div class="gv-doc__grid gv-doc__grid--cabecera">
        <label class="gv-field">
          <span class="gv-field__label">Comercial * <button type="button" class="gv-field-info" aria-label="Información" data-info="<%= isAdminForm ? 'Puedes cambiar el comercial del pedido manualmente.' : 'Se asigna automáticamente según el cliente seleccionado.' %>"></button></span>
          <% const curCial = Number(item.Id_Cial ?? item.ComercialId ?? item.Id_Comercial ?? 0) || 0; %>
          <input type="hidden" name="Id_Cial" id="Id_Cial" value="<%= curCial || '' %>" />
          <select <%= isAdminForm ? '' : 'disabled' %> class="gv-input" id="Id_Cial__display">
            <option value="">(selecciona)</option>
            <% (comerciales || []).forEach((c) => { %>
              <% const cid = Number(c.id ?? c.Id ?? 0) || 0; %>
              <option value="<%= cid %>" <%= cid === curCial ? 'selected' : '' %>><%= c.Nombre ?? '' %> (<%= c.Email || c.email || '' %>)</option>
            <% }) %>
          </select>
        </label>

        <label class="gv-field">
          <span class="gv-field__label">Cliente * <button type="button" class="gv-field-info" aria-label="Información" data-info="Escribe al menos 3 letras (o un ID numérico) y selecciona un resultado."></button></span>
          <div class="gv-client-picker" data-client-picker>
            <input
              type="search"
              class="gv-client-picker__q"
              placeholder="Buscar cliente (nombre, CIF, email, teléfono, CP o ID...)"
              autocomplete="off"
              value="<%= (typeof clienteLabel === 'string' ? clienteLabel : '') %>"
            />
            <div class="gv-client-picker__results" hidden></div>
            <input id="Id_Cliente" name="Id_Cliente" type="hidden" class="gv-client-picker__id" value="<%= item.Id_Cliente ?? '' %>" />
            <div id="pedidoAutosave" class="gv-field__help" style="display:none;"></div>
            <label class="gv-recent-toggle">
              <input type="checkbox" id="showRecentToggle" autocomplete="off" />
              <span class="gv-recent-toggle__slider"></span>
              <span class="gv-recent-toggle__label">Mostrar clientes recientes</span>
            </label>
            <div class="gv-client-picker__recent" style="display:none;">
              <div style="font-weight:700; margin-bottom:6px;">Recientes:</div>
              <div style="display:flex; flex-wrap:wrap; gap:6px;">
                <% (clientes || []).slice(0, 10).forEach((c) => { %>
                  <button class="btn secondary" type="button" data-client-pick="<%= c.Id %>" data-client-label="<%= c.Nombre_Razon_Social %>" style="padding: 6px 10px; border-radius: 999px;">
                    <%= c.Id %> · <%= c.Nombre_Razon_Social %>
                  </button>
                <% }) %>
              </div>
            </div>
          </div>
        </label>

        <label class="gv-field">
          <span class="gv-field__label">Tarifa <button type="button" class="gv-field-info" aria-label="Información" data-info="Si la tarifa o el tipo de pedido incluye &quot;Transfer&quot;, el pedido no se valora: PVL=0 y dto línea 5% por defecto (informativo, editable)."></button></span>
          <select id="Id_Tarifa" name="Id_Tarifa" class="gv-input">
            <% const curTar = Number(item.Id_Tarifa ?? 0) || 0; %>
            <% (tarifas || []).forEach((t) => { %>
              <% const tid = Number(t.Id ?? t.id ?? 0) || 0; %>
              <% const label = t.NombreTarifa ?? t.Nombre ?? t.nombre ?? ('Tarifa ' + tid); %>
              <option value="<%= tid %>" data-label="<%= label %>" <%= tid === curTar ? 'selected' : '' %>><%= tid %> · <%= label %></option>
            <% }) %>
          </select>
        </label>

        <label class="gv-field">
          <span class="gv-field__label">Nº Pedido Cliente <button type="button" class="gv-field-info" aria-label="Información" data-info="Referencia del pedido del cliente (si aplica)."></button></span>
          <input class="gv-input" name="NumPedidoCliente" value="<%= item.NumPedidoCliente ?? item.Num_Pedido_Cliente ?? '' %>" placeholder="Ej: PO-12345" />
        </label>

        <label class="gv-field gv-field--full">
          <span class="gv-field__label">Dirección de envío <button type="button" class="gv-field-info" aria-label="Información" id="Id_DireccionEnvioInfoBtn" data-info="Si el cliente tiene más de una, selecciona una."></button></span>
          <select class="gv-input" name="Id_DireccionEnvio" id="Id_DireccionEnvio" data-existing="<%= item.Id_DireccionEnvio ?? '' %>">
            <option value="">(por defecto)</option>
          </select>
          <span class="gv-field__help gv-field__help--hidden" id="Id_DireccionEnvioHelp">Si el cliente tiene más de una, selecciona una.</span>
        </label>
      </div>
      </div>

      <div class="gv-doc">
        <div class="gv-doc__title"><h2>Fechas y estado</h2></div>
        <div style="height: 10px;"></div>
      <div class="gv-doc__grid">
        <label class="gv-field">
          <span class="gv-field__label">Estado del pedido *</span>
          <input name="EstadoPedido" required class="gv-input" value="<%= item.EstadoPedido ?? 'Pendiente' %>" />
        </label>
        <label class="gv-field">
          <span class="gv-field__label">Fecha del pedido</span>
          <input name="FechaPedido" type="date" class="gv-input" value="<%= fmtDateISO(item.FechaPedido ?? '') %>" />
        </label>
      </div>
      </div>

      <div class="gv-doc">
        <div class="gv-doc__title"><h2>Pago y tipo</h2></div>
        <div style="height: 10px;"></div>
      <div class="gv-doc__grid">
        <label class="gv-field">
          <span class="gv-field__label">Fecha de entrega</span>
          <input name="FechaEntrega" type="date" class="gv-input" value="<%= fmtDateISO(item.FechaEntrega ?? '') %>" />
        </label>
        <label class="gv-field">
          <span class="gv-field__label">Forma de pago</span>
          <% if ((formasPago || []).length) { %>
            <select name="Id_FormaPago" class="gv-input">
              <% const curFP = Number(item.Id_FormaPago ?? 0) || 0; %>
              <option value="0" <%= curFP === 0 ? 'selected' : '' %>>Sin especificar</option>
              <% (formasPago || []).forEach((fp) => { %>
                <% const fid = Number(fp.id ?? fp.Id ?? 0) || 0; %>
                <option value="<%= fid %>" <%= fid === curFP ? 'selected' : '' %>><%= fp.Nombre ?? fp.FormaPago ?? fp.nombre ?? '' %></option>
              <% }) %>
            </select>
          <% } else { %>
            <input name="Id_FormaPago" type="number" min="0" class="gv-input" value="<%= item.Id_FormaPago ?? 0 %>" />
          <% } %>
        </label>
        <label class="gv-field">
          <span class="gv-field__label">Tipo de pedido</span>
          <% if ((tiposPedido || []).length) { %>
            <select name="Id_TipoPedido" class="gv-input">
              <% const curTP = Number(item.Id_TipoPedido ?? 0) || 0; %>
              <option value="0" <%= curTP === 0 ? 'selected' : '' %>>Sin especificar</option>
              <% (tiposPedido || []).forEach((tp) => { %>
                <% const tid = Number(tp.id ?? tp.Id ?? 0) || 0; %>
                <option value="<%= tid %>" <%= tid === curTP ? 'selected' : '' %>><%= tp.Nombre ?? tp.Tipo ?? tp.nombre ?? tp.tipo ?? '' %></option>
              <% }) %>
            </select>
          <% } else { %>
            <input name="Id_TipoPedido" type="number" min="0" class="gv-input" value="<%= item.Id_TipoPedido ?? 0 %>" />
          <% } %>
        </label>
      </div>
      </div>

      <div class="gv-doc">
      <label class="gv-field" style="margin:0;">
        <span class="gv-field__label">Observaciones</span>
        <textarea name="Observaciones" rows="3"><%= item.Observaciones ?? '' %></textarea>
      </label>
      </div>

      <div class="card" style="padding: 12px;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap:wrap;">
          <div style="font-weight: 900;">Líneas</div>
          <button class="btn secondary" type="button" id="addLineaBtn">Añadir línea</button>
        </div>
        <div style="height: 10px;"></div>
        <div class="table-wrap">
          <table id="lineasTable">
            <thead>
              <tr>
                <th class="gv-lineas-col-art">Artículo</th>
                <th class="gv-lineas-col-num">PVL</th>
                <th class="gv-lineas-col-num">Cantidad</th>
                <th class="gv-lineas-col-num">Dto (%)</th>
                <th class="gv-lineas-col-total">Total línea</th>
                <th class="gv-lineas-col-btn"></th>
              </tr>
            </thead>
            <tbody>
              <% (lineas || []).forEach((l, idx) => { %>
                <tr>
                  <td>
                    <select name="lineas[<%= idx %>][Id_Articulo]" required>
                      <option value="">(selecciona)</option>
                      <% const curA = String(l.Id_Articulo ?? ''); %>
                      <% (articulos || []).forEach((a) => { %>
                        <% const aid = String(a.Id ?? a.id ?? ''); %>
                        <option value="<%= aid %>" data-pvl="<%= a.PVL ?? a.pvl ?? '' %>" data-iva="<%= a.IVA ?? a.iva ?? '' %>" <%= aid === curA ? 'selected' : '' %>><%= aid %> · <%= a.SKU ?? '' %> · <%= a.Nombre ?? '' %></option>
                      <% }) %>
                    </select>
                  </td>
                  <td><input class="gv-line-pvl" name="lineas[<%= idx %>][PrecioUnitario]" type="number" min="0" step="0.01" value="<%= l.PrecioUnitario ?? l.Precio ?? '' %>" placeholder="auto" /></td>
                  <td><input name="lineas[<%= idx %>][Cantidad]" type="number" min="0" step="0.01" value="<%= l.Cantidad ?? 1 %>" /></td>
                  <td><input class="gv-line-dto" name="lineas[<%= idx %>][Dto]" type="number" min="0" max="100" step="0.01" value="<%= l.Dto ?? '' %>" placeholder="auto" /></td>
                  <td style="text-align:right; font-weight:900;" class="gv-line-total">—</td>
                  <td>
                    <button class="btn icon gv-btn-trash" type="button" data-remove-linea title="Quitar línea" aria-label="Quitar línea">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                  </td>
                </tr>
              <% }) %>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="4" style="text-align:right; font-weight:900;">Subtotal</td>
                <td style="text-align:right; font-weight:900;" id="subtotalCell">—</td>
                <td></td>
              </tr>
              <tr class="gv-totals-dto-row">
                <td colspan="3" style="text-align:right; font-weight:900;">Dto pedido (%)</td>
                <td style="text-align:right;"><input type="number" name="Dto" id="DtoPedidoInput" class="gv-input gv-dto-pedido-input" min="0" max="100" step="0.01" value="<%= item.Dto ?? item.Descuento ?? 0 %>" title="Se aplica sobre el Subtotal" /></td>
                <td style="text-align:right; font-weight:700;" id="dtoPedidoAmountCell">—</td>
                <td></td>
              </tr>
              <tr>
                <td colspan="4" style="text-align:right; font-weight:900;">Total pedido</td>
                <td style="text-align:right; font-weight:900;" id="totalGeneralCell">—</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="gv-pedido-form__actions">
        <a class="btn secondary" href="/pedidos">Cancelar</a>
        <button class="btn" type="submit"><%= mode === 'edit' ? 'Guardar' : 'Crear' %></button>
      </div>
    </form>
  </div>
</section>

<div id="gvInfoBubble" class="gv-field-info__bubble" role="tooltip" aria-hidden="true" style="display:none;"></div>
<script>
  (function () {
    var table = document.getElementById('lineasTable');
    var btn = document.getElementById('addLineaBtn');
    var form = document.getElementById('pedidoForm');
    var selTarifa = document.getElementById('Id_Tarifa');
    var dtoPedidoEl = document.getElementById('DtoPedidoInput') || (form ? form.querySelector('input[name=\"Dto\"]') : null);
    var selDirEnvio = document.getElementById('Id_DireccionEnvio');
    var helpDirEnvio = document.getElementById('Id_DireccionEnvioHelp');
    var hidCial = document.getElementById('Id_Cial');
    var selCialDisplay = document.getElementById('Id_Cial__display');
    var hidCliente = document.getElementById('Id_Cliente');
    var autosaveEl = document.getElementById('pedidoAutosave');
    if (!table || !btn) return;

    document.querySelectorAll('.gv-field-info').forEach(function(btnInfo){
      btnInfo.addEventListener('click', function(e){
        e.preventDefault();
        var bubble = document.getElementById('gvInfoBubble');
        var text = btnInfo.getAttribute('data-info') || '';
        if (!bubble) return;
        if (bubble.style.display === 'block' && bubble.getAttribute('data-from') === String(btnInfo)) {
          bubble.style.display = 'none';
          bubble.setAttribute('aria-hidden', 'true');
          return;
        }
        bubble.textContent = text;
        bubble.setAttribute('data-from', String(btnInfo));
        bubble.style.display = 'block';
        bubble.setAttribute('aria-hidden', 'false');
        var rect = btnInfo.getBoundingClientRect();
        bubble.style.left = rect.left + 'px';
        bubble.style.top = (rect.bottom + 4) + 'px';
      });
    });
    document.addEventListener('click', function(e){
      var bubble = document.getElementById('gvInfoBubble');
      if (bubble && bubble.style.display === 'block' && !e.target.closest('.gv-field-info') && !e.target.closest('#gvInfoBubble')) {
        bubble.style.display = 'none';
        bubble.setAttribute('aria-hidden', 'true');
      }
    });

    var firstSelect = table.querySelector('tbody select');
    var optionsHTML = firstSelect ? firstSelect.innerHTML : '<option value="">(selecciona)</option>';
    var canEdit = String('<%= (typeof canEdit !== "undefined" && canEdit) ? "1" : "0" %>') === '1';
    var isEditMode = String('<%= mode === "edit" ? "1" : "0" %>') === '1';
    var isAdmin = String('<%= (user?.roles || []).some(r => String(r).toLowerCase().includes("admin")) ? "1" : "0" %>') === '1';

    var defaultDto = 0;
    function clampPct(n){ n = Number(n); if (!isFinite(n)) n = 0; return Math.max(0, Math.min(100, n)); }
    function getTarifaId(){ return selTarifa ? (parseInt(String(selTarifa.value||'0'),10) || 0) : 0; }

    function markManual(el){
      if (!el) return;
      el.setAttribute('data-manual', '1');
    }
    function isManual(el){
      return !!(el && String(el.getAttribute('data-manual') || '') === '1');
    }

    table.querySelectorAll('input.gv-line-pvl').forEach(function (i) { i.addEventListener('input', function(){ markManual(i); }); });
    if (selTarifa) selTarifa.addEventListener('change', function(){ markManual(selTarifa); refreshPrecios(); });

    function setIfNotManual(selectEl, value){
      if (!selectEl) return;
      if (isManual(selectEl)) return;
      if (value === null || value === undefined || String(value).trim() === '') return;
      // Solo aplicar si está vacío (no pisar selección existente al editar)
      if (String(selectEl.value || '').trim() !== '') return;
      selectEl.value = String(value);
    }

    function setCial(value){
      if (value === null || value === undefined || String(value).trim() === '') return;
      // Si el admin ha seleccionado manualmente, no pisar su elección al cambiar cliente.
      if (isAdmin && selCialDisplay && isManual(selCialDisplay)) return;
      if (hidCial) hidCial.value = String(value);
      if (selCialDisplay) selCialDisplay.value = String(value);
    }

    function setAutosave(msg, isError){
      if (!autosaveEl) return;
      autosaveEl.style.display = msg ? '' : 'none';
      autosaveEl.style.color = isError ? 'rgba(185,28,28,.95)' : 'var(--gv-muted)';
      autosaveEl.textContent = msg || '';
    }

    function getPedidoId(){
      try{
        var path = String(window.location && window.location.pathname ? window.location.pathname : '');
        var m = path.match(/\/pedidos\/(\d+)\/edit/i);
        if (m && m[1]) return parseInt(m[1], 10) || 0;
      } catch(_e){}
      return 0;
    }

    // Importante: NO auto-guardar cabecera en modo edición para que "Cancelar" no modifique datos.

    async function loadDireccionesEnvio(clienteId){
      if (!selDirEnvio) return;
      var cid = parseInt(String(clienteId || '').trim(), 10) || 0;
      selDirEnvio.innerHTML = '<option value="">(por defecto)</option>';
      if (helpDirEnvio) helpDirEnvio.textContent = 'Si el cliente tiene más de una, selecciona una.';
      if (!cid) return;
      try{
        var r = await fetch('/api/clientes/' + encodeURIComponent(String(cid)) + '/direcciones-envio?compact=1', { headers: { Accept: 'application/json' } });
        if (!r.ok) return;
        var json = await r.json().catch(function(){ return null; });
        if (!json || json.ok !== true) return;
        var items = Array.isArray(json.items) ? json.items : [];
        items.forEach(function(d){
          var id = d.id ?? d.Id ?? '';
          if (!id) return;
          // Si viene compactado: {id,label}. Si no, calculamos label.
          var label = d.label ?? d.Label ?? '';
          if (!label) {
            var alias = d.Alias ?? '';
            var dest = d.Nombre_Destinatario ?? '';
            var dir = d.Direccion ?? '';
            var pob = d.Poblacion ?? '';
            var cp = d.CodigoPostal ?? '';
            label = [alias || dest, dir, [cp, pob].filter(Boolean).join(' ')].filter(Boolean).join(' · ');
          }
          var opt = document.createElement('option');
          opt.value = String(id);
          opt.textContent = label || ('Dirección ' + String(id));
          selDirEnvio.appendChild(opt);
        });

        var existing = String(selDirEnvio.getAttribute('data-existing') || '').trim();
        if (existing) {
          selDirEnvio.value = existing;
        } else if (items.length === 1) {
          const onlyId = String(items[0].id ?? items[0].Id ?? '');
          if (onlyId) selDirEnvio.value = onlyId;
        }
        var msgDir = items.length > 1 ? 'Selecciona una dirección de envío.' : (items.length === 1 ? 'Dirección asignada automáticamente.' : 'No hay direcciones de envío.');
        if (helpDirEnvio) helpDirEnvio.textContent = msgDir;
        var infoBtn = document.getElementById('Id_DireccionEnvioInfoBtn');
        if (infoBtn) infoBtn.setAttribute('data-info', msgDir);
      } catch(_e){}
    }

    async function loadClienteAndDefaults(clienteId){
      if (!canEdit) return;
      var id = parseInt(String(clienteId || '').trim(), 10) || 0;
      if (!id) return;
      try {
        var userId = parseInt('<%= Number(user?.id ?? 0) %>', 10) || 0;

        var r = await fetch('/api/clientes/' + encodeURIComponent(String(id)), { headers: { Accept: 'application/json' } });
        if (!r.ok) return;
        var json = await r.json();
        if (!json || json.ok !== true) return;
        var c = json.item || null;
        if (!c) return;
        // Defaults: comercial + tarifa + dto (best-effort)
        var cial = c.Id_Cial ?? c.id_cial ?? c.ComercialId ?? c.comercialId ?? c.Id_Comercial ?? c.id_comercial;
        var tar = c.Id_Tarifa ?? c.id_tarifa ?? c.Tarifa ?? c.tarifa;
        var dto = c.Dto ?? c.dto ?? c.Descuento ?? c.descuento;

        // Regla:
        // - Siempre coger el comercial del cliente.
        // - EXCEPCIÓN (sesión comercial): si el cliente no está asignado o está en pool (Id_Cial=1),
        //   al pasar un pedido se puede asignar (reclamar) al comercial actual.
        var cialNum = parseInt(String(cial || '').trim(), 10) || 0;
        // En modo edición NO reclamamos ni persistimos nada automáticamente (Cancelar debe ser inocuo).
        var canClaim = !isEditMode && !isAdmin && userId > 0 && userId !== 1 && (cialNum <= 0 || cialNum === 1);
        if (canClaim) {
          try {
            await fetch('/api/clientes/' + encodeURIComponent(String(id)), {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
              body: JSON.stringify({ Id_Cial: userId })
            });
            cialNum = userId;
          } catch (_e) {}
        }

        // Requisito: el comercial SIEMPRE se toma del cliente seleccionado (ya con posible claim)
        setCial(cialNum || cial);

        // Tarifa: actualizar al cambiar cliente (sin tocar si el cliente no trae tarifa)
        if (selTarifa && tar !== undefined && tar !== null && String(tar).trim() !== '') selTarifa.value = String(tar);
        if (dto !== undefined && dto !== null && String(dto).trim() !== '') defaultDto = clampPct(Number(String(dto).replace(',', '.')));
        // Rellenar dto en líneas vacías
        table.querySelectorAll('input.gv-line-dto').forEach(function (inp) {
          if (String(inp.value || '').trim() === '') inp.value = String(defaultDto || 0);
        });
        refreshPrecios();
        loadDireccionesEnvio(id);

        // En edición, los cambios de cabecera se aplican solo al pulsar "Guardar".
      } catch (_e) {}
    }

    async function refreshPrecios(){
      var tarifaId = getTarifaId();
      if (!tarifaId) return;
      var articuloIds = [];
      table.querySelectorAll('tbody tr').forEach(function(tr){
        var sel = tr.querySelector('select[name*=\"[Id_Articulo]\"]');
        var pvl = tr.querySelector('input.gv-line-pvl');
        if (!sel || !pvl) return;
        var aid = parseInt(String(sel.value||''),10) || 0;
        if (!aid) return;
        articuloIds.push(aid);
      });
      if (!articuloIds.length) return;
      try{
        var url = '/api/pedidos/precios?tarifaId=' + encodeURIComponent(String(tarifaId)) + '&articuloIds=' + encodeURIComponent(articuloIds.join(','));
        var r = await fetch(url, { headers: { Accept: 'application/json' } });
        if (!r.ok) return;
        var json = await r.json();
        if (!json || json.ok !== true) return;
        var precios = json.precios || {};
        table.querySelectorAll('tbody tr').forEach(function(tr){
          var sel = tr.querySelector('select[name*=\"[Id_Articulo]\"]');
          var pvl = tr.querySelector('input.gv-line-pvl');
          if (!sel || !pvl) return;
          var aid = String(sel.value || '').trim();
          if (!aid) return;
          if (isManual(pvl) && String(pvl.value||'').trim() !== '') return;
          if (precios[aid] !== undefined && precios[aid] !== null) pvl.value = String(precios[aid]);
          else {
            var opt = sel.options && sel.selectedIndex >= 0 ? sel.options[sel.selectedIndex] : null;
            var op = opt ? opt.getAttribute('data-pvl') : '';
            if (op && String(op).trim() !== '') pvl.value = String(op);
          }
        });
      } catch(_e){}
    }

    function fmtNumES(n, d){
      var x = Number(n);
      if (!isFinite(x)) return '';
      var dec = Math.max(0, Math.min(6, Number(d || 0) || 0));
      var sign = x < 0 ? '-' : '';
      var abs = Math.abs(x);
      var factor = Math.pow(10, dec);
      var rounded = Math.round((abs + Number.EPSILON) * factor) / factor;
      var parts = rounded.toFixed(dec).split('.');
      var intPart = String(parts[0] || '0').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      var decPart = dec ? (',' + String(parts[1] || '').padEnd(dec, '0')) : '';
      return sign + intPart + decPart;
    }
    function fmtEurES(n){ var s = fmtNumES(n, 2); return s ? (s + '€') : ''; }

    function getIvaPctForSelect(sel){
      if (!sel) return 0;
      var opt = sel.options && sel.selectedIndex >= 0 ? sel.options[sel.selectedIndex] : null;
      var raw = opt ? opt.getAttribute('data-iva') : '';
      var x = Number(String(raw || '').replace(',', '.'));
      return isFinite(x) ? Math.max(0, Math.min(100, x)) : 0;
    }

    function recalcTotals(){
      var dtoPedido = 0;
      if (dtoPedidoEl) {
        var dp = Number(String(dtoPedidoEl.value || '').replace(',', '.'));
        if (isFinite(dp)) dtoPedido = Math.max(0, Math.min(100, dp));
      }
      var subtotal = 0;
      table.querySelectorAll('tbody tr').forEach(function(tr){
        var sel = tr.querySelector('select[name*=\"[Id_Articulo]\"]');
        var pvlEl = tr.querySelector('input.gv-line-pvl');
        var qtyEl = tr.querySelector('input[name*=\"[Cantidad]\"]');
        var dtoEl = tr.querySelector('input.gv-line-dto');
        var out = tr.querySelector('.gv-line-total');
        if (!out) return;
        var pvl = Number(String(pvlEl && pvlEl.value ? pvlEl.value : '').replace(',', '.'));
        var qty = Number(String(qtyEl && qtyEl.value ? qtyEl.value : '').replace(',', '.'));
        var dto = Number(String(dtoEl && dtoEl.value ? dtoEl.value : '').replace(',', '.'));
        if (!isFinite(pvl)) pvl = 0;
        if (!isFinite(qty)) qty = 0;
        if (!isFinite(dto)) dto = 0;
        dto = Math.max(0, Math.min(100, dto));
        // Total línea = base (sin dto pedido) + IVA; el dto pedido se aplica sobre el Subtotal
        var base = qty * pvl * (1 - dto / 100);
        var ivaPct = getIvaPctForSelect(sel);
        var totalLinea = base + (base * ivaPct / 100);
        totalLinea = Math.round((totalLinea + Number.EPSILON) * 100) / 100;
        if (qty <= 0 || pvl <= 0) out.textContent = '—';
        else out.textContent = fmtEurES(totalLinea);
        if (isFinite(totalLinea)) subtotal += totalLinea;
      });
      subtotal = Math.round((subtotal + Number.EPSILON) * 100) / 100;
      var subCell = document.getElementById('subtotalCell');
      if (subCell) subCell.textContent = subtotal ? fmtEurES(subtotal) : '—';
      var importeDto = subtotal * (dtoPedido / 100);
      importeDto = Math.round((importeDto + Number.EPSILON) * 100) / 100;
      var totalFinal = subtotal - importeDto;
      totalFinal = Math.round((totalFinal + Number.EPSILON) * 100) / 100;
      var dtoAmountCell = document.getElementById('dtoPedidoAmountCell');
      if (dtoAmountCell) dtoAmountCell.textContent = (dtoPedido && importeDto > 0) ? ('−' + fmtEurES(importeDto)) : '—';
      var tg = document.getElementById('totalGeneralCell');
      if (tg) tg.textContent = (subtotal || dtoPedido) ? fmtEurES(totalFinal) : '—';
    }

    function renumber() {
      var rows = table.querySelectorAll('tbody tr');
      rows.forEach(function (tr, idx) {
        tr.querySelectorAll('select[name], input[name]').forEach(function (el) {
          el.name = el.name
            .replace(/lineas\\[\\d+\\]\\[Id_Articulo\\]/, 'lineas[' + idx + '][Id_Articulo]')
            .replace(/lineas\\[\\d+\\]\\[Cantidad\\]/, 'lineas[' + idx + '][Cantidad]')
            .replace(/lineas\\[\\d+\\]\\[Dto\\]/, 'lineas[' + idx + '][Dto]')
            .replace(/lineas\\[\\d+\\]\\[PrecioUnitario\\]/, 'lineas[' + idx + '][PrecioUnitario]');
        });
      });
    }
    table.addEventListener('click', function (e) {
      var t = e.target;
      if (t && t.matches('[data-remove-linea]')) {
        var tr = t.closest('tr');
        if (tr) tr.remove();
        renumber();
      }
    });
    btn.addEventListener('click', function () {
      var tbody = table.querySelector('tbody');
      if (!tbody) return;
      var idx = tbody.querySelectorAll('tr').length;
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td>' +
        '  <select name=\"lineas[' + idx + '][Id_Articulo]\" required>' +
        optionsHTML +
        '  </select>' +
        '</td>' +
        '<td><input class=\"gv-line-pvl\" name=\"lineas[' + idx + '][PrecioUnitario]\" type=\"number\" min=\"0\" step=\"0.01\" value=\"\" placeholder=\"auto\" /></td>' +
        '<td><input name=\"lineas[' + idx + '][Cantidad]\" type=\"number\" min=\"0\" step=\"0.01\" value=\"1\" /></td>' +
        '<td><input class=\"gv-line-dto\" name=\"lineas[' + idx + '][Dto]\" type=\"number\" min=\"0\" max=\"100\" step=\"0.01\" value=\"\" placeholder=\"auto\" /></td>' +
        '<td style=\"text-align:right; font-weight:900;\" class=\"gv-line-total\">—</td>' +
        '<td><button class=\"btn icon gv-btn-trash\" type=\"button\" data-remove-linea title=\"Quitar línea\" aria-label=\"Quitar línea\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" aria-hidden=\"true\"><polyline points=\"3 6 5 6 21 6\"></polyline><path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"></path><line x1=\"10\" y1=\"11\" x2=\"10\" y2=\"17\"></line><line x1=\"14\" y1=\"11\" x2=\"14\" y2=\"17\"></line></svg></button></td>';
      tbody.appendChild(tr);

      // Importante: que NO venga ningún artículo seleccionado por herencia del innerHTML
      var s = tr.querySelector('select');
      if (s) s.value = '';

      var dto = tr.querySelector('input.gv-line-dto');
      if (dto && String(dto.value || '').trim() === '') dto.value = String(defaultDto || 0);

      var pvl = tr.querySelector('input.gv-line-pvl');
      if (pvl) pvl.addEventListener('input', function(){ markManual(pvl); });
      refreshPrecios();
      recalcTotals();
    });

    // Si venimos con un cliente ya guardado (editar), cargar defaults
    if (hidCliente) {
      hidCliente.addEventListener('change', function(){
        loadDireccionesEnvio(hidCliente.value);
        loadClienteAndDefaults(hidCliente.value);
      });
      if (String(hidCliente.value || '').trim()) {
        loadDireccionesEnvio(hidCliente.value);
        loadClienteAndDefaults(hidCliente.value);
      }
    }

    // Admin: permitir cambiar comercial manualmente
    if (selCialDisplay && isAdmin) {
      selCialDisplay.addEventListener('change', function(){
        markManual(selCialDisplay);
        if (hidCial) hidCial.value = String(selCialDisplay.value || '');
      });
    }

    table.addEventListener('change', function(e){
      var t = e.target;
      if (t && t.matches('select[name*=\"[Id_Articulo]\"]')) { refreshPrecios(); recalcTotals(); }
    });

    table.addEventListener('input', function(e){
      var t = e.target;
      if (!t) return;
      if (t.matches('input.gv-line-pvl') || t.matches('input[name*=\"[Cantidad]\"]') || t.matches('input.gv-line-dto')) {
        recalcTotals();
      }
    });
    if (dtoPedidoEl) {
      dtoPedidoEl.addEventListener('input', function(){ recalcTotals(); });
      dtoPedidoEl.addEventListener('change', function(){ recalcTotals(); });
      dtoPedidoEl.addEventListener('blur', function(){ recalcTotals(); });
    }

    // Inicial
    recalcTotals();
  })();
</script>

<%- include('partials/footer') %>

