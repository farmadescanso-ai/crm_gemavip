<%- include('partials/header', { title: mode === 'edit' ? 'Editar contacto (Agenda)' : 'Nuevo contacto (Agenda)' }) %>

<% const formAction = mode === 'edit' ? ('/agenda/' + (item.Id || item.id) + '/edit') : '/agenda/new'; %>
<% const cancelHref = mode === 'edit' ? ('/agenda/' + (item.Id || item.id)) : '/agenda'; %>
<% const pickVal = (name) => { const v = (item && item[name] !== undefined) ? item[name] : ''; return (v === null || v === undefined) ? '' : String(v); }; %>
<% const rolesArr = (typeof roles !== 'undefined' && Array.isArray(roles)) ? roles : []; %>
<% const especArr = (typeof especialidades !== 'undefined' && Array.isArray(especialidades)) ? especialidades : []; %>

<section class="card gv-cliente-form" style="max-width: 980px; margin: 0 auto;">
  <div class="card-hd">
    <h1 class="card-title"><%= mode === 'edit' ? 'Editar contacto (Agenda)' : 'Nuevo contacto (Agenda)' %></h1>
    <p class="card-subtitle">Alta y mantenimiento de personas. Luego podrás asociarlo a uno o varios clientes y definir su rol.</p>
  </div>
  <div class="card-bd">
    <% if (error) { %>
      <div class="gv-alert gv-alert--warn" style="margin-bottom:12px;"><%= error %></div>
    <% } %>

    <div class="gv-form-actions-sticky">
      <div class="gv-form-actions-sticky__inner">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <a class="btn secondary" href="<%= cancelHref %>">Cancelar</a>
          <button class="btn" type="submit" form="gvAgendaForm"><%= mode === 'edit' ? 'Guardar' : 'Crear' %></button>
        </div>
      </div>
    </div>

    <form id="gvAgendaForm" method="post" action="<%= formAction %>" class="gv-form" style="display:grid; gap: 12px;">
      <div class="grid cols-2" style="gap:12px;">
        <label style="display:grid; gap:6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Nombre *</span>
          <input name="Nombre" required value="<%= pickVal('Nombre') %>" maxlength="120" />
        </label>
        <label style="display:grid; gap:6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Apellidos</span>
          <input name="Apellidos" value="<%= pickVal('Apellidos') %>" maxlength="180" />
        </label>

        <label style="display:grid; gap:6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Empresa</span>
          <input name="Empresa" value="<%= pickVal('Empresa') %>" maxlength="180" />
        </label>
        <label style="display:grid; gap:6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Email</span>
          <input name="Email" type="email" value="<%= pickVal('Email') %>" maxlength="255" />
        </label>

        <label style="display:grid; gap:6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Móvil</span>
          <input name="Movil" value="<%= pickVal('Movil') %>" maxlength="20" />
        </label>
        <label style="display:grid; gap:6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Teléfono</span>
          <input name="Telefono" value="<%= pickVal('Telefono') %>" maxlength="20" />
        </label>

        <label style="display:grid; gap:6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Cargo (tipo/rol)</span>
          <select name="Cargo" id="gvCargoSelect">
            <option value="">—</option>
            <% const curCargo = pickVal('Cargo'); %>
            <% rolesArr.forEach((r) => { %>
              <% const v = String(r?.Nombre || '').trim(); if (!v) return; %>
              <option value="<%= v %>" <%= (v && curCargo && v.toLowerCase() === curCargo.toLowerCase()) ? 'selected' : '' %>><%= v %></option>
            <% }) %>
            <option value="__add__">+ Añadir</option>
          </select>
          <input name="CargoNew" id="gvCargoNew" value="" maxlength="120" placeholder="Escribe un nuevo cargo..." style="display:none;" />
        </label>
        <label style="display:grid; gap:6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Especialidad</span>
          <select name="Especialidad" id="gvEspecSelect">
            <option value="">—</option>
            <% const curEsp = pickVal('Especialidad'); %>
            <% especArr.forEach((r) => { %>
              <% const v = String(r?.Nombre || '').trim(); if (!v) return; %>
              <option value="<%= v %>" <%= (v && curEsp && v.toLowerCase() === curEsp.toLowerCase()) ? 'selected' : '' %>><%= v %></option>
            <% }) %>
            <option value="__add__">+ Añadir</option>
          </select>
          <input name="EspecialidadNew" id="gvEspecNew" value="" maxlength="120" placeholder="Escribe una nueva especialidad..." style="display:none;" />
        </label>

        <label style="display:grid; gap:6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Extensión</span>
          <input name="Extension" value="<%= pickVal('Extension') %>" maxlength="10" />
        </label>
        <label style="display:grid; gap:6px;">
          <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Activo</span>
          <select name="Activo">
            <option value="1" <%= pickVal('Activo') === '' || pickVal('Activo') === '1' ? 'selected' : '' %>>Sí</option>
            <option value="0" <%= pickVal('Activo') === '0' ? 'selected' : '' %>>No</option>
          </select>
        </label>
      </div>

      <label style="display:grid; gap:6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Notas</span>
        <textarea name="Notas" rows="4" maxlength="2000"><%= pickVal('Notas') %></textarea>
      </label>
    </form>
  </div>
</section>

<script>
(function () {
  function setup(selectId, inputId, currentVal) {
    var sel = document.getElementById(selectId);
    var inp = document.getElementById(inputId);
    if (!sel || !inp) return;

    function sync() {
      var v = String(sel.value || '');
      var isAdd = (v === '__add__');
      inp.style.display = isAdd ? '' : 'none';
      if (isAdd) {
        inp.required = false;
        inp.focus();
      } else {
        inp.required = false;
        inp.value = '';
      }
    }

    // Si el valor actual no está en el catálogo, dejarlo como "Añadir" y precargar el input.
    var cur = String(currentVal || '').trim();
    if (cur) {
      var opts = Array.prototype.slice.call(sel.querySelectorAll('option')).map(function(o){ return String(o.value || '').trim().toLowerCase(); });
      if (opts.indexOf(cur.toLowerCase()) === -1) {
        sel.value = '__add__';
        inp.value = cur;
      }
    }

    sel.addEventListener('change', sync);
    sync();
  }

  setup('gvCargoSelect', 'gvCargoNew', "<%= pickVal('Cargo').replace(/\"/g, '&quot;') %>");
  setup('gvEspecSelect', 'gvEspecNew', "<%= pickVal('Especialidad').replace(/\"/g, '&quot;') %>");
})();
</script>

<%- include('partials/footer') %>

