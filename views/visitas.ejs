<%- include('partials/header', { title: 'Visitas' }) %>

<% /* fmtDateES y fmtTimeHM vienen de res.locals (helpers globales) */ %>

<section class="card">
  <div class="card-hd">
    <h1 class="card-title">Visitas</h1>
    <p class="card-subtitle">
      Vista lista · <%= items.length %> resultados
      <% const hasPaging = (typeof paging !== 'undefined' && paging && typeof paging.total !== 'undefined'); %>
      <% if (hasPaging) { %>
        · Total <%= paging.total %> · Página <%= paging.page %>
      <% } %>
      <% if (selectedDate) { %> · <span class="badge info"><%= selectedDate %></span><% } %>
    </p>
  </div>
  <div class="card-bd">
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom: 12px;">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <a class="btn secondary" href="/visitas?view=list">Lista</a>
        <a class="btn secondary" href="/visitas?view=calendar">Calendario</a>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="/visitas/new">Nueva visita</a>
      </div>
    </div>

    <form method="get" action="/visitas" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom: 12px;">
      <input type="hidden" name="view" value="list" />
      <input type="hidden" name="limit" value="<%= (hasPaging && paging.limit) ? paging.limit : 10 %>" />
      <input
        type="date"
        name="date"
        value="<%= selectedDate ? selectedDate : '' %>"
        style="min-width: 170px;"
      />
      <input
        type="number"
        name="id"
        min="1"
        placeholder="ID visita"
        value="<%= (typeof id !== 'undefined' && id) ? id : '' %>"
        style="min-width: 140px;"
      />
      <button class="btn secondary" type="submit">Filtrar</button>
      <a class="btn secondary" href="/visitas?view=list">Limpiar</a>
    </form>

    <% if (hasPaging && paging.total && paging.total > paging.limit) { %>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 12px;">
        <% const prev = paging.page > 1 ? paging.page - 1 : null; %>
        <% const next = (paging.page * paging.limit) < paging.total ? paging.page + 1 : null; %>
        <% const base = `/visitas?view=list&limit=${paging.limit}` + (selectedDate ? `&date=${encodeURIComponent(selectedDate)}` : '') + ((typeof id !== 'undefined' && id) ? `&id=${encodeURIComponent(id)}` : ''); %>
        <% if (prev) { %>
          <a class="btn secondary" href="<%= base %>&page=<%= prev %>">Anterior</a>
        <% } %>
        <% if (next) { %>
          <a class="btn secondary" href="<%= base %>&page=<%= next %>">Siguiente</a>
        <% } %>
      </div>
    <% } %>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Acciones</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Hora fin</th>
            <th>Tipo</th>
            <th>Cliente</th>
            <% if (admin) { %><th>Comercial</th><% } %>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <% items.forEach((v) => { %>
            <% const vid = v.Id ?? v.vis_id ?? v.id; %>
            <tr>
              <td>
                <div class="gv-actions">
                  <a class="btn secondary icon" href="/visitas/<%= vid %>" title="Ver" aria-label="Ver visita <%= vid %>">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </a>
                  <a class="btn secondary icon" href="/visitas/<%= vid %>/edit" title="Editar" aria-label="Editar visita <%= vid %>">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M12 20h9"></path>
                      <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                    </svg>
                  </a>
                  <form method="post" action="/visitas/<%= vid %>/delete" onsubmit="return confirm('¿Eliminar esta visita?');">
                    <button class="btn secondary icon danger" type="submit" title="Borrar" aria-label="Borrar visita <%= v.Id %>">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M3 6h18"></path>
                        <path d="M8 6V4h8v2"></path>
                        <path d="M19 6l-1 14H6L5 6"></path>
                        <path d="M10 11v6"></path>
                        <path d="M14 11v6"></path>
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
              <td><%= fmtDateES(v.Fecha ?? v.vis_fecha ?? '') %></td>
              <td><%= fmtTimeHM(v.Hora ?? v.vis_hora ?? '') %></td>
              <td><%= fmtTimeHM(v.HoraFinal ?? v.vis_hora_final ?? v.Hora_Final ?? '') %></td>
              <td><%= v.TipoVisita ?? v.vis_tipo ?? '' %></td>
              <td><%= (v.ClienteRazonSocial || v.ClienteNombre || v.cli_nombre_razon_social) ? (v.ClienteRazonSocial || v.ClienteNombre || v.cli_nombre_razon_social) : (v.ClienteId ?? v.vis_cli_id ?? '') %></td>
              <% if (admin) { %>
                <td><%= v.ComercialNombre ?? v.com_nombre ?? (v.ComercialId ?? v.vis_com_id ?? '') %></td>
              <% } %>
              <td><%= v.Estado ?? v.vis_estado ?? '' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<%- include('partials/footer') %>

