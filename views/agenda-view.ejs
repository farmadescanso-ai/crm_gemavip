<%- include('partials/header', { title: 'Agenda' }) %>

<% const id = (item && (item.Id ?? item.id)) ? (item.Id ?? item.id) : ''; %>
<% const nombre = [item?.Nombre, item?.Apellidos].filter(Boolean).join(' ').trim(); %>
<% const activo = String(item?.Activo ?? '1').trim() === '1'; %>

<section class="card gv-cliente-form" style="max-width: 1080px; margin: 0 auto;">
  <div class="card-hd">
    <h1 class="card-title">Agenda #<%= id %></h1>
    <p class="card-subtitle"><%= nombre || ('Contacto ' + id) %></p>
  </div>

  <div class="card-bd">
    <% if (success) { %>
      <div class="gv-alert gv-alert--success" style="margin-bottom:12px;"><%= success %></div>
    <% } %>
    <% if (error) { %>
      <div class="gv-alert gv-alert--warn" style="margin-bottom:12px;"><%= error %></div>
    <% } %>

    <div class="gv-form-actions-sticky">
      <div class="gv-form-actions-sticky__inner">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <a class="btn secondary" href="/agenda">Volver</a>
          <a class="btn" href="/agenda/<%= id %>/edit">Editar</a>
        </div>
        <div style="color: var(--gv-muted); font-weight:800;">
          Activo: <%= activo ? 'Sí' : 'No' %>
        </div>
      </div>
    </div>

    <div class="grid cols-2" style="gap: 12px; margin-top: 10px;">
      <div style="display:grid; gap: 6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Empresa</span>
        <div class="gv-readonly"><%= item?.Empresa ?? '—' %></div>
      </div>
      <div style="display:grid; gap: 6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Cargo</span>
        <div class="gv-readonly"><%= item?.Cargo ?? '—' %></div>
      </div>
      <div style="display:grid; gap: 6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Especialidad</span>
        <div class="gv-readonly"><%= item?.Especialidad ?? '—' %></div>
      </div>
      <div style="display:grid; gap: 6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Email</span>
        <div class="gv-readonly"><%= item?.Email ?? '—' %></div>
      </div>
      <div style="display:grid; gap: 6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Móvil</span>
        <div class="gv-readonly"><%= item?.Movil ?? '—' %></div>
      </div>
      <div style="display:grid; gap: 6px;">
        <span style="font-weight:800; color: var(--gv-ink); font-size: 13px;">Teléfono</span>
        <div class="gv-readonly"><%= item?.Telefono ?? '—' %></div>
      </div>
    </div>

    <div style="margin-top: 14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <h2 style="margin:0; font-size: 1.1rem;">Clientes asociados</h2>
        <form method="post" action="/agenda/<%= id %>/clientes/link" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input type="hidden" name="contactoId" value="<%= id %>" />
          <input type="hidden" name="clienteId" id="gvClienteId" value="" />
          <input type="search" id="gvClienteSearch" placeholder="Buscar cliente..." style="min-width:260px;" />
          <select name="TipoRelacion" id="gvTipoRelacion" style="min-width:170px;">
            <option value="">Tipo (auto)</option>
            <option value="Farmacia">Farmacia</option>
            <option value="Clínica">Clínica</option>
            <option value="Persona">Persona</option>
            <option value="Empresa">Empresa</option>
          </select>
          <%
            const roleNames = (roles || []).map(r => String(r?.Nombre || '').trim()).filter(Boolean);
            const examples = roleNames.slice(0, 3).join(', ');
            const rolePlaceholder = examples
              ? `Rol (ej: ${examples}) · Tipo (Farmacia/Clínica/Persona)`
              : 'Rol (ej: Director, Compras, Administración) · Tipo (Farmacia/Clínica/Persona)';
          %>
          <input name="Rol" list="gvRoles" placeholder="<%= rolePlaceholder %>" style="min-width:320px;" />
          <datalist id="gvRoles">
            <% (roles || []).forEach((r) => { %>
              <option value="<%= r.Nombre %>"></option>
            <% }) %>
          </datalist>
          <label style="display:flex; align-items:center; gap:6px; font-weight:800; color: var(--gv-muted);">
            <input type="checkbox" name="Es_Principal" value="1" />
            Principal
          </label>
          <button class="btn secondary" type="submit">Asociar</button>
        </form>
      </div>

      <div class="table-wrap" style="margin-top: 10px;">
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Rol</th>
              <th>Principal</th>
              <th>Vigente</th>
              <th style="width: 1%;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% if (!clientes || clientes.length === 0) { %>
              <tr><td colspan="5" style="color: var(--gv-muted); font-weight:800;">Sin clientes asociados.</td></tr>
            <% } else { %>
              <% clientes.forEach((c) => { %>
                <%
                  const cid = c?.Id ?? c?.id ?? c?.Id_Cliente ?? '';
                  const rs = c?.Nombre_Razon_Social ?? c?.Nombre ?? ('Cliente ' + cid);
                  const vigente = !c?.VigenteHasta;
                %>
                <tr>
                  <td><a href="/clientes/<%= cid %>"><%= rs %></a></td>
                  <td><%= c?.Rol ?? '' %></td>
                  <td><%= String(c?.Es_Principal ?? 0) === '1' ? 'Sí' : '—' %></td>
                  <td><%= vigente ? 'Sí' : 'No' %></td>
                  <td>
                    <% if (vigente) { %>
                      <form method="post" action="/agenda/<%= id %>/clientes/<%= cid %>/unlink" style="margin:0;" onsubmit="return confirm('¿Quitar asociación con este cliente?');">
                        <button class="btn secondary" type="submit">Quitar</button>
                      </form>
                    <% } else { %>
                      <span style="color: var(--gv-muted); font-weight:800;">—</span>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<script>
(function () {
  var search = document.getElementById('gvClienteSearch');
  var hidden = document.getElementById('gvClienteId');
  var tipoSel = document.getElementById('gvTipoRelacion');
  if (!search || !hidden) return;

  var box = document.createElement('div');
  box.style.position = 'relative';
  search.parentNode.insertBefore(box, search);
  box.appendChild(search);

  var list = document.createElement('div');
  list.style.position = 'absolute';
  list.style.top = '100%';
  list.style.left = '0';
  list.style.right = '0';
  list.style.zIndex = '20';
  list.style.background = '#fff';
  list.style.border = '1px solid rgba(0,0,0,.12)';
  list.style.borderRadius = '10px';
  list.style.boxShadow = '0 8px 18px rgba(0,0,0,.10)';
  list.style.marginTop = '6px';
  list.style.overflow = 'hidden';
  list.style.display = 'none';
  box.appendChild(list);

  function hide() {
    list.style.display = 'none';
    list.innerHTML = '';
  }

  function escapeHtml(s) {
    return String(s || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  var t = null;
  var lastQuery = '';
  var open = false;

  function showMessage(msg) {
    list.innerHTML =
      '<div style="padding:10px 12px; color:var(--gv-muted); font-weight:800; font-size:12px;">'
      + escapeHtml(msg)
      + '</div>';
    list.style.display = 'block';
    open = true;
  }

  function shouldQuery(q) {
    var qq = String(q || '').trim();
    if (!qq) return { ok: false, reason: '' };
    var digits = /^[0-9]+$/.test(qq);
    var email = qq.indexOf('@') !== -1;
    var spaces = /\s/.test(qq);
    if (digits) return { ok: true };
    if (email || spaces) return qq.length >= 2 ? { ok: true } : { ok: false, reason: 'Escribe al menos 2 caracteres.' };
    return qq.length >= 2 ? { ok: true } : { ok: false, reason: 'Escribe al menos 2 caracteres.' };
  }

  function inferTipoFromItem(it) {
    var tipoContacto = String(it?.TipoContacto || '').trim().toLowerCase();
    var tipoCliente = String(it?.TipoClienteNombre || '').trim().toLowerCase();
    if (tipoContacto === 'persona' || tipoCliente.includes('persona')) return 'Persona';
    if (tipoCliente.includes('farmacia')) return 'Farmacia';
    if (tipoCliente.includes('clínica') || tipoCliente.includes('clinica')) return 'Clínica';
    return 'Empresa';
  }

  async function run() {
    var q = String(search.value || '').trim();
    hidden.value = '';
    var chk = shouldQuery(q);
    if (!chk.ok) {
      if (!q) { hide(); open = false; return; }
      showMessage(chk.reason || 'Escribe más para buscar.');
      return;
    }
    try {
      lastQuery = q;
      // scope=all para agenda (si hay sesión). force=1 para permitir 2 caracteres.
      var tipo = tipoSel ? String(tipoSel.value || '').trim() : '';
      var url = '/api/clientes/suggest?q=' + encodeURIComponent(q) + '&limit=12&scope=all&force=1'
        + (tipo ? ('&tipo=' + encodeURIComponent(tipo)) : '');
      var r = await fetch(url, { headers: { Accept: 'application/json' } });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var json = await r.json();
      var items = (json && json.ok && Array.isArray(json.items)) ? json.items : [];
      if (!items.length) { showMessage('Sin resultados. Prueba con otro texto.'); return; }
      list.innerHTML = items.map(function (it) {
        var id = it.id || it.Id || '';
        var rs = it.Nombre_Razon_Social || it.Nombre || it.label || ('Cliente ' + id);
        var cial = it.Nombre_Cial || '';
        var dni = it.DNI_CIF || '';
        var tipo = it.TipoClienteNombre || '';
        var tipoContacto = it.TipoContacto || '';
        var pob = it.Poblacion || '';
        var prov = it.ProvinciaNombre || '';
        var cp = it.CodigoPostal || '';

        var title = [String(id || '').trim(), String(rs || '').trim()].filter(Boolean).join(' · ');
        var meta1 = [dni, tipo, tipoContacto].filter(Boolean).join(' · ');
        var meta2 = [[cp, pob].filter(Boolean).join(' '), prov, cial].filter(Boolean).join(' · ');
        var label = title;
        var dataLabel = title;

        return (
          '<button type="button" data-id="' + escapeHtml(id) + '" data-label="' + escapeHtml(dataLabel) + '"'
          + ' data-tipo="' + escapeHtml(inferTipoFromItem(it)) + '"'
          + ' style="display:block; width:100%; text-align:left; padding:10px 12px; border:0; background:#fff; cursor:pointer;">'
          +   '<div style="font-weight:900; color:var(--gv-ink);">' + escapeHtml(title) + '</div>'
          +   (meta1 ? ('<div style="margin-top:4px; color:var(--gv-muted); font-weight:800; font-size:12px;">' + escapeHtml(meta1) + '</div>') : '')
          +   (meta2 ? ('<div style="margin-top:2px; color:var(--gv-muted); font-weight:700; font-size:12px;">' + escapeHtml(meta2) + '</div>') : '')
          + '</button>'
        );
      }).join('');
      list.style.display = 'block';
      open = true;
    } catch (_e) {
      showMessage('No se pudo buscar. Inténtalo de nuevo.');
    }
  }

  search.addEventListener('input', function () {
    if (t) window.clearTimeout(t);
    t = window.setTimeout(run, 250);
  });

  if (tipoSel) {
    tipoSel.addEventListener('change', function () {
      // Re-lanzar búsqueda con filtro tipo (si hay texto)
      if (t) window.clearTimeout(t);
      t = window.setTimeout(run, 50);
    });
  }

  list.addEventListener('click', function (e) {
    var btn = e.target && e.target.closest ? e.target.closest('button[data-id]') : null;
    if (!btn) return;
    hidden.value = btn.getAttribute('data-id') || '';
    search.value = btn.getAttribute('data-label') || '';
    if (tipoSel) {
      var inferred = btn.getAttribute('data-tipo') || '';
      if (inferred && !String(tipoSel.value || '').trim()) tipoSel.value = inferred;
    }
    hide();
    open = false;
  });

  document.addEventListener('click', function (e) {
    if (!box.contains(e.target)) hide();
    if (!box.contains(e.target)) open = false;
  });
})();
</script>

<%- include('partials/footer') %>

