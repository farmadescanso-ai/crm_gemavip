<%- include('partials/header', { title: 'Artículos' }) %>

<% if (typeof loadError === 'string' && loadError) { %>
  <div class="card" style="border-color: var(--gv-danger, #c00); margin-bottom: 1rem;">
    <p style="color: var(--gv-danger, #c00); font-weight: 700;">Error al cargar artículos: <%= loadError %></p>
  </div>
<% } %>
<section class="card">
  <div class="card-hd">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap: 12px; flex-wrap:wrap;">
      <div>
        <h1 class="card-title">Artículos</h1>
        <p class="card-subtitle">
          <% if (typeof total === 'number' && total > 0) { %>
            <% const from = (page - 1) * limit + 1; %>
            <% const to = Math.min(page * limit, total); %>
            Mostrando <%= from %>-<%= to %> de <%= total %> artículos
          <% } else { %>
            <%= typeof total === 'number' ? total : (items || []).length %> artículos
          <% } %>
        </p>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <form method="get" action="/articulos" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:0;">
          <input type="hidden" name="page" value="1" />
          <label for="marca" style="font-weight:700; color: var(--gv-ink);">Marca</label>
          <select id="marca" name="marca" class="gv-client-picker__q" style="width:auto; min-width: 220px;">
            <option value="" <%= !selectedMarcaId ? 'selected' : '' %>>Todas</option>
            <% (marcas || []).forEach((m) => { %>
              <option value="<%= m.id ?? m.mar_id %>" <%= Number(selectedMarcaId) === Number(m.id ?? m.mar_id) ? 'selected' : '' %>><%= m.nombre ?? m.mar_nombre ?? m.id ?? m.mar_id %></option>
            <% }) %>
          </select>
          <button class="btn secondary" type="submit">Filtrar</button>
          <a class="btn secondary" href="/articulos">Todas</a>
        </form>
        <% if (admin) { %>
          <a class="btn secondary" href="/articulos/new">Nuevo artículo</a>
        <% } %>
      </div>
    </div>
  </div>
  <div class="card-bd">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>SKU</th>
            <th>Nombre</th>
            <th>Marca</th>
            <th>PVL</th>
            <th>IVA</th>
            <th>Activo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% (items || []).forEach((a) => { %>
            <tr>
              <td><%= a.Id ?? a.id ?? a.art_id %></td>
              <td><%= a.SKU ?? a.art_sku ?? '' %></td>
              <td><%= a.Nombre ?? a.art_nombre ?? '' %></td>
              <td><%= a.MarcaNombre ?? a.Marca ?? a.Id_Marca ?? a.art_mar_id ?? '' %></td>
              <td><%= a.PVL ?? a.art_pvl ?? '' %></td>
              <td><%= a.IVA ?? a.art_iva ?? '' %></td>
              <td><%= (a.Activo ?? a.art_activo ?? 1) ? 'Sí' : 'No' %></td>
              <td>
                <div class="gv-actions">
                  <a class="btn secondary icon" href="/articulos/<%= a.Id ?? a.id ?? a.art_id %>" title="Ver ficha" aria-label="Ver ficha">
                    Ver
                  </a>
                  <% if (admin) { %>
                    <a class="btn secondary icon" href="/articulos/<%= a.Id ?? a.id ?? a.art_id %>/edit" title="Editar" aria-label="Editar">
                      Editar
                    </a>
                    <form method="post" action="/articulos/<%= a.Id ?? a.id ?? a.art_id %>/delete" onsubmit="return confirm('¿Eliminar este artículo?');">
                      <button class="btn secondary icon danger" type="submit" title="Eliminar" aria-label="Eliminar">Eliminar</button>
                    </form>
                  <% } %>
                </div>
              </td>
            </tr>
          <% }) %>
          <% if (!items || items.length === 0) { %>
            <tr>
              <td colspan="8" style="color: var(--gv-muted); font-weight:700;">No hay artículos.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
    <% if (totalPages > 1) { %>
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-top:1rem; padding-top:1rem; border-top:1px solid var(--gv-border, #ddd);">
        <span style="color: var(--gv-muted);">Página <%= page %> de <%= totalPages %></span>
        <div style="display:flex; gap:8px;">
          <% const qs = selectedMarcaId ? `marca=${selectedMarcaId}` : ''; %>
          <% if (page > 1) { %>
            <a class="btn secondary" href="/articulos?page=<%= page - 1 %><%= qs ? '&' + qs : '' %>">← Anterior</a>
          <% } %>
          <% if (page < totalPages) { %>
            <a class="btn secondary" href="/articulos?page=<%= page + 1 %><%= qs ? '&' + qs : '' %>">Siguiente →</a>
          <% } %>
        </div>
      </div>
    <% } %>
  </div>
</section>

<%- include('partials/footer') %>

